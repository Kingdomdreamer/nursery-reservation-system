# ãƒ—ãƒªã‚»ãƒƒãƒˆå•†å“è¨­å®šå•é¡Œ å›é¿è¨­è¨ˆæ›¸

## ğŸ“‹ äº‹è±¡æ¦‚è¦

### ç¾åœ¨ç™ºç”Ÿã—ã¦ã„ã‚‹å•é¡Œ
1. **ãƒ—ãƒªã‚»ãƒƒãƒˆå•†å“ã®è¨­å®šãŒåæ˜ ã•ã‚Œãªã„**
   - ç®¡ç†ç”»é¢ã§ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã€å•†å“ä¸€è¦§ã‹ã‚‰è©²å½“ãƒ—ãƒªã‚»ãƒƒãƒˆã«ç´ã¥ãå•†å“ã‚’é¸æŠãƒ»ä¿å­˜
   - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã«é·ç§»ã™ã‚‹ã¨ã€ã€Œå•†å“é¸æŠã€æ¬„ã«é¸æŠæ¸ˆã¿ã®å•†å“ãŒä¸€åˆ‡è¡¨ç¤ºã•ã‚Œãªã„
   - å¸¸ã«ã€Œç¾åœ¨é¸æŠã§ãã¾ã›ã‚“ã€ã¨ã ã‘è¡¨ç¤ºã•ã‚Œã‚‹

2. **API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã® 404 ã‚¨ãƒ©ãƒ¼**
   - ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ãƒ–ã§ç¢ºèªã™ã‚‹ã¨ã€`GET /api/admin/preset-products/{presetId}` ãŒæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒã§ 404 ã«ãªã‚‹
   - ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯åŒã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæ­£å¸¸ã« 200 ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
   - ãƒ‡ãƒ—ãƒ­ã‚¤å´ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚„è¨­å®šã«å•é¡Œã®å¯èƒ½æ€§

3. **React ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ï¼ˆMinified React error #418ï¼‰**
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ç¹°ã‚Šè¿”ã—ã‚¨ãƒ©ãƒ¼ãŒå‡ºåŠ›ã•ã‚Œã‚‹
   - JSXã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç›´æ¥ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã“ã¨ãŒåŸå› 

## ğŸ¯ è¨­è¨ˆæ–¹é‡

### åŸºæœ¬åŸå‰‡
1. **ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•è¨­è¨ˆ**: ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚æœ€ä½é™ã®æ©Ÿèƒ½ã‚’æä¾›
2. **æ®µéšçš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿å–å¾—çµŒè·¯ã‚’ç”¨æ„
3. **å‹å®‰å…¨æ€§ã®å¾¹åº•**: TypeScriptã«ã‚ˆã‚‹å³å¯†ãªå‹ãƒã‚§ãƒƒã‚¯
4. **ãƒ‡ãƒãƒƒã‚°å¯èƒ½æ€§**: å•é¡Œç‰¹å®šã®ãŸã‚ã®è©³ç´°ãƒ­ã‚°

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ–¹é‡
- **API First**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯å¿…ãšAPIçµŒç”±ã§ãƒ‡ãƒ¼ã‚¿å–å¾—
- **ã‚¨ãƒ©ãƒ¼å¢ƒç•Œ**: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- **çŠ¶æ…‹ç®¡ç†**: æ˜ç¢ºãªçŠ¶æ…‹é·ç§»ã¨ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®ç®¡ç†

## ğŸ”§ æŠ€è¡“çš„è§£æ±ºç­–

### 1. API ãƒ«ãƒ¼ãƒˆä¿®æ­£ï¼ˆæœ€å„ªå…ˆï¼‰

#### å•é¡Œã®æ ¹æœ¬åŸå› 
- Next.js 15ã§ã®å‹•çš„ãƒ«ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å‡¦ç†æ–¹æ³•å¤‰æ›´
- `context.params` ã®éåŒæœŸå‡¦ç†ãŒä¸é©åˆ‡

#### ä¿®æ­£å†…å®¹
```typescript
// src/app/api/admin/preset-products/[presetId]/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { supabaseAdmin } from '@/lib/supabase';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ presetId: string }> }
) {
  try {
    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å®‰å…¨ãªå–å¾—
    const { presetId } = await params;
    const id = Number(presetId);
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (Number.isNaN(id) || id < 1) {
      console.error(`Invalid presetId: ${presetId}`);
      return NextResponse.json(
        { 
          error: 'ç„¡åŠ¹ãªãƒ—ãƒªã‚»ãƒƒãƒˆIDã§ã™',
          code: 'INVALID_PRESET_ID',
          presetId 
        },
        { status: 400 }
      );
    }

    // Supabaseæ¥ç¶šç¢ºèª
    if (!supabaseAdmin) {
      console.error('Supabase admin client not available');
      return NextResponse.json(
        { 
          error: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼',
          code: 'DB_CONNECTION_ERROR' 
        },
        { status: 500 }
      );
    }

    console.log(`Fetching preset products for presetId: ${id}`);

    // ãƒ—ãƒªã‚»ãƒƒãƒˆå•†å“ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
    const { data: presetProducts, error: dbError } = await supabaseAdmin
      .from('preset_products')
      .select(`
        product_id,
        display_order,
        is_active,
        product:products(
          id,
          name,
          price,
          category_id,
          visible,
          created_at,
          updated_at
        )
      `)
      .eq('preset_id', id)
      .eq('is_active', true)
      .order('display_order');

    if (dbError) {
      console.error('Database query error:', dbError);
      return NextResponse.json(
        { 
          error: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã‚¨ãƒ©ãƒ¼',
          code: 'DB_QUERY_ERROR',
          details: dbError.message 
        },
        { status: 500 }
      );
    }

    // ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢ã¨æ¤œè¨¼
    const validProducts = (presetProducts || [])
      .filter(pp => {
        // å•†å“ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ç¢ºèª
        if (!pp.product) {
          console.warn(`Product not found for product_id: ${pp.product_id}`);
          return false;
        }
        
        // å•†å“ã®å¯è¦–æ€§ç¢ºèª
        if (!pp.product.visible) {
          console.warn(`Product not visible: ${pp.product.id}`);
          return false;
        }
        
        return true;
      })
      .map(pp => ({
        ...pp.product,
        display_order: pp.display_order,
        preset_product_id: pp.product_id
      }))
      .sort((a, b) => (a.display_order || 999) - (b.display_order || 999));

    console.log(`Found ${validProducts.length} valid products for preset ${id}`);

    return NextResponse.json({
      success: true,
      data: validProducts,
      meta: {
        presetId: id,
        totalCount: validProducts.length,
        timestamp: new Date().toISOString()
      }
    });

  } catch (error) {
    console.error('Unexpected error in preset-products API:', error);
    return NextResponse.json(
      { 
        error: 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
        code: 'UNEXPECTED_ERROR',
        details: error instanceof Error ? error.message : 'Unknown error'
      },
      { status: 500 }
    );
  }
}

export async function PUT(
  request: NextRequest,
  { params }: { params: Promise<{ presetId: string }> }
) {
  try {
    const { presetId } = await params;
    const id = Number(presetId);
    
    if (Number.isNaN(id) || id < 1) {
      return NextResponse.json(
        { error: 'ç„¡åŠ¹ãªãƒ—ãƒªã‚»ãƒƒãƒˆIDã§ã™' },
        { status: 400 }
      );
    }

    if (!supabaseAdmin) {
      return NextResponse.json(
        { error: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼' },
        { status: 500 }
      );
    }

    const updates = await request.json();
    
    // ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
    if (!Array.isArray(updates)) {
      return NextResponse.json(
        { error: 'æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' },
        { status: 400 }
      );
    }

    // æ›´æ–°å‡¦ç†
    const { error: updateError } = await supabaseAdmin
      .from('preset_products')
      .upsert(
        updates.map((update: any) => ({
          preset_id: id,
          ...update
        }))
      );

    if (updateError) {
      console.error('Update error:', updateError);
      return NextResponse.json(
        { error: 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', details: updateError.message },
        { status: 500 }
      );
    }

    return NextResponse.json({
      success: true,
      message: 'æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ'
    });

  } catch (error) {
    console.error('PUT error:', error);
    return NextResponse.json(
      { error: 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

### 2. React Error #418 å¯¾ç­–

#### å®‰å…¨ãªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°ã®å®Ÿè£…
```typescript
// src/lib/utils/safeRender.ts

/**
 * React Error #418 å¯¾ç­–ç”¨ã®å®‰å…¨ãªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°ç¾¤
 */

export const safeRender = (value: unknown): string => {
  if (value === null || value === undefined) return '';
  if (typeof value === 'string') return value;
  if (typeof value === 'number') return String(value);
  if (typeof value === 'boolean') return value ? 'true' : 'false';
  
  // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯å®‰å…¨ã«æ–‡å­—åˆ—åŒ–
  if (typeof value === 'object') {
    try {
      // å¾ªç’°å‚ç…§å¯¾ç­–
      return JSON.stringify(value, null, 2);
    } catch (error) {
      console.warn('Failed to stringify object:', error);
      return '[Object]';
    }
  }
  
  return String(value);
};

export const safeProductName = (product: unknown): string => {
  if (!product || typeof product !== 'object') {
    console.warn('Invalid product data:', product);
    return 'å•†å“åä¸æ˜';
  }
  
  const productObj = product as Record<string, unknown>;
  
  if (typeof productObj.name === 'string' && productObj.name.trim()) {
    return productObj.name.trim();
  }
  
  if (typeof productObj.product_name === 'string' && productObj.product_name.trim()) {
    return productObj.product_name.trim();
  }
  
  console.warn('Product name not found in:', productObj);
  return 'å•†å“åä¸æ˜';
};

export const safePrice = (price: unknown): string => {
  if (typeof price === 'number' && !isNaN(price) && price >= 0) {
    return `Â¥${price.toLocaleString()}`;
  }
  
  if (typeof price === 'string') {
    const numPrice = parseFloat(price);
    if (!isNaN(numPrice) && numPrice >= 0) {
      return `Â¥${numPrice.toLocaleString()}`;
    }
  }
  
  console.warn('Invalid price data:', price);
  return 'ä¾¡æ ¼ä¸æ˜';
};

export const safeQuantity = (quantity: unknown): number => {
  if (typeof quantity === 'number' && !isNaN(quantity) && quantity >= 0) {
    return Math.floor(quantity);
  }
  
  if (typeof quantity === 'string') {
    const numQuantity = parseInt(quantity, 10);
    if (!isNaN(numQuantity) && numQuantity >= 0) {
      return numQuantity;
    }
  }
  
  console.warn('Invalid quantity data:', quantity);
  return 0;
};

// å‹ã‚¬ãƒ¼ãƒ‰é–¢æ•°
export const isValidProduct = (product: unknown): product is {
  id: number;
  name: string;
  price: number;
} => {
  return (
    typeof product === 'object' &&
    product !== null &&
    typeof (product as any).id === 'number' &&
    typeof (product as any).name === 'string' &&
    typeof (product as any).price === 'number'
  );
};
```

### 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¿®æ­£

#### ProductSelectionSection ã®å®Œå…¨ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
```typescript
// src/components/features/reservation/ProductSelectionSection.tsx

import React, { useMemo, useCallback, useState, useEffect } from 'react';
import { useFormContext } from 'react-hook-form';
import { Button } from '@/components/ui';
import type { Product, PickupWindow, FormSettings } from '@/types';
import type { ReservationFormData, ProductSelectionData } from '@/lib/validations/reservationSchema';
import { getCategoryName } from '@/lib/utils';
import { 
  safeRender, 
  safeProductName, 
  safePrice, 
  safeQuantity,
  isValidProduct 
} from '@/lib/utils/safeRender';

export interface ProductSelectionSectionProps {
  products: Product[];
  pickupWindows: PickupWindow[];
  formSettings: FormSettings;
  className?: string;
}

// ã‚¨ãƒ©ãƒ¼å¢ƒç•Œã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
class ProductSelectionErrorBoundary extends React.Component<
  { children: React.ReactNode },
  { hasError: boolean; error?: Error }
> {
  constructor(props: { children: React.ReactNode }) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error) {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('ProductSelection Error Boundary caught an error:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="bg-red-50 border border-red-200 rounded-lg p-4">
          <h3 className="text-red-800 font-medium mb-2">å•†å“é¸æŠã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
          <p className="text-red-700 text-sm mb-3">
            {this.state.error?.message || 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'}
          </p>
          <button
            onClick={() => {
              this.setState({ hasError: false, error: undefined });
              window.location.reload();
            }}
            className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
          >
            ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
          </button>
        </div>
      );
    }

    return this.props.children;
  }
}

export const ProductSelectionSection = React.memo<ProductSelectionSectionProps>(({
  products,
  pickupWindows,
  formSettings,
  className,
}) => {
  const { setValue, watch, formState: { errors } } = useFormContext<ReservationFormData>();
  
  const selectedProducts = watch('products') || [];
  const [isClient, setIsClient] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [debugInfo, setDebugInfo] = useState<any>(null);

  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
  useEffect(() => {
    setIsClient(true);
    
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¨­å®š
    setDebugInfo({
      productsType: typeof products,
      productsIsArray: Array.isArray(products),
      productsLength: products?.length || 0,
      formSettingsExists: !!formSettings,
      timestamp: new Date().toISOString()
    });
  }, [products, formSettings]);

  // å•†å“ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªå‡¦ç†
  const safeProducts = useMemo(() => {
    if (!isClient) {
      console.log('[ProductSelection] Client not ready');
      return [];
    }
    
    console.log('[ProductSelection] Processing products:', {
      type: typeof products,
      isArray: Array.isArray(products),
      length: products?.length || 0,
      data: products
    });
    
    if (!products) {
      setError('å•†å“ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ç®¡ç†ç”»é¢ã§ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      return [];
    }
    
    if (!Array.isArray(products)) {
      setError(`å•†å“ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚æœŸå¾…å€¤: é…åˆ—, å®Ÿéš›: ${typeof products}`);
      return [];
    }
    
    if (products.length === 0) {
      setError('ã“ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã«ã¯å•†å“ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†ç”»é¢ã§å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
      return [];
    }
    
    // å•†å“ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const validProducts = products.filter((product, index) => {
      if (!isValidProduct(product)) {
        console.warn(`[ProductSelection] Invalid product at index ${index}:`, product);
        return false;
      }
      return true;
    });
    
    if (validProducts.length === 0) {
      setError('æœ‰åŠ¹ãªå•†å“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å•†å“ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      return [];
    }
    
    console.log(`[ProductSelection] Processed ${validProducts.length} valid products`);
    setError(null);
    return validProducts;
  }, [products, isClient]);

  // å•†å“ã®ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  const groupedProducts = useMemo(() => {
    return safeProducts.reduce((groups, product) => {
      const categoryId = product.category_id || 0;
      if (!groups[categoryId]) {
        groups[categoryId] = [];
      }
      groups[categoryId].push(product);
      return groups;
    }, {} as Record<number, Product[]>);
  }, [safeProducts]);

  // åˆè¨ˆé‡‘é¡ã®è¨ˆç®—
  const totalAmount = useMemo(() => {
    return selectedProducts.reduce((sum, product) => {
      const quantity = safeQuantity(product.quantity);
      const price = typeof product.unit_price === 'number' ? product.unit_price : 0;
      return sum + (quantity * price);
    }, 0);
  }, [selectedProducts]);

  // å•†å“ã®é¸æŠæ•°é‡å–å¾—
  const getProductQuantity = useCallback((productId: number): number => {
    const product = selectedProducts.find(p => p.product_id === productId);
    return safeQuantity(product?.quantity);
  }, [selectedProducts]);

  // æ•°é‡å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleQuantityChange = useCallback((productId: number, quantity: number) => {
    try {
      const product = safeProducts.find(p => p.id === productId);
      if (!product) {
        console.error(`Product not found: ${productId}`);
        return;
      }

      const safeQty = Math.max(0, Math.min(99, Math.floor(quantity)));
      const existingIndex = selectedProducts.findIndex(p => p.product_id === productId);
      const newSelectedProducts = [...selectedProducts];

      if (safeQty === 0) {
        // å•†å“ã‚’å‰Šé™¤
        if (existingIndex >= 0) {
          newSelectedProducts.splice(existingIndex, 1);
        }
      } else {
        // å•†å“ã‚’è¿½åŠ ã¾ãŸã¯æ›´æ–°
        const productSelection: ProductSelectionData = {
          product_id: product.id,
          product_name: safeProductName(product),
          quantity: safeQty,
          unit_price: product.price || 0,
          total_price: (product.price || 0) * safeQty,
          category: product.category_id?.toString(),
        };

        if (existingIndex >= 0) {
          newSelectedProducts[existingIndex] = productSelection;
        } else {
          newSelectedProducts.push(productSelection);
        }
      }

      setValue('products', newSelectedProducts);
      console.log(`[ProductSelection] Updated quantity for product ${productId}: ${safeQty}`);
    } catch (error) {
      console.error('Error in handleQuantityChange:', error);
      setError('å•†å“ã®æ•°é‡å¤‰æ›´ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  }, [safeProducts, selectedProducts, setValue]);

  // æ•°é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
  const QuantityControl = React.memo<{ 
    productId: number;
    quantity: number;
  }>(({ productId, quantity }) => (
    <div className="flex items-center space-x-3">
      <Button
        type="button"
        variant="outline"
        size="icon"
        onClick={() => handleQuantityChange(productId, quantity - 1)}
        disabled={quantity === 0}
        className="h-8 w-8 rounded-full"
      >
        âˆ’
      </Button>
      
      <span className="w-8 text-center font-medium text-sm">
        {safeRender(quantity)}
      </span>
      
      <Button
        type="button"
        variant="outline"
        size="icon"
        onClick={() => handleQuantityChange(productId, quantity + 1)}
        disabled={quantity >= 99}
        className="h-8 w-8 rounded-full"
      >
        +
      </Button>
    </div>
  ));

  QuantityControl.displayName = 'QuantityControl';

  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰æº–å‚™å‰ã®è¡¨ç¤º
  if (!isClient) {
    return (
      <div className={className}>
        <h2 className="text-lg font-semibold text-gray-900 border-b pb-2 mb-4">
          å•†å“é¸æŠ
        </h2>
        <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
          <div className="animate-pulse">
            <div className="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
            <div className="h-4 bg-gray-300 rounded w-1/2"></div>
          </div>
          <p className="text-sm text-gray-600 mt-2">
            å•†å“æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...
          </p>
        </div>
      </div>
    );
  }

  // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
  if (error) {
    return (
      <div className={className}>
        <h2 className="text-lg font-semibold text-gray-900 border-b pb-2 mb-4">
          å•†å“é¸æŠ
        </h2>
        <div className="bg-red-50 border border-red-200 rounded-lg p-4">
          <div className="flex items-start">
            <div className="flex-shrink-0">
              <svg className="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
              </svg>
            </div>
            <div className="ml-3">
              <h3 className="text-sm font-medium text-red-800">
                å•†å“é¸æŠã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ
              </h3>
              <p className="text-sm text-red-700 mt-1">
                {safeRender(error)}
              </p>
              <div className="mt-3">
                <button
                  onClick={() => {
                    setError(null);
                    window.location.reload();
                  }}
                  className="text-sm bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700"
                >
                  ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
                </button>
              </div>
              
              {/* ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰ */}
              {process.env.NODE_ENV === 'development' && debugInfo && (
                <details className="mt-3">
                  <summary className="text-xs text-red-600 cursor-pointer">
                    ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
                  </summary>
                  <pre className="text-xs text-red-600 mt-2 bg-red-100 p-2 rounded overflow-auto">
                    {safeRender(debugInfo)}
                  </pre>
                </details>
              )}
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <ProductSelectionErrorBoundary>
      <div className={className}>
        <h2 className="text-lg font-semibold text-gray-900 border-b pb-2 mb-4">
          å•†å“é¸æŠ
        </h2>

        {/* é¸æŠæ¸ˆã¿å•†å“ã‚µãƒãƒªãƒ¼ */}
        {selectedProducts.length > 0 && (
          <div className="mb-6 bg-green-50 border border-green-200 rounded-lg p-4">
            <h3 className="font-medium text-gray-900 mb-3">é¸æŠã—ãŸå•†å“</h3>
            <div className="space-y-2">
              {selectedProducts.map((product) => (
                <div key={product.product_id} className="flex justify-between items-center text-sm">
                  <span>
                    {safeRender(product.product_name)} Ã— {safeRender(product.quantity)}
                  </span>
                  <div className="flex items-center space-x-2">
                    {formSettings?.show_price && (
                      <span className="font-medium">
                        {safePrice(product.total_price)}
                      </span>
                    )}
                    <Button
                      type="button"
                      variant="outline"
                      size="sm"
                      onClick={() => handleQuantityChange(product.product_id, 0)}
                      className="text-xs h-6 px-2"
                    >
                      å‰Šé™¤
                    </Button>
                  </div>
                </div>
              ))}
              
              {formSettings?.show_price && (
                <div className="pt-2 border-t border-green-300 flex justify-between items-center font-medium">
                  <span>åˆè¨ˆé‡‘é¡</span>
                  <span className="text-lg text-green-700">
                    {safePrice(totalAmount)}
                  </span>
                </div>
              )}
            </div>
          </div>
        )}

        {/* å•†å“ä¸€è¦§ */}
        <div className="space-y-6">
          <p className="text-sm text-gray-600">
            ã”å¸Œæœ›ã®å•†å“ã¨ãã‚Œãã‚Œã®æ•°é‡ã‚’é¸æŠã—ã¦ãã ã•ã„
          </p>
          
          {Object.entries(groupedProducts).map(([categoryIdStr, categoryProducts]) => {
            const categoryId = parseInt(categoryIdStr, 10);
            
            return (
              <div key={categoryId} className="space-y-3">
                <h3 className="text-md font-medium text-gray-800 border-l-4 border-green-500 pl-3">
                  {getCategoryName(categoryId)}
                </h3>
                
                <div className="grid gap-3">
                  {categoryProducts.map((product) => {
                    const quantity = getProductQuantity(product.id);
                    
                    return (
                      <div
                        key={product.id}
                        className={`border rounded-lg p-4 transition-colors ${
                          quantity > 0 
                            ? 'bg-green-50 border-green-200' 
                            : 'bg-white border-gray-200 hover:border-green-300'
                        }`}
                      >
                        <div className="flex justify-between items-center">
                          <div className="flex-1">
                            <h4 className="font-medium text-gray-900">
                              {safeRender(product.name)}
                            </h4>
                            {formSettings?.show_price && (
                              <p className="text-sm text-gray-600">
                                {safePrice(product.price)}
                              </p>
                            )}
                          </div>
                          
                          <QuantityControl
                            productId={product.id}
                            quantity={quantity}
                          />
                        </div>
                        
                        {quantity > 0 && formSettings?.show_price && (
                          <div className="mt-2 pt-2 border-t border-gray-200">
                            <p className="text-sm text-gray-700">
                              å°è¨ˆ: {safePrice((product.price || 0) * quantity)}
                            </p>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })}
        </div>

        {/* ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ */}
        {errors.products && (
          <div className="mt-4 bg-red-50 border border-red-200 rounded-lg p-3">
            <p className="text-sm text-red-600">
              {safeRender(errors.products.message)}
            </p>
          </div>
        )}

        {/* ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ */}
        <div className="mt-4 text-xs text-gray-500 bg-gray-50 p-3 rounded-lg">
          <p>â€¢ æ•°é‡ã¯æœ€å¤§99å€‹ã¾ã§é¸æŠã§ãã¾ã™</p>
          <p>â€¢ é¸æŠã—ãŸå•†å“ã¯ä¸Šéƒ¨ã«è¡¨ç¤ºã•ã‚Œã€ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³ã§å–ã‚Šæ¶ˆã›ã¾ã™</p>
          <p>â€¢ å¼•ãå–ã‚Šæ—¥ã¯é¸æŠã—ãŸå•†å“ã‚«ãƒ†ã‚´ãƒªã«ã‚ˆã£ã¦æ±ºã¾ã‚Šã¾ã™</p>
        </div>
      </div>
    </ProductSelectionErrorBoundary>
  );
});

ProductSelectionSection.displayName = 'ProductSelectionSection';
```

### 4. ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ•ãƒƒã‚¯ä¿®æ­£

#### useFormConfig ã®å¼·åŒ–
```typescript
// src/hooks/useFormConfig.ts

import { useState, useEffect, useCallback } from 'react';
import type { FormConfigResponse } from '@/types';

export interface UseFormConfigOptions {
  enabled?: boolean;
  onError?: (error: string) => void;
  retryCount?: number;
  retryDelay?: number;
}

export interface UseFormConfigReturn {
  config: FormConfigResponse | null;
  loading: boolean;
  error: string | null;
  refetch: () => Promise<void>;
  debugInfo: any;
}

export const useFormConfig = (
  presetId: number,
  options: UseFormConfigOptions = {}
): UseFormConfigReturn => {
  const { 
    enabled = true, 
    onError, 
    retryCount = 3, 
    retryDelay = 1000 
  } = options;
  
  const [config, setConfig] = useState<FormConfigResponse | null>(null);
  const [loading, setLoading] = useState(enabled);
  const [error, setError] = useState<string | null>(null);
  const [debugInfo, setDebugInfo] = useState<any>(null);
  const [retryAttempt, setRetryAttempt] = useState(0);

  const fetchConfig = useCallback(async (attempt = 0) => {
    if (!enabled || presetId < 1) {
      setLoading(false);
      return;
    }

    try {
      setLoading(true);
      setError(null);
      
      const startTime = Date.now();
      console.log(`[useFormConfig] Fetching config for preset: ${presetId} (attempt ${attempt + 1})`);
      
      // APIå‘¼ã³å‡ºã—
      const response = await fetch(`/api/form/${presetId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-cache',
        },
      });
      
      const endTime = Date.now();
      const responseTime = endTime - startTime;
      
      console.log(`[useFormConfig] API response:`, {
        status: response.status,
        statusText: response.statusText,
        responseTime: `${responseTime}ms`,
        headers: Object.fromEntries(response.headers.entries())
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`[useFormConfig] API error response:`, {
          status: response.status,
          statusText: response.statusText,
          body: errorText
        });
        
        throw new Error(`API error: ${response.status} ${response.statusText}`);
      }
      
      const result = await response.json();
      
      console.log(`[useFormConfig] API result:`, {
        success: result.success,
        hasData: !!result.data,
        productsCount: result.data?.products?.length || 0,
        formSettingsExists: !!result.data?.form_settings,
        presetExists: !!result.data?.preset
      });
      
      if (!result.success || !result.data) {
        throw new Error('ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®æ›´æ–°
      setDebugInfo({
        presetId,
        responseTime,
        attempt: attempt + 1,
        timestamp: new Date().toISOString(),
        apiResponse: {
          success: result.success,
          dataKeys: result.data ? Object.keys(result.data) : [],
          productsCount: result.data?.products?.length || 0
        }
      });
      
      setConfig(result.data);
      setRetryAttempt(0);
      
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
      console.error(`[useFormConfig] Fetch error (attempt ${attempt + 1}):`, err);
      
      // ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
      if (attempt < retryCount - 1) {
        console.log(`[useFormConfig] Retrying in ${retryDelay}ms...`);
        setRetryAttempt(attempt + 1);
        
        setTimeout(() => {
          fetchConfig(attempt + 1);
        }, retryDelay * (attempt + 1)); // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
        
        return;
      }
      
      // æœ€çµ‚çš„ãªã‚¨ãƒ©ãƒ¼å‡¦ç†
      setError(errorMessage);
      setDebugInfo({
        presetId,
        error: errorMessage,
        attempt: attempt + 1,
        timestamp: new Date().toISOString(),
        finalAttempt: true
      });
      
      onError?.(errorMessage);
    } finally {
      if (attempt === retryCount - 1 || !error) {
        setLoading(false);
      }
    }
  }, [presetId, enabled, onError, retryCount, retryDelay]);

  const refetch = useCallback(async () => {
    setRetryAttempt(0);
    await fetchConfig(0);
  }, [fetchConfig]);

  useEffect(() => {
    if (enabled) {
      fetchConfig(0);
    }
  }, [fetchConfig, enabled]);

  return {
    config,
    loading,
    error,
    refetch,
    debugInfo
  };
};
```

## ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ»ç›£è¦–æ©Ÿèƒ½

### 1. è©³ç´°ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ 
```typescript
// src/lib/utils/logger.ts

export enum LogLevel {
  DEBUG = 0,
  INFO = 1,
  WARN = 2,
  ERROR = 3
}

export class Logger {
  private static instance: Logger;
  private logLevel: LogLevel = LogLevel.INFO;

  static getInstance(): Logger {
    if (!Logger.instance) {
      Logger.instance = new Logger();
    }
    return Logger.instance;
  }

  setLogLevel(level: LogLevel) {
    this.logLevel = level;
  }

  private log(level: LogLevel, message: string, data?: any) {
    if (level < this.logLevel) return;

    const timestamp = new Date().toISOString();
    const levelName = LogLevel[level];
    const prefix = `[${timestamp}] [${levelName}]`;

    switch (level) {
      case LogLevel.DEBUG:
        console.debug(prefix, message, data);
        break;
      case LogLevel.INFO:
        console.info(prefix, message, data);
        break;
      case LogLevel.WARN:
        console.warn(prefix, message, data);
        break;
      case LogLevel.ERROR:
        console.error(prefix, message, data);
        break;
    }
  }

  debug(message: string, data?: any) {
    this.log(LogLevel.DEBUG, message, data);
  }

  info(message: string, data?: any) {
    this.log(LogLevel.INFO, message, data);
  }

  warn(message: string, data?: any) {
    this.log(LogLevel.WARN, message, data);
  }

  error(message: string, data?: any) {
    this.log(LogLevel.ERROR, message, data);
  }
}

export const logger = Logger.getInstance();
```

### 2. ã‚¨ãƒ©ãƒ¼ç›£è¦–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
```typescript
// src/components/ErrorMonitor.tsx

import React, { useEffect } from 'react';
import { logger } from '@/lib/utils/logger';

export const ErrorMonitor: React.FC = () => {
  useEffect(() => {
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    const handleError = (event: ErrorEvent) => {
      logger.error('Global error caught:', {
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        error: event.error
      });
    };

    // Promise rejection ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    const handleUnhandledRejection = (event: PromiseRejectionEvent) => {
      logger.error('Unhandled promise rejection:', {
        reason: event.reason,
        promise: event.promise
      });
    };

    window.addEventListener('error', handleError);
    window.addEventListener('unhandledrejection', handleUnhandledRejection);

    return () => {
      window.removeEventListener('error', handleError);
      window.removeEventListener('unhandledrejection', handleUnhandledRejection);
    };
  }, []);

  return null;
};
```

## ğŸ“‹ å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: ç·Šæ€¥å¯¾å¿œï¼ˆå³æ—¥ï¼‰
- [ ] API ãƒ«ãƒ¼ãƒˆä¿®æ­£ (`src/app/api/admin/preset-products/[presetId]/route.ts`)
- [ ] å®‰å…¨ãªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°å®Ÿè£… (`src/lib/utils/safeRender.ts`)
- [ ] ProductSelectionSection ã®åŸºæœ¬ä¿®æ­£
- [ ] æœ¬ç•ªç’°å¢ƒã§ã®APIå‹•ä½œç¢ºèª

### Phase 2: å®‰å®šåŒ–å¯¾å¿œï¼ˆ1é€±é–“ï¼‰
- [ ] ProductSelectionSection ã®å®Œå…¨ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
- [ ] useFormConfig ãƒ•ãƒƒã‚¯ã®å¼·åŒ–
- [ ] ã‚¨ãƒ©ãƒ¼å¢ƒç•Œã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…
- [ ] è©³ç´°ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®å°å…¥

### Phase 3: ç›£è¦–ãƒ»æ”¹å–„ï¼ˆ1ãƒ¶æœˆï¼‰
- [ ] ã‚¨ãƒ©ãƒ¼ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã®å®Ÿè£…
- [ ] è‡ªå‹•ãƒ†ã‚¹ãƒˆã®è¿½åŠ 
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´å‚™

## ğŸš¨ æ³¨æ„äº‹é …

### å®Ÿè£…æ™‚ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ
1. **å‹å®‰å…¨æ€§**: å…¨ã¦ã®å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦å‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿæ–½
2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: å„ãƒ¬ãƒ™ãƒ«ã§ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼å‡¦ç†
3. **ãƒ­ã‚°å‡ºåŠ›**: å•é¡Œç‰¹å®šã®ãŸã‚ã®è©³ç´°ãªãƒ­ã‚°
4. **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: ã‚¨ãƒ©ãƒ¼æ™‚ã®ä»£æ›¿è¡¨ç¤º

### ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ç¢ºèªé …ç›®
1. **API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: å…¨ã¦ã®ãƒ«ãƒ¼ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹
2. **ç’°å¢ƒå¤‰æ•°**: æœ¬ç•ªç’°å¢ƒã§ã®è¨­å®šãŒæ­£ã—ã„ã‹
3. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: Vercel ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒé©åˆ‡ã«ã‚¯ãƒªã‚¢ã•ã‚Œã¦ã„ã‚‹ã‹
4. **ãƒ­ã‚°**: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒé©åˆ‡ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã‹

---

**ä½œæˆæ—¥**: 2025å¹´8æœˆ5æ—¥  
**å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ **: LINEäºˆç´„ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ™ã‚¸ãƒ©ã‚¤ã‚¹ï¼‰  
**å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: Next.js 15.4.3  
**ä½œæˆè€…**: Kiro AI Assistant
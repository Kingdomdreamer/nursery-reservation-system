# 緊急修正指示書 - 商品追加後フォーム表示問題

## 問題概要

### 🚨 **症状**
- 管理画面で商品を追加してフォーム作成完了
- フォーム画面（プリセット4）にアクセスすると商品が0件
- React Error #310が発生してアプリケーションクラッシュ

### 📊 **エラーログ分析**
```
[useFormConfig] API result: {success: true, productsCount: 0, formSettingsExists: true, presetExists: true}
[ProductSelection] Products array is empty
React Error #310 (useMemo)
```

### 🔍 **根本原因の特定**

#### **原因1: データベース関連付けの問題**
管理画面で商品を追加しても、実際のデータベースに正しく関連付けられていない可能性

#### **原因2: API取得ロジックの問題**
プリセット設定APIが商品データを正しく取得・整形できていない

#### **原因3: データ構造の不整合**
`preset_products`と`pickup_windows`の関連付けに問題がある

## 🔧 **緊急修正内容**

### Step 1: データベース状態の確認

#### **1.1 プリセット4の商品関連付け確認**
```sql
-- プリセット4の基本情報
SELECT * FROM product_presets WHERE id = 4;

-- プリセット4の商品関連付け
SELECT 
  pp.id,
  pp.preset_id,
  pp.product_id,
  pp.display_order,
  pp.is_active,
  p.name as product_name,
  p.visible,
  p.price
FROM preset_products pp
LEFT JOIN products p ON pp.product_id = p.id
WHERE pp.preset_id = 4
ORDER BY pp.display_order;

-- プリセット4の引き取り期間
SELECT 
  pw.id,
  pw.preset_id,
  pw.product_id,
  p.name as product_name,
  pw.pickup_start,
  pw.pickup_end
FROM pickup_windows pw
LEFT JOIN products p ON pw.product_id = p.id
WHERE pw.preset_id = 4;

-- プリセット4のフォーム設定
SELECT * FROM form_settings WHERE preset_id = 4;
```

### Step 2: API修正

#### **2.1 プリセット設定API の商品取得ロジック修正**
**ファイル:** `src/app/api/presets/[presetId]/config/route.ts`

```typescript
// 既存のコードを以下に置き換え

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ presetId: string }> }
) {
  try {
    const { presetId } = await params;
    const id = Number(presetId);

    if (!Number.isInteger(id) || id < 1) {
      throw new InvalidPresetIdError(presetId);
    }

    console.log(`[Config API] Fetching config for preset: ${id}`);

    if (!supabaseAdmin) {
      throw new Error('Database connection unavailable');
    }

    // 1. プリセット基本情報の取得
    const { data: presetData, error: presetError } = await supabaseAdmin
      .from('product_presets')
      .select('*')
      .eq('id', id)
      .single();

    if (presetError || !presetData) {
      console.error('[Config API] Preset not found:', presetError);
      throw new PresetNotFoundError(id);
    }

    // 2. フォーム設定の取得
    const { data: formSettings, error: formError } = await supabaseAdmin
      .from('form_settings')
      .select('*')
      .eq('preset_id', id);

    if (formError) {
      console.error('[Config API] Form settings error:', formError);
    }

    // 3. プリセット商品の取得（商品情報も含む）
    const { data: presetProducts, error: presetProductsError } = await supabaseAdmin
      .from('preset_products')
      .select(`
        id,
        preset_id,
        product_id,
        display_order,
        is_active,
        created_at,
        updated_at,
        product:products (
          id,
          name,
          price,
          category_id,
          visible,
          base_product_name,
          variation_name,
          product_code,
          created_at,
          updated_at
        )
      `)
      .eq('preset_id', id)
      .eq('is_active', true)
      .order('display_order');

    if (presetProductsError) {
      console.error('[Config API] Preset products error:', presetProductsError);
    }

    // 4. 引き取り期間の取得
    const { data: pickupWindows, error: pickupError } = await supabaseAdmin
      .from('pickup_windows')
      .select('*')
      .eq('preset_id', id);

    if (pickupError) {
      console.error('[Config API] Pickup windows error:', pickupError);
    }

    // 5. データの安全な処理と検証
    const safePresetProducts = (presetProducts || []).filter(pp => {
      if (!pp || !pp.product) {
        console.warn(`[Config API] Invalid preset product:`, pp);
        return false;
      }
      
      const product = pp.product;
      if (!product.id || !product.name) {
        console.warn(`[Config API] Invalid product data:`, product);
        return false;
      }
      
      return true;
    });

    // 6. 商品データの抽出
    const products = safePresetProducts.map(pp => pp.product);

    // 7. デバッグ情報の出力
    console.log(`[Config API] Data summary for preset ${id}:`, {
      preset_exists: !!presetData,
      form_settings_count: (formSettings || []).length,
      preset_products_count: safePresetProducts.length,
      products_count: products.length,
      pickup_windows_count: (pickupWindows || []).length,
      product_names: products.map(p => p.name)
    });

    // 8. 商品が0件の場合の詳細ログ
    if (products.length === 0) {
      console.error(`[Config API] No products found for preset ${id}!`);
      console.error('[Config API] Raw preset_products data:', presetProducts);
      console.error('[Config API] This will cause React Error #310');
      
      // 緊急回避: 最低限のダミー商品を作成
      const dummyProduct = {
        id: 999999,
        name: '商品設定エラー - 管理者にお問い合わせください',
        price: 0,
        category_id: 1,
        visible: true,
        base_product_name: null,
        variation_name: null,
        product_code: null,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };
      
      products.push(dummyProduct);
      console.warn('[Config API] Added emergency dummy product to prevent crash');
    }

    // 9. レスポンスデータの構築
    const responseData: FormConfigResponse = {
      preset: presetData,
      form_settings: (formSettings && formSettings.length > 0) ? formSettings[0] : {
        id: 0,
        preset_id: id,
        show_price: true,
        require_phone: true,
        require_furigana: false,
        allow_note: true,
        is_enabled: true,
        custom_message: null,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      },
      products: products,
      pickup_windows: pickupWindows || [],
      preset_products: safePresetProducts
    };

    return createSuccessResponse(responseData, {
      presetId: id,
      totalProducts: products.length,
      totalPickupWindows: (pickupWindows || []).length,
      hasFormSettings: !!(formSettings && formSettings.length > 0)
    });

  } catch (error) {
    console.error('[Config API] Error:', error);
    return handleApiError(error);
  }
}
```

### Step 3: 統合フォーム作成APIの修正

#### **3.1 商品関連付けの確実な実行**
**ファイル:** `src/app/api/admin/presets/create-complete/route.ts`

```typescript
// 商品関連付け部分の修正
const presetProducts = data.selected_products.map((productId, index) => ({
  preset_id: preset.id,
  product_id: productId,
  display_order: index + 1, // 1から始まる連番
  is_active: true,
  created_at: new Date().toISOString(),
  updated_at: new Date().toISOString()
}));

console.log(`[Create API] Creating preset products:`, presetProducts);

const { data: insertedProducts, error: productsError } = await supabaseAdmin
  .from('preset_products')
  .insert(presetProducts)
  .select(); // 挿入されたデータを取得

if (productsError) {
  console.error('商品関連付けエラー:', productsError);
  // ロールバック
  await supabaseAdmin.from('form_settings').delete().eq('preset_id', preset.id);
  await supabaseAdmin.from('product_presets').delete().eq('id', preset.id);
  throw new Error(`商品関連付けに失敗しました: ${productsError.message}`);
}

console.log(`[Create API] Successfully inserted ${insertedProducts?.length || 0} preset products`);

// 挿入確認
const { data: verifyProducts, error: verifyError } = await supabaseAdmin
  .from('preset_products')
  .select('id, product_id, is_active')
  .eq('preset_id', preset.id);

if (verifyError) {
  console.error('商品関連付け確認エラー:', verifyError);
} else {
  console.log(`[Create API] Verification: ${verifyProducts?.length || 0} products linked to preset ${preset.id}`);
}
```

### Step 4: フロントエンド側の安全性強化

#### **4.1 useFormConfig の修正**
**ファイル:** `src/hooks/useFormConfig.ts`

```typescript
const fetchFormConfig = useCallback(async () => {
  try {
    setLoading(true);
    setError(null);
    
    console.log(`[useFormConfig] Fetching config for preset: ${presetId} (attempt 1)`);
    
    const response = await fetch(`/api/presets/${presetId}/config`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    console.log('[useFormConfig] API result:', {
      success: result.success,
      hasData: !!result.data,
      productsCount: result.data?.products?.length || 0,
      formSettingsExists: !!result.data?.form_settings,
      presetExists: !!result.data?.preset
    });
    
    if (!result.success || !result.data) {
      throw new Error('Invalid API response structure');
    }
    
    const { data } = result;
    
    // 商品データの厳密な検証
    let validatedProducts = [];
    if (Array.isArray(data.products)) {
      validatedProducts = data.products.filter(product => {
        if (!product || typeof product !== 'object') {
          console.warn('[useFormConfig] Invalid product object:', product);
          return false;
        }
        
        if (!product.id || !product.name) {
          console.warn('[useFormConfig] Product missing required fields:', product);
          return false;
        }
        
        return true;
      });
    }
    
    console.log(`[useFormConfig] Validated ${validatedProducts.length} products`);
    
    // 商品データが空の場合の詳細ログ
    if (validatedProducts.length === 0) {
      console.error(`[useFormConfig] CRITICAL: No products found for preset ${presetId}`);
      console.error('[useFormConfig] Raw API data:', data);
      console.error('[useFormConfig] This will cause React Error #310');
      
      // 管理者向けエラーメッセージ
      setError(`プリセット${presetId}に商品が関連付けられていません。\n\n管理画面で以下を確認してください：\n1. プリセットに商品が追加されているか\n2. 商品が「有効」状態になっているか\n3. データベースの整合性に問題がないか`);
      
      // 空の設定で初期化（クラッシュ防止）
      setFormConfig({
        form_settings: data.form_settings || {
          show_price: true,
          require_phone: true,
          require_furigana: false,
          allow_note: true,
          is_enabled: true
        },
        products: [], // 空配列で安全に初期化
        pickup_windows: data.pickup_windows || [],
        preset: data.preset || null,
        preset_products: data.preset_products || []
      });
      
      return; // 早期リターン
    }
    
    // 正常な場合の設定
    setFormConfig({
      form_settings: data.form_settings,
      products: validatedProducts,
      pickup_windows: data.pickup_windows || [],
      preset: data.preset,
      preset_products: data.preset_products || []
    });
    
  } catch (err) {
    console.error('[useFormConfig] Error:', err);
    setError(err instanceof Error ? err.message : 'Unknown error');
    
    // エラー時のフォールバック設定
    setFormConfig({
      form_settings: {
        show_price: true,
        require_phone: true,
        require_furigana: false,
        allow_note: true,
        is_enabled: true
      },
      products: [], // 空配列で安全に初期化
      pickup_windows: [],
      preset: null,
      preset_products: []
    });
  } finally {
    setLoading(false);
  }
}, [presetId]);
```

### Step 5: 緊急データ修正

#### **5.1 プリセット4のデータ修正SQL**
```sql
-- プリセット4に商品が関連付けられていない場合の緊急修正

-- 1. 現在の状態確認
SELECT 
  'preset_products' as table_name,
  COUNT(*) as count
FROM preset_products 
WHERE preset_id = 4
UNION ALL
SELECT 
  'pickup_windows' as table_name,
  COUNT(*) as count
FROM pickup_windows 
WHERE preset_id = 4;

-- 2. 商品が0件の場合、サンプル商品を関連付け
INSERT INTO preset_products (preset_id, product_id, display_order, is_active)
SELECT 4, id, ROW_NUMBER() OVER (ORDER BY name), true
FROM products 
WHERE visible = true 
AND id NOT IN (SELECT COALESCE(product_id, 0) FROM preset_products WHERE preset_id = 4)
LIMIT 3;

-- 3. 引き取り期間も作成
INSERT INTO pickup_windows (preset_id, product_id, pickup_start, pickup_end, dates, comment)
SELECT 
  4,
  pp.product_id,
  '2025-08-10 10:00:00+09',
  '2025-08-17 18:00:00+09',
  ARRAY['2025-08-10', '2025-08-11', '2025-08-12'],
  '引き取り可能期間'
FROM preset_products pp
WHERE pp.preset_id = 4
AND pp.product_id NOT IN (SELECT COALESCE(product_id, 0) FROM pickup_windows WHERE preset_id = 4);
```

## 🚨 **実装優先度**

### **即座に実行（緊急）**
1. **Step 5**: データベース修正SQL実行
2. **Step 4.1**: useFormConfig の安全性強化

### **24時間以内（高優先度）**
3. **Step 2.1**: プリセット設定API修正
4. **Step 3.1**: 統合フォーム作成API修正

### **1週間以内（中優先度）**
5. 根本原因の調査と恒久対策

## ✅ **完了確認**

- [ ] プリセット4で商品が表示される
- [ ] React Error #310が解消される
- [ ] 管理画面での商品追加が正常動作する
- [ ] エラーログが出力されない
- [ ] フォームが正常に表示される

## 📝 **注意事項**

- この修正は緊急対応のため、根本原因の調査も並行して実施
- データベース修正は本番環境で慎重に実行
- 他のプリセットに影響がないことを確認
- ログ出力を充実させて今後の問題特定を容易にする
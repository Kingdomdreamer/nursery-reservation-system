# ç·Šæ€¥ä¿®æ­£è¨­è¨ˆæŒ‡ç¤ºæ›¸ - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ãƒ»å•†å“é¸æŠå•é¡Œ

## å•é¡Œæ¦‚è¦

### 1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‚¨ãƒ©ãƒ¼
**ã‚¨ãƒ©ãƒ¼:** `Application error: a client-side exception has occurred`
**å½±éŸ¿:** ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ãŒå‹•ä½œã—ãªã„

### 2. å•†å“é¸æŠå•é¡Œ
**å•é¡Œ:** éè¡¨ç¤ºãƒ»ç„¡åŠ¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å•†å“ãŒé¸æŠã§ããªã„
**å½±éŸ¿:** ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆæ™‚ã«å¿…è¦ãªå•†å“ã‚’é¸æŠã§ããªã„

## è§£æ±ºæ–¹é‡

### A. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ã®ç·Šæ€¥ä¿®æ­£
### B. å•†å“é¸æŠæ©Ÿèƒ½ã®æ”¹å–„
### C. ç®¡ç†ç”»é¢ã§ã®å•†å“ç®¡ç†å¼·åŒ–

## å®Ÿè£…å†…å®¹

### 1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ã®åŸå› èª¿æŸ»ãƒ»ä¿®æ­£

#### 1.1 ã‚¨ãƒ©ãƒ¼å¢ƒç•Œã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…
**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/components/ErrorBoundary.tsx`

```typescript
'use client';

import React from 'react';

interface ErrorBoundaryState {
  hasError: boolean;
  error?: Error;
  errorInfo?: React.ErrorInfo;
}

interface ErrorBoundaryProps {
  children: React.ReactNode;
  fallback?: React.ComponentType<{ error: Error; reset: () => void }>;
}

export class ErrorBoundary extends React.Component<ErrorBoundaryProps, ErrorBoundaryState> {
  constructor(props: ErrorBoundaryProps) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    return {
      hasError: true,
      error,
    };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('ErrorBoundary caught an error:', error, errorInfo);
    
    // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
    this.setState({
      error,
      errorInfo,
    });

    // æœ¬ç•ªç’°å¢ƒã§ã¯å¤–éƒ¨ãƒ­ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã«é€ä¿¡
    if (process.env.NODE_ENV === 'production') {
      // TODO: å¤–éƒ¨ãƒ­ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã«é€ä¿¡
      console.error('Production error:', {
        error: error.message,
        stack: error.stack,
        componentStack: errorInfo.componentStack,
        timestamp: new Date().toISOString(),
      });
    }
  }

  handleReset = () => {
    this.setState({ hasError: false, error: undefined, errorInfo: undefined });
  };

  render() {
    if (this.state.hasError) {
      const { fallback: Fallback } = this.props;
      
      if (Fallback && this.state.error) {
        return <Fallback error={this.state.error} reset={this.handleReset} />;
      }

      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50">
          <div className="max-w-md w-full bg-white rounded-lg shadow-md p-6 text-center">
            <div className="text-red-500 text-4xl mb-4">âš ï¸</div>
            <h2 className="text-xl font-bold text-gray-900 mb-2">
              ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
            </h2>
            <p className="text-gray-600 mb-4">
              äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
            </p>
            
            {process.env.NODE_ENV === 'development' && this.state.error && (
              <details className="mb-4 text-left">
                <summary className="cursor-pointer text-sm text-gray-500 mb-2">
                  ã‚¨ãƒ©ãƒ¼è©³ç´°ï¼ˆé–‹ç™ºç”¨ï¼‰
                </summary>
                <pre className="text-xs bg-gray-100 p-2 rounded overflow-auto max-h-32">
                  {this.state.error.message}
                  {'\n\n'}
                  {this.state.error.stack}
                </pre>
              </details>
            )}
            
            <div className="space-y-2">
              <button
                onClick={this.handleReset}
                className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
              >
                å†è©¦è¡Œ
              </button>
              <button
                onClick={() => window.location.reload()}
                className="w-full bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400"
              >
                ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
              </button>
            </div>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¨ãƒ©ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export const DefaultErrorFallback: React.FC<{ error: Error; reset: () => void }> = ({ 
  error, 
  reset 
}) => (
  <div className="min-h-screen flex items-center justify-center bg-gray-50">
    <div className="max-w-md w-full bg-white rounded-lg shadow-md p-6 text-center">
      <div className="text-red-500 text-4xl mb-4">ğŸ’¥</div>
      <h2 className="text-xl font-bold text-gray-900 mb-2">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
      <p className="text-gray-600 mb-4">{error.message}</p>
      <button
        onClick={reset}
        className="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
      >
        å†è©¦è¡Œ
      </button>
    </div>
  </div>
);
```

#### 1.2 ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«ã‚¨ãƒ©ãƒ¼å¢ƒç•Œã‚’è¿½åŠ 
**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/app/layout.tsx`

```typescript
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import { LiffProvider } from "@/components/line/LiffProvider";
import { ErrorBoundary } from "@/components/ErrorBoundary";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata = {
  title: "ä¿è‚²åœ’äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ",
  description: "ä¿è‚²åœ’ã®å•†å“äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        <ErrorBoundary>
          <LiffProvider>
            {children}
          </LiffProvider>
        </ErrorBoundary>
      </body>
    </html>
  );
}
```

### 2. å•†å“é¸æŠæ©Ÿèƒ½ã®æ”¹å–„

#### 2.1 å…¨å•†å“å–å¾—APIã®å®Ÿè£…
**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/app/api/admin/products/all/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { supabaseAdmin } from '@/lib/supabase';

export async function GET(request: NextRequest) {
  try {
    if (!supabaseAdmin) {
      return NextResponse.json(
        { error: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãŒåˆ©ç”¨ã§ãã¾ã›ã‚“' },
        { status: 500 }
      );
    }

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æ¤œç´¢æ¡ä»¶ã‚’å–å¾—
    const { searchParams } = new URL(request.url);
    const search = searchParams.get('search') || '';
    const includeHidden = searchParams.get('includeHidden') === 'true';

    let query = supabaseAdmin
      .from('products')
      .select(`
        id,
        name,
        price,
        category_id,
        visible,
        base_product_name,
        variation_name,
        product_code,
        created_at,
        updated_at
      `)
      .order('name');

    // æ¤œç´¢æ¡ä»¶ã‚’è¿½åŠ 
    if (search) {
      query = query.or(`name.ilike.%${search}%,base_product_name.ilike.%${search}%,product_code.ilike.%${search}%`);
    }

    // ç®¡ç†ç”»é¢ã§ã¯éè¡¨ç¤ºå•†å“ã‚‚å«ã‚ã‚‹
    if (!includeHidden) {
      query = query.eq('visible', true);
    }

    const { data: products, error } = await query;

    if (error) {
      console.error('å•†å“å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      throw error;
    }

    // å•†å“ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢
    const formattedProducts = (products || []).map(product => ({
      id: product.id,
      name: product.name,
      price: product.price || 0,
      category_id: product.category_id || 1,
      visible: product.visible ?? true,
      base_product_name: product.base_product_name,
      variation_name: product.variation_name,
      product_code: product.product_code,
      display_name: product.variation_name 
        ? `${product.base_product_name} (${product.variation_name})`
        : product.name,
      status_label: product.visible ? 'è¡¨ç¤ºä¸­' : 'éè¡¨ç¤º',
      created_at: product.created_at,
      updated_at: product.updated_at
    }));

    return NextResponse.json({
      success: true,
      data: formattedProducts,
      total: formattedProducts.length
    });

  } catch (error) {
    console.error('å…¨å•†å“å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { 
        success: false,
        error: error instanceof Error ? error.message : 'å•†å“ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' 
      },
      { status: 500 }
    );
  }
}
```

#### 2.2 ç®¡ç†ç”»é¢ã®å•†å“é¸æŠæ©Ÿèƒ½æ”¹å–„
**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/app/admin/settings/page.tsx`

æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›´æ–°ï¼š

```typescript
'use client';

import { useState, useEffect } from 'react';
import AdminLayout from '@/components/admin/AdminLayout';
import { ErrorBoundary } from '@/components/ErrorBoundary';

interface SimplePreset {
  id: number;
  preset_name: string;
  created_at: string;
}

interface EnhancedProduct {
  id: number;
  name: string;
  price: number;
  category_id: number;
  visible: boolean;
  base_product_name?: string;
  variation_name?: string;
  product_code?: string;
  display_name: string;
  status_label: string;
}

interface FormCreationData {
  preset_name: string;
  selected_products: number[];
  form_settings: {
    show_price: boolean;
    require_phone: boolean;
    require_furigana: boolean;
    allow_note: boolean;
  };
}

export default function SettingsPage() {
  const [presets, setPresets] = useState<SimplePreset[]>([]);
  const [allProducts, setAllProducts] = useState<EnhancedProduct[]>([]);
  const [loading, setLoading] = useState(true);
  const [isCreating, setIsCreating] = useState(false);
  
  // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ‡ãƒ¼ã‚¿
  const [formData, setFormData] = useState<FormCreationData>({
    preset_name: '',
    selected_products: [],
    form_settings: {
      show_price: true,
      require_phone: true,
      require_furigana: false,
      allow_note: true
    }
  });

  // å•†å“æ¤œç´¢ç”¨ã®çŠ¶æ…‹
  const [searchQuery, setSearchQuery] = useState('');
  const [showProductSearch, setShowProductSearch] = useState(false);
  const [includeHidden, setIncludeHidden] = useState(true); // ç®¡ç†ç”»é¢ã§ã¯éè¡¨ç¤ºå•†å“ã‚‚è¡¨ç¤º

  // æ¤œç´¢çµæœã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const filteredProducts = allProducts.filter(product => {
    const matchesSearch = product.display_name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                         (product.product_code && product.product_code.toLowerCase().includes(searchQuery.toLowerCase()));
    
    return matchesSearch && !formData.selected_products.includes(product.id);
  });

  // é¸æŠã•ã‚ŒãŸå•†å“ã®è©³ç´°ã‚’å–å¾—
  const selectedProductDetails = allProducts.filter(product =>
    formData.selected_products.includes(product.id)
  );

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setLoading(true);
    try {
      // ãƒ—ãƒªã‚»ãƒƒãƒˆå–å¾—
      const presetsResponse = await fetch('/api/admin/presets');
      if (presetsResponse.ok) {
        const presetsData = await presetsResponse.json();
        setPresets(presetsData.data || []);
      }

      // å…¨å•†å“å–å¾—ï¼ˆéè¡¨ç¤ºå•†å“ã‚‚å«ã‚€ï¼‰
      const productsResponse = await fetch('/api/admin/products/all?includeHidden=true');
      if (productsResponse.ok) {
        const productsData = await productsResponse.json();
        setAllProducts(productsData.data || []);
      }
    } catch (error) {
      console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    } finally {
      setLoading(false);
    }
  };

  // çµ±åˆãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ
  const createFormPreset = async () => {
    if (!formData.preset_name.trim() || formData.selected_products.length === 0) {
      alert('ãƒ—ãƒªã‚»ãƒƒãƒˆåã¨å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    setIsCreating(true);
    try {
      const response = await fetch('/api/admin/presets/create-complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      const result = await response.json();

      if (response.ok && result.success) {
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        setFormData({
          preset_name: '',
          selected_products: [],
          form_settings: {
            show_price: true,
            require_phone: true,
            require_furigana: false,
            allow_note: true
          }
        });
        
        // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
        await loadData();
        
        alert(`ãƒ•ã‚©ãƒ¼ãƒ ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼\nãƒ—ãƒªã‚»ãƒƒãƒˆID: ${result.data.preset_id}\nãƒ•ã‚©ãƒ¼ãƒ URL: ${result.data.form_url}`);
      } else {
        throw new Error(result.error || 'ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
      const errorMessage = error instanceof Error ? error.message : 'ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
      alert(`ã‚¨ãƒ©ãƒ¼: ${errorMessage}`);
    } finally {
      setIsCreating(false);
    }
  };

  // å•†å“ã‚’é¸æŠã«è¿½åŠ 
  const addProductToSelection = (productId: number) => {
    if (!formData.selected_products.includes(productId)) {
      setFormData(prev => ({
        ...prev,
        selected_products: [...prev.selected_products, productId]
      }));
    }
    setSearchQuery('');
    setShowProductSearch(false);
  };

  // é¸æŠã‹ã‚‰å•†å“ã‚’å‰Šé™¤
  const removeProductFromSelection = (productId: number) => {
    setFormData(prev => ({
      ...prev,
      selected_products: prev.selected_products.filter(id => id !== productId)
    }));
  };

  // ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã®åˆ‡ã‚Šæ›¿ãˆ
  const toggleFormSetting = (key: keyof FormCreationData['form_settings']) => {
    setFormData(prev => ({
      ...prev,
      form_settings: {
        ...prev.form_settings,
        [key]: !prev.form_settings[key]
      }
    }));
  };

  if (loading) {
    return (
      <AdminLayout title="ãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†" description="æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç°¡å˜ã«ä½œæˆã§ãã¾ã™">
        <div className="text-center py-8">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </AdminLayout>
    );
  }

  return (
    <ErrorBoundary>
      <AdminLayout title="ãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†" description="æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç°¡å˜ã«ä½œæˆã§ãã¾ã™">
        <div className="space-y-8">
          {/* çµ±åˆãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ */}
          <div className="bg-white shadow rounded-lg">
            <div className="px-4 py-5 sm:p-6">
              <h3 className="text-lg font-medium text-gray-900 mb-6">æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ</h3>
              
              <div className="space-y-6">
                {/* ãƒ—ãƒªã‚»ãƒƒãƒˆå */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ãƒ—ãƒªã‚»ãƒƒãƒˆå
                  </label>
                  <input
                    type="text"
                    value={formData.preset_name}
                    onChange={(e) => setFormData(prev => ({...prev, preset_name: e.target.value}))}
                    placeholder="ä¾‹: é‡èœã‚»ãƒƒãƒˆäºˆç´„ãƒ•ã‚©ãƒ¼ãƒ "
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>

                {/* å•†å“é¸æŠ */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    å•†å“é¸æŠ
                  </label>
                  
                  {/* é¸æŠæ¸ˆã¿å•†å“ */}
                  {selectedProductDetails.length > 0 && (
                    <div className="mb-3 space-y-2">
                      {selectedProductDetails.map((product) => (
                        <div key={product.id} className="flex items-center justify-between bg-blue-50 p-3 rounded-md">
                          <div className="flex-1">
                            <div className="flex items-center space-x-2">
                              <span className="font-medium">{product.display_name}</span>
                              <span className="text-sm text-gray-600">Â¥{product.price.toLocaleString()}</span>
                              <span className={`text-xs px-2 py-1 rounded ${
                                product.visible 
                                  ? 'bg-green-100 text-green-800' 
                                  : 'bg-red-100 text-red-800'
                              }`}>
                                {product.status_label}
                              </span>
                            </div>
                            {product.product_code && (
                              <div className="text-xs text-gray-500 mt-1">
                                å•†å“ã‚³ãƒ¼ãƒ‰: {product.product_code}
                              </div>
                            )}
                          </div>
                          <button
                            onClick={() => removeProductFromSelection(product.id)}
                            className="text-red-600 hover:text-red-800 text-sm ml-2"
                          >
                            å‰Šé™¤
                          </button>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* å•†å“æ¤œç´¢ãƒ»è¿½åŠ  */}
                  <div className="relative">
                    <input
                      type="text"
                      value={searchQuery}
                      onChange={(e) => {
                        setSearchQuery(e.target.value);
                        setShowProductSearch(e.target.value.length > 0);
                      }}
                      onFocus={() => setShowProductSearch(searchQuery.length > 0)}
                      placeholder="å•†å“åãƒ»å•†å“ã‚³ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦è¿½åŠ ..."
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    
                    {/* æ¤œç´¢çµæœãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */}
                    {showProductSearch && filteredProducts.length > 0 && (
                      <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                        {filteredProducts.slice(0, 20).map((product) => (
                          <button
                            key={product.id}
                            onClick={() => addProductToSelection(product.id)}
                            className="w-full text-left px-3 py-3 hover:bg-gray-100 border-b border-gray-100 last:border-b-0"
                          >
                            <div className="flex justify-between items-start">
                              <div className="flex-1">
                                <div className="flex items-center space-x-2">
                                  <span className="font-medium">{product.display_name}</span>
                                  <span className={`text-xs px-2 py-1 rounded ${
                                    product.visible 
                                      ? 'bg-green-100 text-green-800' 
                                      : 'bg-red-100 text-red-800'
                                  }`}>
                                    {product.status_label}
                                  </span>
                                </div>
                                {product.product_code && (
                                  <div className="text-xs text-gray-500 mt-1">
                                    å•†å“ã‚³ãƒ¼ãƒ‰: {product.product_code}
                                  </div>
                                )}
                              </div>
                              <span className="text-sm text-gray-600 ml-2">Â¥{product.price.toLocaleString()}</span>
                            </div>
                          </button>
                        ))}
                        {filteredProducts.length > 20 && (
                          <div className="px-3 py-2 text-sm text-gray-500 bg-gray-50">
                            ä»– {filteredProducts.length - 20} ä»¶...ï¼ˆæ¤œç´¢æ¡ä»¶ã‚’çµã‚Šè¾¼ã‚“ã§ãã ã•ã„ï¼‰
                          </div>
                        )}
                      </div>
                    )}
                    
                    {showProductSearch && searchQuery.length > 0 && filteredProducts.length === 0 && (
                      <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg p-3">
                        <p className="text-gray-500 text-sm">è©²å½“ã™ã‚‹å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>
                      </div>
                    )}
                  </div>
                  
                  <div className="text-sm text-gray-500 mt-2">
                    ğŸ’¡ éè¡¨ç¤ºã®å•†å“ã‚‚é¸æŠå¯èƒ½ã§ã™ã€‚é¸æŠå¾Œã«ãƒ•ã‚©ãƒ¼ãƒ ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                  </div>
                </div>

                {/* ãƒ•ã‚©ãƒ¼ãƒ è¨­å®š */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-3">
                    ãƒ•ã‚©ãƒ¼ãƒ è¨­å®š
                  </label>
                  <div className="space-y-3">
                    <label className="flex items-center">
                      <input
                        type="checkbox"
                        checked={formData.form_settings.show_price}
                        onChange={() => toggleFormSetting('show_price')}
                        className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                      />
                      <span className="ml-2 text-sm text-gray-700">ä¾¡æ ¼ã‚’è¡¨ç¤ºã™ã‚‹</span>
                    </label>
                    <label className="flex items-center">
                      <input
                        type="checkbox"
                        checked={formData.form_settings.require_phone}
                        onChange={() => toggleFormSetting('require_phone')}
                        className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                      />
                      <span className="ml-2 text-sm text-gray-700">é›»è©±ç•ªå·ã‚’å¿…é ˆã«ã™ã‚‹</span>
                    </label>
                    <label className="flex items-center">
                      <input
                        type="checkbox"
                        checked={formData.form_settings.require_furigana}
                        onChange={() => toggleFormSetting('require_furigana')}
                        className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                      />
                      <span className="ml-2 text-sm text-gray-700">ãµã‚ŠãŒãªã‚’å¿…é ˆã«ã™ã‚‹</span>
                    </label>
                    <label className="flex items-center">
                      <input
                        type="checkbox"
                        checked={formData.form_settings.allow_note}
                        onChange={() => toggleFormSetting('allow_note')}
                        className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                      />
                      <span className="ml-2 text-sm text-gray-700">å‚™è€ƒæ¬„ã‚’è¡¨ç¤ºã™ã‚‹</span>
                    </label>
                  </div>
                </div>

                {/* ä½œæˆãƒœã‚¿ãƒ³ */}
                <div className="flex space-x-4">
                  <button
                    onClick={createFormPreset}
                    disabled={isCreating || !formData.preset_name.trim() || formData.selected_products.length === 0}
                    className="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {isCreating ? 'ä½œæˆä¸­...' : 'ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆ'}
                  </button>
                  <button
                    onClick={() => {
                      setFormData({
                        preset_name: '',
                        selected_products: [],
                        form_settings: {
                          show_price: true,
                          require_phone: true,
                          require_furigana: false,
                          allow_note: true
                        }
                      });
                      setSearchQuery('');
                      setShowProductSearch(false);
                    }}
                    className="bg-gray-300 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-400"
                  >
                    ãƒªã‚»ãƒƒãƒˆ
                  </button>
                </div>
              </div>
            </div>
          </div>

          {/* æ—¢å­˜ã®ãƒ—ãƒªã‚»ãƒƒãƒˆä¸€è¦§ */}
          <div className="bg-white shadow rounded-lg">
            <div className="px-4 py-5 sm:p-6">
              <h3 className="text-lg font-medium text-gray-900 mb-4">æ—¢å­˜ã®ãƒ•ã‚©ãƒ¼ãƒ </h3>
              <div className="space-y-2">
                {presets.map((preset) => (
                  <div key={preset.id} className="flex justify-between items-center p-3 border border-gray-200 rounded-md">
                    <div>
                      <span className="font-medium">{preset.preset_name}</span>
                      <span className="ml-2 text-sm text-gray-500">ID: {preset.id}</span>
                    </div>
                    <div className="text-sm text-gray-500">
                      {new Date(preset.created_at).toLocaleDateString('ja-JP')}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      </AdminLayout>
    </ErrorBoundary>
  );
}
```

### 3. å•†å“ç®¡ç†æ©Ÿèƒ½ã®å¼·åŒ–

#### 3.1 å•†å“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†APIã®å®Ÿè£…
**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/app/api/admin/products/[productId]/status/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { supabaseAdmin } from '@/lib/supabase';

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ productId: string }> }
) {
  try {
    if (!supabaseAdmin) {
      return NextResponse.json(
        { error: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãŒåˆ©ç”¨ã§ãã¾ã›ã‚“' },
        { status: 500 }
      );
    }

    const { productId } = await params;
    const { visible } = await request.json();

    const { data: product, error } = await supabaseAdmin
      .from('products')
      .update({ 
        visible: visible,
        updated_at: new Date().toISOString()
      })
      .eq('id', productId)
      .select()
      .single();

    if (error) {
      console.error('å•†å“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      throw error;
    }

    return NextResponse.json({
      success: true,
      data: product
    });

  } catch (error) {
    console.error('å•†å“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { 
        success: false,
        error: error instanceof Error ? error.message : 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' 
      },
      { status: 500 }
    );
  }
}
```

## ä¿®æ­£æ‰‹é †

### Phase 1: ç·Šæ€¥ä¿®æ­£ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼å¯¾å¿œï¼‰
1. âœ… ErrorBoundaryã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ
2. âœ… ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«ã‚¨ãƒ©ãƒ¼å¢ƒç•Œè¿½åŠ 
3. âœ… å„ãƒšãƒ¼ã‚¸ã«ã‚¨ãƒ©ãƒ¼å¢ƒç•Œè¿½åŠ 

### Phase 2: å•†å“é¸æŠæ©Ÿèƒ½æ”¹å–„
1. âœ… å…¨å•†å“å–å¾—APIå®Ÿè£…
2. âœ… ç®¡ç†ç”»é¢ã®å•†å“é¸æŠUIæ”¹å–„
3. âœ… éè¡¨ç¤ºå•†å“ã‚‚é¸æŠå¯èƒ½ã«å¤‰æ›´

### Phase 3: å•†å“ç®¡ç†å¼·åŒ–
1. å•†å“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†APIå®Ÿè£…
2. å•†å“ä¸€è¦§ã§ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½

## ãƒ†ã‚¹ãƒˆé …ç›®

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼å¯¾å¿œ
- [ ] ã‚¨ãƒ©ãƒ¼å¢ƒç•ŒãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«é©åˆ‡ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º
- [ ] å†è©¦è¡Œæ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹

### å•†å“é¸æŠæ©Ÿèƒ½
- [ ] å…¨å•†å“ï¼ˆéè¡¨ç¤ºå«ã‚€ï¼‰ãŒæ¤œç´¢ã§ãã‚‹
- [ ] éè¡¨ç¤ºå•†å“ã‚‚é¸æŠã§ãã‚‹
- [ ] å•†å“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒè¦–è¦šçš„ã«åˆ†ã‹ã‚‹
- [ ] æ¤œç´¢çµæœãŒé©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹

## å®Œäº†åŸºæº–

1. âœ… ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã•ã‚Œã‚‹
2. âœ… éè¡¨ç¤ºå•†å“ã‚‚é¸æŠå¯èƒ½ã«ãªã‚‹
3. âœ… å•†å“æ¤œç´¢ãŒå…¨å•†å“ã‹ã‚‰å®Ÿè¡Œã§ãã‚‹
4. âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã‚‹
5. âœ… ç®¡ç†ç”»é¢ã§ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãŒå®Œäº†ã™ã‚‹

## æ³¨æ„äº‹é …

- ã‚¨ãƒ©ãƒ¼å¢ƒç•Œã¯å„ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«é…ç½®
- å•†å“é¸æŠæ™‚ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ˜ç¢ºã«ã™ã‚‹
- æ¤œç´¢ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è€ƒæ…®ã—ãŸå®Ÿè£…
- æœ¬ç•ªç’°å¢ƒã§ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°åé›†ã‚’æ¤œè¨
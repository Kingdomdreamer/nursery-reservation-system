# 🌱 種苗店予約システム 包括仕様書 v2.0

## 📋 概要

本システムは種苗店向けの商品予約システムです。LINEとの連携により、お客様が簡単に種苗や園芸用品の予約・注文ができる環境を提供し、種苗店の販売業務をサポートします。

## 🎯 システム目標

### 1. 顧客体験の向上
- LINE連携による簡単な予約フロー
- 直感的で使いやすいUI/UX
- モバイルファーストなレスポンシブデザイン

### 2. 店舗運営の効率化
- 自動化された予約管理
- リアルタイムな在庫管理
- 効率的な顧客情報管理

### 3. 販売サポート
- 包括的な管理機能
- データ分析とレポート機能
- 柔軟なフォーム作成機能

## 🗄️ データベース設計

### 1. 顧客管理（customers）
```sql
CREATE TABLE customers (
  id           UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  full_name    VARCHAR(100) NOT NULL,
  phone        VARCHAR(15)  NOT NULL,
  email        VARCHAR(255),
  postal_code  VARCHAR(8),
  address      TEXT,
  line_user_id VARCHAR(50),
  created_at   TIMESTAMPTZ DEFAULT NOW(),
  updated_at   TIMESTAMPTZ DEFAULT NOW()
);
```

**主要機能:**
- 顧客基本情報の管理
- LINE連携による顧客識別
- 住所情報の統合管理

### 2. 商品カテゴリ管理（product_categories）
```sql
CREATE TABLE product_categories (
  id         UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  name       VARCHAR(100) NOT NULL,
  description TEXT,
  parent_id  UUID    REFERENCES product_categories(id),
  sort_order INTEGER DEFAULT 0,
  is_active  BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**主要機能:**
- 階層構造対応のカテゴリ管理
- 表示順序制御
- アクティブ状態管理

### 3. 商品管理（products）
```sql
CREATE TABLE products (
  id                 UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  name               VARCHAR(200) NOT NULL,
  description        TEXT,
  price              DECIMAL(10,2) NOT NULL DEFAULT 0,
  category_id        UUID    REFERENCES product_categories(id),
  unit               VARCHAR(20),
  min_order_quantity INTEGER DEFAULT 1,
  max_order_quantity INTEGER,
  variation_name     VARCHAR(100),
  image_url          TEXT,
  barcode            VARCHAR(50),
  tax_type           VARCHAR(20) DEFAULT 'inclusive',
  is_available       BOOLEAN DEFAULT true,
  display_order      INTEGER DEFAULT 0,
  created_at         TIMESTAMPTZ DEFAULT NOW(),
  updated_at         TIMESTAMPTZ DEFAULT NOW()
);
```

**主要機能:**
- 商品詳細情報管理
- 在庫状況管理
- バリエーション対応
- 税込・税抜き価格対応

### 4. 予約管理（reservations）
```sql
CREATE TABLE reservations (
  id                   UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  reservation_number   VARCHAR(20) NOT NULL UNIQUE,
  customer_id          UUID    NOT NULL REFERENCES customers(id),
  reservation_date     DATE    NOT NULL,
  pickup_time_start    TIME    NOT NULL,
  pickup_time_end      TIME    NOT NULL,
  status               VARCHAR(20) DEFAULT 'pending',
  payment_status       VARCHAR(20) DEFAULT 'unpaid',
  total_amount         DECIMAL(10,2) NOT NULL DEFAULT 0,
  discount_amount      DECIMAL(10,2) DEFAULT 0,
  final_amount         DECIMAL(10,2) NOT NULL DEFAULT 0,
  notes                TEXT,
  admin_notes          TEXT,
  confirmation_sent_at TIMESTAMPTZ,
  reminder_sent_at     TIMESTAMPTZ,
  created_at           TIMESTAMPTZ DEFAULT NOW(),
  updated_at           TIMESTAMPTZ DEFAULT NOW()
);
```

**主要機能:**
- 予約基本情報管理
- ステータス管理（pending/confirmed/ready/completed/cancelled）
- 支払い状況管理
- 確認・リマインダー送信管理

### 5. 予約商品明細（reservation_items）
```sql
CREATE TABLE reservation_items (
  id             UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  reservation_id UUID    NOT NULL REFERENCES reservations(id) ON DELETE CASCADE,
  product_id     UUID    NOT NULL REFERENCES products(id),
  quantity       INTEGER NOT NULL CHECK (quantity > 0),
  unit_price     DECIMAL(10,2) NOT NULL,
  subtotal       DECIMAL(10,2) NOT NULL,
  pickup_date    DATE    NOT NULL,
  created_at     TIMESTAMPTZ DEFAULT NOW(),
  updated_at     TIMESTAMPTZ DEFAULT NOW()
);
```

**主要機能:**
- 予約商品詳細管理
- 数量・単価・小計管理
- 商品別受取日管理

### 6. フォーム管理（forms）
```sql
CREATE TABLE forms (
  id         UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  name       VARCHAR(100) NOT NULL,
  description TEXT,
  is_active  BOOLEAN DEFAULT true,
  valid_from TIMESTAMPTZ,
  valid_to   TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**主要機能:**
- フォーム基本情報管理
- 有効期間設定
- アクティブ状態管理

### 7. フォーム設定（form_configurations）
```sql
CREATE TABLE form_configurations (
  id          UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  form_id     UUID    NOT NULL REFERENCES forms(id) ON DELETE CASCADE,
  name        VARCHAR(100) NOT NULL,
  description TEXT,
  form_fields JSONB   NOT NULL DEFAULT '[]',
  settings    JSONB   DEFAULT '{}',
  is_active   BOOLEAN DEFAULT true,
  valid_from  TIMESTAMPTZ,
  valid_to    TIMESTAMPTZ,
  version     INTEGER DEFAULT 1,
  created_at  TIMESTAMPTZ DEFAULT NOW(),
  updated_at  TIMESTAMPTZ DEFAULT NOW()
);
```

**主要機能:**
- フォーム詳細設定管理
- バージョン管理
- フィールド設定（JSON形式）

### 8. フォームフィールド（form_fields）
```sql
CREATE TABLE form_fields (
  id               UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  form_id          UUID    NOT NULL REFERENCES forms(id) ON DELETE CASCADE,
  field_type       VARCHAR(50)  NOT NULL,
  field_name       VARCHAR(100) NOT NULL,
  field_label      VARCHAR(200) NOT NULL,
  field_options    JSONB   DEFAULT '[]',
  is_required      BOOLEAN DEFAULT false,
  validation_rules JSONB   DEFAULT '{}',
  display_order    INTEGER DEFAULT 0,
  created_at       TIMESTAMPTZ DEFAULT NOW(),
  updated_at       TIMESTAMPTZ DEFAULT NOW()
);
```

**主要機能:**
- フォームフィールド詳細管理
- バリデーションルール設定
- 表示順序制御

### 9. フォーム商品関連（form_products）
```sql
CREATE TABLE form_products (
  id            UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  form_id       UUID    NOT NULL REFERENCES forms(id) ON DELETE CASCADE,
  product_id    UUID    NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  display_order INTEGER DEFAULT 0,
  is_required   BOOLEAN DEFAULT false,
  max_quantity  INTEGER,
  created_at    TIMESTAMPTZ DEFAULT NOW(),
  updated_at    TIMESTAMPTZ DEFAULT NOW()
);
```

**主要機能:**
- フォームと商品の関連付け
- 商品表示順序制御
- 最大数量制限設定

### 10. フォーム表示設定（form_display_settings）
```sql
CREATE TABLE form_display_settings (
  id                  UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  form_id             UUID    NOT NULL REFERENCES forms(id) ON DELETE CASCADE,
  show_prices         BOOLEAN DEFAULT true,
  price_display_mode  VARCHAR(20) DEFAULT 'full',
  show_categories     BOOLEAN DEFAULT true,
  show_descriptions   BOOLEAN DEFAULT true,
  custom_css          TEXT,
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW()
);
```

**主要機能:**
- フォーム表示カスタマイズ
- 価格表示設定
- カスタムCSS対応

### 11. 価格表示設定（pricing_display_settings）
```sql
CREATE TABLE pricing_display_settings (
  id                   UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  form_id              UUID    NOT NULL REFERENCES forms(id) ON DELETE CASCADE,
  show_item_prices     BOOLEAN DEFAULT true,
  show_subtotals       BOOLEAN DEFAULT true,
  show_total           BOOLEAN DEFAULT true,
  show_tax_breakdown   BOOLEAN DEFAULT false,
  price_format         VARCHAR(20) DEFAULT 'currency',
  created_at           TIMESTAMPTZ DEFAULT NOW(),
  updated_at           TIMESTAMPTZ DEFAULT NOW()
);
```

**主要機能:**
- 詳細な価格表示制御
- 税額表示制御
- 価格フォーマット設定

### 12. 通知管理（notifications）
```sql
CREATE TABLE notifications (
  id         UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id    UUID    REFERENCES user_profiles(id),
  type       VARCHAR(50) NOT NULL,
  title      VARCHAR(200) NOT NULL,
  message    TEXT    NOT NULL,
  action_url TEXT,
  is_read    BOOLEAN DEFAULT false,
  priority   VARCHAR(20) DEFAULT 'normal',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**主要機能:**
- システム通知管理
- 優先度設定
- 既読状態管理

### 13. システム設定（system_settings）
```sql
CREATE TABLE system_settings (
  id          UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  category    VARCHAR(50) NOT NULL,
  key         VARCHAR(100) NOT NULL,
  value       JSONB   NOT NULL DEFAULT '{}',
  description TEXT,
  is_active   BOOLEAN DEFAULT true,
  created_at  TIMESTAMPTZ DEFAULT NOW(),
  updated_at  TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(category, key)
);
```

**主要機能:**
- システム全体設定管理
- カテゴリ別設定管理
- JSON形式での柔軟な設定値

### 14. ユーザープロファイル（user_profiles）
```sql
CREATE TABLE user_profiles (
  id            UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id       UUID    NOT NULL REFERENCES auth.users(id),
  role          VARCHAR(20) DEFAULT 'admin',
  full_name     VARCHAR(100),
  email         VARCHAR(255),
  phone         VARCHAR(15),
  is_active     BOOLEAN DEFAULT true,
  last_login_at TIMESTAMPTZ,
  created_at    TIMESTAMPTZ DEFAULT NOW(),
  updated_at    TIMESTAMPTZ DEFAULT NOW()
);
```

**主要機能:**
- 管理者アカウント管理
- ロール管理
- ログイン履歴管理

### 15. LINEテンプレート（line_templates）
```sql
CREATE TABLE line_templates (
  id               UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  template_type    VARCHAR(50) NOT NULL,
  template_name    VARCHAR(100) NOT NULL,
  template_content TEXT    NOT NULL,
  is_active        BOOLEAN DEFAULT true,
  created_at       TIMESTAMPTZ DEFAULT NOW(),
  updated_at       TIMESTAMPTZ DEFAULT NOW()
);
```

**主要機能:**
- LINE配信テンプレート管理
- テンプレートタイプ別管理
- アクティブ状態管理

### 16. エクスポート履歴（export_history）
```sql
CREATE TABLE export_history (
  id           UUID    PRIMARY KEY DEFAULT gen_random_uuid(),
  export_type  VARCHAR(50) NOT NULL,
  exported_by  UUID    REFERENCES user_profiles(id),
  file_name    VARCHAR(255),
  file_size    INTEGER,
  status       VARCHAR(20) DEFAULT 'pending',
  download_url TEXT,
  exported_at  TIMESTAMPTZ DEFAULT NOW(),
  expires_at   TIMESTAMPTZ
);
```

**主要機能:**
- データエクスポート履歴管理
- ファイル管理
- ダウンロードURL管理

## 🔧 主要機能

### 1. 顧客向け機能

#### A. LINE連携予約システム
- **LINE Login**: ワンタップログイン
- **プロフィール自動入力**: LINE情報の自動反映
- **予約フォーム**: 直感的な予約インターフェース
- **予約確認**: リアルタイム予約状況確認

#### B. 商品選択・注文
- **商品カタログ**: カテゴリ別商品表示
- **詳細検索**: 価格・カテゴリ・在庫での絞り込み
- **カート機能**: 複数商品の一括予約
- **価格計算**: 税込み価格・割引の自動計算

#### C. 予約管理
- **予約履歴**: 過去の予約記録参照
- **受取日時設定**: 柔軟な受取日時指定
- **変更・キャンセル**: 簡単な予約変更機能

### 2. 管理者機能

#### A. 予約管理
- **予約一覧**: 全予約の一元管理
- **ステータス管理**: 予約状況の更新
- **顧客情報**: 詳細な顧客情報管理
- **売上管理**: 売上データ分析

#### B. 商品管理
- **商品登録**: 商品情報の詳細登録
- **在庫管理**: リアルタイム在庫追跡
- **カテゴリ管理**: 階層構造対応カテゴリ
- **価格管理**: 柔軟な価格設定

#### C. フォーム管理
- **フォーム作成**: 動的フォーム作成機能
- **フィールド設定**: 詳細なフィールド設定
- **デザイン設定**: カスタムCSS対応
- **公開設定**: 期間限定公開機能

#### D. 通知・配信管理
- **LINE配信**: 自動・手動配信機能
- **テンプレート管理**: 配信テンプレート管理
- **通知設定**: システム通知管理

### 3. システム機能

#### A. 認証・セキュリティ
- **Supabase Auth**: セキュアな認証システム
- **RLS (Row Level Security)**: データアクセス制御
- **API制限**: レート制限・アクセス制御

#### B. データ管理
- **自動バックアップ**: 定期的なデータバックアップ
- **データエクスポート**: CSV・Excel形式でのエクスポート
- **ログ管理**: 操作ログ・エラーログ管理

#### C. パフォーマンス
- **インデックス最適化**: 高速データ検索
- **キャッシュ戦略**: レスポンス時間短縮
- **CDN配信**: 静的ファイルの高速配信

## 🚀 技術スタック

### フロントエンド
- **Next.js 14**: React フレームワーク
- **TypeScript**: 型安全なJavaScript
- **Tailwind CSS**: ユーティリティファーストCSS
- **React Hook Form**: フォーム管理
- **Chart.js**: データ可視化

### バックエンド
- **Supabase**: BaaS（Database + Auth + Storage）
- **PostgreSQL**: メインデータベース
- **Edge Functions**: サーバーレス関数

### 外部連携
- **LINE Messaging API**: LINE連携
- **LINE Login**: ソーシャルログイン
- **LIFF**: LINE内ブラウザアプリ

### インフラ
- **Vercel**: ホスティング・デプロイ
- **Supabase**: データベース・認証
- **Cloudflare**: CDN・セキュリティ

## 📱 レスポンシブ対応

### デバイス対応
- **スマートフォン**: 320px〜768px
- **タブレット**: 768px〜1024px
- **デスクトップ**: 1024px〜

### 最適化項目
- **タッチ操作**: タップ・スワイプ対応
- **フォント調整**: デバイス別最適化
- **画像最適化**: Next.js Image最適化
- **レイアウト**: Flexbox・Grid対応

## 🔒 セキュリティ対策

### 認証・認可
- **JWT認証**: Supabaseベースの安全な認証
- **Role-based Access**: ロールベースアクセス制御
- **Session管理**: 自動セッション管理

### データ保護
- **Row Level Security**: データ行レベルセキュリティ
- **暗号化**: 機密データの暗号化
- **アクセスログ**: 詳細なアクセス記録

### API セキュリティ
- **Rate Limiting**: API使用量制限
- **CORS設定**: クロスオリジン制御
- **入力検証**: 包括的な入力値検証

## 📊 監視・運用

### パフォーマンス監視
- **レスポンス時間**: API応答時間監視
- **エラー率**: エラー発生率追跡
- **ユーザー体験**: Core Web Vitals

### ログ管理
- **アプリケーションログ**: 詳細な操作ログ
- **エラーログ**: エラー情報・スタックトレース
- **監査ログ**: セキュリティ関連ログ

### バックアップ・復旧
- **自動バックアップ**: 日次データバックアップ
- **ポイントインタイム復旧**: 時点復旧機能
- **災害復旧**: 障害時復旧手順

## 🌟 今後の拡張予定

### Phase 1: 分析機能強化
- 顧客行動分析
- 売上分析レポート
- 在庫最適化提案

### Phase 2: マーケティング自動化
- 自動配信システム
- セグメント別配信
- パーソナライゼーション

### Phase 3: AI活用
- 需要予測
- レコメンデーション
- チャットボット

---

**作成日**: 2025年7月19日  
**バージョン**: 2.0  
**最終更新**: 2025年7月19日  
**対象システム**: 保育園・種苗店予約システム
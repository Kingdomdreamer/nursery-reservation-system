# ç·Šæ€¥ä¿®æ­£æŒ‡ç¤ºæ›¸ - å•†å“è¿½åŠ å¾Œãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºå•é¡Œ

## å•é¡Œæ¦‚è¦

### ğŸš¨ **ç—‡çŠ¶**
- ç®¡ç†ç”»é¢ã§å•†å“ã‚’è¿½åŠ ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆå®Œäº†
- ãƒ•ã‚©ãƒ¼ãƒ ç”»é¢ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆ4ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨å•†å“ãŒ0ä»¶
- React Error #310ãŒç™ºç”Ÿã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ãƒƒã‚·ãƒ¥

### ğŸ“Š **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°åˆ†æ**
```
[useFormConfig] API result: {success: true, productsCount: 0, formSettingsExists: true, presetExists: true}
[ProductSelection] Products array is empty
React Error #310 (useMemo)
```

### ğŸ” **æ ¹æœ¬åŸå› ã®ç‰¹å®š**

#### **åŸå› 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£ä»˜ã‘ã®å•é¡Œ**
ç®¡ç†ç”»é¢ã§å•†å“ã‚’è¿½åŠ ã—ã¦ã‚‚ã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ­£ã—ãé–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ãªã„å¯èƒ½æ€§

#### **åŸå› 2: APIå–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã®å•é¡Œ**
ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®šAPIãŒå•†å“ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ãå–å¾—ãƒ»æ•´å½¢ã§ãã¦ã„ãªã„

#### **åŸå› 3: ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ä¸æ•´åˆ**
`preset_products`ã¨`pickup_windows`ã®é–¢é€£ä»˜ã‘ã«å•é¡ŒãŒã‚ã‚‹

## ğŸ”§ **ç·Šæ€¥ä¿®æ­£å†…å®¹**

### Step 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ã®ç¢ºèª

#### **1.1 ãƒ—ãƒªã‚»ãƒƒãƒˆ4ã®å•†å“é–¢é€£ä»˜ã‘ç¢ºèª**
```sql
-- ãƒ—ãƒªã‚»ãƒƒãƒˆ4ã®åŸºæœ¬æƒ…å ±
SELECT * FROM product_presets WHERE id = 4;

-- ãƒ—ãƒªã‚»ãƒƒãƒˆ4ã®å•†å“é–¢é€£ä»˜ã‘
SELECT 
  pp.id,
  pp.preset_id,
  pp.product_id,
  pp.display_order,
  pp.is_active,
  p.name as product_name,
  p.visible,
  p.price
FROM preset_products pp
LEFT JOIN products p ON pp.product_id = p.id
WHERE pp.preset_id = 4
ORDER BY pp.display_order;

-- ãƒ—ãƒªã‚»ãƒƒãƒˆ4ã®å¼•ãå–ã‚ŠæœŸé–“
SELECT 
  pw.id,
  pw.preset_id,
  pw.product_id,
  p.name as product_name,
  pw.pickup_start,
  pw.pickup_end
FROM pickup_windows pw
LEFT JOIN products p ON pw.product_id = p.id
WHERE pw.preset_id = 4;

-- ãƒ—ãƒªã‚»ãƒƒãƒˆ4ã®ãƒ•ã‚©ãƒ¼ãƒ è¨­å®š
SELECT * FROM form_settings WHERE preset_id = 4;
```

### Step 2: APIä¿®æ­£

#### **2.1 ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®šAPI ã®å•†å“å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£**
**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/app/api/presets/[presetId]/config/route.ts`

```typescript
// æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã«ç½®ãæ›ãˆ

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ presetId: string }> }
) {
  try {
    const { presetId } = await params;
    const id = Number(presetId);

    if (!Number.isInteger(id) || id < 1) {
      throw new InvalidPresetIdError(presetId);
    }

    console.log(`[Config API] Fetching config for preset: ${id}`);

    if (!supabaseAdmin) {
      throw new Error('Database connection unavailable');
    }

    // 1. ãƒ—ãƒªã‚»ãƒƒãƒˆåŸºæœ¬æƒ…å ±ã®å–å¾—
    const { data: presetData, error: presetError } = await supabaseAdmin
      .from('product_presets')
      .select('*')
      .eq('id', id)
      .single();

    if (presetError || !presetData) {
      console.error('[Config API] Preset not found:', presetError);
      throw new PresetNotFoundError(id);
    }

    // 2. ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã®å–å¾—
    const { data: formSettings, error: formError } = await supabaseAdmin
      .from('form_settings')
      .select('*')
      .eq('preset_id', id);

    if (formError) {
      console.error('[Config API] Form settings error:', formError);
    }

    // 3. ãƒ—ãƒªã‚»ãƒƒãƒˆå•†å“ã®å–å¾—ï¼ˆå•†å“æƒ…å ±ã‚‚å«ã‚€ï¼‰
    const { data: presetProducts, error: presetProductsError } = await supabaseAdmin
      .from('preset_products')
      .select(`
        id,
        preset_id,
        product_id,
        display_order,
        is_active,
        created_at,
        updated_at,
        product:products (
          id,
          name,
          price,
          category_id,
          visible,
          base_product_name,
          variation_name,
          product_code,
          created_at,
          updated_at
        )
      `)
      .eq('preset_id', id)
      .eq('is_active', true)
      .order('display_order');

    if (presetProductsError) {
      console.error('[Config API] Preset products error:', presetProductsError);
    }

    // 4. å¼•ãå–ã‚ŠæœŸé–“ã®å–å¾—
    const { data: pickupWindows, error: pickupError } = await supabaseAdmin
      .from('pickup_windows')
      .select('*')
      .eq('preset_id', id);

    if (pickupError) {
      console.error('[Config API] Pickup windows error:', pickupError);
    }

    // 5. ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªå‡¦ç†ã¨æ¤œè¨¼
    const safePresetProducts = (presetProducts || []).filter(pp => {
      if (!pp || !pp.product) {
        console.warn(`[Config API] Invalid preset product:`, pp);
        return false;
      }
      
      const product = pp.product;
      if (!product.id || !product.name) {
        console.warn(`[Config API] Invalid product data:`, product);
        return false;
      }
      
      return true;
    });

    // 6. å•†å“ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡º
    const products = safePresetProducts.map(pp => pp.product);

    // 7. ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®å‡ºåŠ›
    console.log(`[Config API] Data summary for preset ${id}:`, {
      preset_exists: !!presetData,
      form_settings_count: (formSettings || []).length,
      preset_products_count: safePresetProducts.length,
      products_count: products.length,
      pickup_windows_count: (pickupWindows || []).length,
      product_names: products.map(p => p.name)
    });

    // 8. å•†å“ãŒ0ä»¶ã®å ´åˆã®è©³ç´°ãƒ­ã‚°
    if (products.length === 0) {
      console.error(`[Config API] No products found for preset ${id}!`);
      console.error('[Config API] Raw preset_products data:', presetProducts);
      console.error('[Config API] This will cause React Error #310');
      
      // ç·Šæ€¥å›é¿: æœ€ä½é™ã®ãƒ€ãƒŸãƒ¼å•†å“ã‚’ä½œæˆ
      const dummyProduct = {
        id: 999999,
        name: 'å•†å“è¨­å®šã‚¨ãƒ©ãƒ¼ - ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„',
        price: 0,
        category_id: 1,
        visible: true,
        base_product_name: null,
        variation_name: null,
        product_code: null,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };
      
      products.push(dummyProduct);
      console.warn('[Config API] Added emergency dummy product to prevent crash');
    }

    // 9. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã®æ§‹ç¯‰
    const responseData: FormConfigResponse = {
      preset: presetData,
      form_settings: (formSettings && formSettings.length > 0) ? formSettings[0] : {
        id: 0,
        preset_id: id,
        show_price: true,
        require_phone: true,
        require_furigana: false,
        allow_note: true,
        is_enabled: true,
        custom_message: null,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      },
      products: products,
      pickup_windows: pickupWindows || [],
      preset_products: safePresetProducts
    };

    return createSuccessResponse(responseData, {
      presetId: id,
      totalProducts: products.length,
      totalPickupWindows: (pickupWindows || []).length,
      hasFormSettings: !!(formSettings && formSettings.length > 0)
    });

  } catch (error) {
    console.error('[Config API] Error:', error);
    return handleApiError(error);
  }
}
```

### Step 3: çµ±åˆãƒ•ã‚©ãƒ¼ãƒ ä½œæˆAPIã®ä¿®æ­£

#### **3.1 å•†å“é–¢é€£ä»˜ã‘ã®ç¢ºå®Ÿãªå®Ÿè¡Œ**
**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/app/api/admin/presets/create-complete/route.ts`

```typescript
// å•†å“é–¢é€£ä»˜ã‘éƒ¨åˆ†ã®ä¿®æ­£
const presetProducts = data.selected_products.map((productId, index) => ({
  preset_id: preset.id,
  product_id: productId,
  display_order: index + 1, // 1ã‹ã‚‰å§‹ã¾ã‚‹é€£ç•ª
  is_active: true,
  created_at: new Date().toISOString(),
  updated_at: new Date().toISOString()
}));

console.log(`[Create API] Creating preset products:`, presetProducts);

const { data: insertedProducts, error: productsError } = await supabaseAdmin
  .from('preset_products')
  .insert(presetProducts)
  .select(); // æŒ¿å…¥ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

if (productsError) {
  console.error('å•†å“é–¢é€£ä»˜ã‘ã‚¨ãƒ©ãƒ¼:', productsError);
  // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
  await supabaseAdmin.from('form_settings').delete().eq('preset_id', preset.id);
  await supabaseAdmin.from('product_presets').delete().eq('id', preset.id);
  throw new Error(`å•†å“é–¢é€£ä»˜ã‘ã«å¤±æ•—ã—ã¾ã—ãŸ: ${productsError.message}`);
}

console.log(`[Create API] Successfully inserted ${insertedProducts?.length || 0} preset products`);

// æŒ¿å…¥ç¢ºèª
const { data: verifyProducts, error: verifyError } = await supabaseAdmin
  .from('preset_products')
  .select('id, product_id, is_active')
  .eq('preset_id', preset.id);

if (verifyError) {
  console.error('å•†å“é–¢é€£ä»˜ã‘ç¢ºèªã‚¨ãƒ©ãƒ¼:', verifyError);
} else {
  console.log(`[Create API] Verification: ${verifyProducts?.length || 0} products linked to preset ${preset.id}`);
}
```

### Step 4: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã®å®‰å…¨æ€§å¼·åŒ–

#### **4.1 useFormConfig ã®ä¿®æ­£**
**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/hooks/useFormConfig.ts`

```typescript
const fetchFormConfig = useCallback(async () => {
  try {
    setLoading(true);
    setError(null);
    
    console.log(`[useFormConfig] Fetching config for preset: ${presetId} (attempt 1)`);
    
    const response = await fetch(`/api/presets/${presetId}/config`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    console.log('[useFormConfig] API result:', {
      success: result.success,
      hasData: !!result.data,
      productsCount: result.data?.products?.length || 0,
      formSettingsExists: !!result.data?.form_settings,
      presetExists: !!result.data?.preset
    });
    
    if (!result.success || !result.data) {
      throw new Error('Invalid API response structure');
    }
    
    const { data } = result;
    
    // å•†å“ãƒ‡ãƒ¼ã‚¿ã®å³å¯†ãªæ¤œè¨¼
    let validatedProducts = [];
    if (Array.isArray(data.products)) {
      validatedProducts = data.products.filter(product => {
        if (!product || typeof product !== 'object') {
          console.warn('[useFormConfig] Invalid product object:', product);
          return false;
        }
        
        if (!product.id || !product.name) {
          console.warn('[useFormConfig] Product missing required fields:', product);
          return false;
        }
        
        return true;
      });
    }
    
    console.log(`[useFormConfig] Validated ${validatedProducts.length} products`);
    
    // å•†å“ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã®è©³ç´°ãƒ­ã‚°
    if (validatedProducts.length === 0) {
      console.error(`[useFormConfig] CRITICAL: No products found for preset ${presetId}`);
      console.error('[useFormConfig] Raw API data:', data);
      console.error('[useFormConfig] This will cause React Error #310');
      
      // ç®¡ç†è€…å‘ã‘ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      setError(`ãƒ—ãƒªã‚»ãƒƒãƒˆ${presetId}ã«å•†å“ãŒé–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nç®¡ç†ç”»é¢ã§ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š\n1. ãƒ—ãƒªã‚»ãƒƒãƒˆã«å•†å“ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹\n2. å•†å“ãŒã€Œæœ‰åŠ¹ã€çŠ¶æ…‹ã«ãªã£ã¦ã„ã‚‹ã‹\n3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ•´åˆæ€§ã«å•é¡ŒãŒãªã„ã‹`);
      
      // ç©ºã®è¨­å®šã§åˆæœŸåŒ–ï¼ˆã‚¯ãƒ©ãƒƒã‚·ãƒ¥é˜²æ­¢ï¼‰
      setFormConfig({
        form_settings: data.form_settings || {
          show_price: true,
          require_phone: true,
          require_furigana: false,
          allow_note: true,
          is_enabled: true
        },
        products: [], // ç©ºé…åˆ—ã§å®‰å…¨ã«åˆæœŸåŒ–
        pickup_windows: data.pickup_windows || [],
        preset: data.preset || null,
        preset_products: data.preset_products || []
      });
      
      return; // æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
    }
    
    // æ­£å¸¸ãªå ´åˆã®è¨­å®š
    setFormConfig({
      form_settings: data.form_settings,
      products: validatedProducts,
      pickup_windows: data.pickup_windows || [],
      preset: data.preset,
      preset_products: data.preset_products || []
    });
    
  } catch (err) {
    console.error('[useFormConfig] Error:', err);
    setError(err instanceof Error ? err.message : 'Unknown error');
    
    // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
    setFormConfig({
      form_settings: {
        show_price: true,
        require_phone: true,
        require_furigana: false,
        allow_note: true,
        is_enabled: true
      },
      products: [], // ç©ºé…åˆ—ã§å®‰å…¨ã«åˆæœŸåŒ–
      pickup_windows: [],
      preset: null,
      preset_products: []
    });
  } finally {
    setLoading(false);
  }
}, [presetId]);
```

### Step 5: ç·Šæ€¥ãƒ‡ãƒ¼ã‚¿ä¿®æ­£

#### **5.1 ãƒ—ãƒªã‚»ãƒƒãƒˆ4ã®ãƒ‡ãƒ¼ã‚¿ä¿®æ­£SQL**
```sql
-- ãƒ—ãƒªã‚»ãƒƒãƒˆ4ã«å•†å“ãŒé–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ãªã„å ´åˆã®ç·Šæ€¥ä¿®æ­£

-- 1. ç¾åœ¨ã®çŠ¶æ…‹ç¢ºèª
SELECT 
  'preset_products' as table_name,
  COUNT(*) as count
FROM preset_products 
WHERE preset_id = 4
UNION ALL
SELECT 
  'pickup_windows' as table_name,
  COUNT(*) as count
FROM pickup_windows 
WHERE preset_id = 4;

-- 2. å•†å“ãŒ0ä»¶ã®å ´åˆã€ã‚µãƒ³ãƒ—ãƒ«å•†å“ã‚’é–¢é€£ä»˜ã‘
INSERT INTO preset_products (preset_id, product_id, display_order, is_active)
SELECT 4, id, ROW_NUMBER() OVER (ORDER BY name), true
FROM products 
WHERE visible = true 
AND id NOT IN (SELECT COALESCE(product_id, 0) FROM preset_products WHERE preset_id = 4)
LIMIT 3;

-- 3. å¼•ãå–ã‚ŠæœŸé–“ã‚‚ä½œæˆ
INSERT INTO pickup_windows (preset_id, product_id, pickup_start, pickup_end, dates, comment)
SELECT 
  4,
  pp.product_id,
  '2025-08-10 10:00:00+09',
  '2025-08-17 18:00:00+09',
  ARRAY['2025-08-10', '2025-08-11', '2025-08-12'],
  'å¼•ãå–ã‚Šå¯èƒ½æœŸé–“'
FROM preset_products pp
WHERE pp.preset_id = 4
AND pp.product_id NOT IN (SELECT COALESCE(product_id, 0) FROM pickup_windows WHERE preset_id = 4);
```

## ğŸš¨ **å®Ÿè£…å„ªå…ˆåº¦**

### **å³åº§ã«å®Ÿè¡Œï¼ˆç·Šæ€¥ï¼‰**
1. **Step 5**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿®æ­£SQLå®Ÿè¡Œ
2. **Step 4.1**: useFormConfig ã®å®‰å…¨æ€§å¼·åŒ–

### **24æ™‚é–“ä»¥å†…ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰**
3. **Step 2.1**: ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®šAPIä¿®æ­£
4. **Step 3.1**: çµ±åˆãƒ•ã‚©ãƒ¼ãƒ ä½œæˆAPIä¿®æ­£

### **1é€±é–“ä»¥å†…ï¼ˆä¸­å„ªå…ˆåº¦ï¼‰**
5. æ ¹æœ¬åŸå› ã®èª¿æŸ»ã¨æ’ä¹…å¯¾ç­–

## âœ… **å®Œäº†ç¢ºèª**

- [ ] ãƒ—ãƒªã‚»ãƒƒãƒˆ4ã§å•†å“ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] React Error #310ãŒè§£æ¶ˆã•ã‚Œã‚‹
- [ ] ç®¡ç†ç”»é¢ã§ã®å•†å“è¿½åŠ ãŒæ­£å¸¸å‹•ä½œã™ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œãªã„
- [ ] ãƒ•ã‚©ãƒ¼ãƒ ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹

## ğŸ“ **æ³¨æ„äº‹é …**

- ã“ã®ä¿®æ­£ã¯ç·Šæ€¥å¯¾å¿œã®ãŸã‚ã€æ ¹æœ¬åŸå› ã®èª¿æŸ»ã‚‚ä¸¦è¡Œã—ã¦å®Ÿæ–½
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿®æ­£ã¯æœ¬ç•ªç’°å¢ƒã§æ…é‡ã«å®Ÿè¡Œ
- ä»–ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã«å½±éŸ¿ãŒãªã„ã“ã¨ã‚’ç¢ºèª
- ãƒ­ã‚°å‡ºåŠ›ã‚’å……å®Ÿã•ã›ã¦ä»Šå¾Œã®å•é¡Œç‰¹å®šã‚’å®¹æ˜“ã«ã™ã‚‹
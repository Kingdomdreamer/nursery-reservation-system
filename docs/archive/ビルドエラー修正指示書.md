# ビルドエラー修正指示書

## 📋 エラー概要

**エラー内容**: `'preset_id' is specified more than once, so this usage will be overwritten.`  
**発生箇所**: `src/lib/repositories/PresetRepository.ts:228:11`  
**エラー種別**: TypeScript型エラー  
**緊急度**: 最高（デプロイ阻害）

## 🔍 エラー原因分析

### 問題のコード
```typescript
// src/lib/repositories/PresetRepository.ts:225-231
const { error: formError } = await supabaseAdmin
  .from('form_settings')
  .upsert({
    preset_id: presetId,           // ← 1回目の指定
    ...updateData.form_settings,   // ← この中にもpreset_idが含まれている
    updated_at: new Date().toISOString()
  });
```

### 根本原因
1. **オブジェクトスプレッド演算子の重複**: `updateData.form_settings`に既に`preset_id`プロパティが含まれている
2. **型定義の不整合**: `FormSettings`型に`preset_id`が含まれているため、スプレッド時に重複する
3. **データ構造の理解不足**: 更新データの構造を正しく把握していない

## 🎯 修正方法

### 修正A: オブジェクトの分割代入による除外

```typescript
// 修正前
const { error: formError } = await supabaseAdmin
  .from('form_settings')
  .upsert({
    preset_id: presetId,
    ...updateData.form_settings,
    updated_at: new Date().toISOString()
  });

// 修正後
const { error: formError } = await supabaseAdmin
  .from('form_settings')
  .upsert({
    preset_id: presetId,
    ...updateData.form_settings,
    updated_at: new Date().toISOString()
  });
```

### 修正B: 分割代入でpreset_idを除外（推奨）

```typescript
// 修正後（推奨）
if (updateData.form_settings) {
  const { preset_id: _, ...formSettingsWithoutPresetId } = updateData.form_settings;
  
  const { error: formError } = await supabaseAdmin
    .from('form_settings')
    .upsert({
      preset_id: presetId,
      ...formSettingsWithoutPresetId,
      updated_at: new Date().toISOString()
    });

  if (formError) {
    throw formError;
  }
}
```

### 修正C: 条件付きスプレッド（最も安全）

```typescript
// 修正後（最も安全）
if (updateData.form_settings) {
  const formSettingsData = { ...updateData.form_settings };
  delete formSettingsData.preset_id; // preset_idを明示的に削除
  
  const { error: formError } = await supabaseAdmin
    .from('form_settings')
    .upsert({
      preset_id: presetId,
      ...formSettingsData,
      updated_at: new Date().toISOString()
    });

  if (formError) {
    throw formError;
  }
}
```

## 📋 実装手順

### Step 1: ファイルを開く
```bash
# 対象ファイル
src/lib/repositories/PresetRepository.ts
```

### Step 2: 該当箇所を特定
- 行番号: 225-231付近
- メソッド: `updatePresetConfig`
- 処理: `form_settings`のupsert

### Step 3: コードを修正
以下のコードを置き換える：

**修正前**:
```typescript
// フォーム設定の更新
if (updateData.form_settings) {
  const { error: formError } = await supabaseAdmin
    .from('form_settings')
    .upsert({
      preset_id: presetId,
      ...updateData.form_settings,
      updated_at: new Date().toISOString()
    });

  if (formError) {
    throw formError;
  }
}
```

**修正後**:
```typescript
// フォーム設定の更新
if (updateData.form_settings) {
  // preset_idの重複を避けるため、明示的に除外
  const { preset_id: _, ...formSettingsWithoutPresetId } = updateData.form_settings;
  
  const { error: formError } = await supabaseAdmin
    .from('form_settings')
    .upsert({
      preset_id: presetId,
      ...formSettingsWithoutPresetId,
      updated_at: new Date().toISOString()
    });

  if (formError) {
    throw formError;
  }
}
```

### Step 4: 同様の問題がないか確認
他の箇所でも同様の重複がないかチェック：

```typescript
// preset_products の更新部分も確認
if (updateData.preset_products) {
  const { error: productsError } = await supabaseAdmin
    .from('preset_products')
    .upsert(
      updateData.preset_products.map(pp => {
        // preset_idの重複を避ける
        const { preset_id: _, ...productWithoutPresetId } = pp;
        return {
          preset_id: presetId,
          ...productWithoutPresetId,
          updated_at: new Date().toISOString()
        };
      })
    );

  if (productsError) {
    throw productsError;
  }
}
```

## 🔍 検証方法

### 1. ローカルビルドテスト
```bash
npm run build
```

### 2. 型チェック
```bash
npx tsc --noEmit
```

### 3. 修正箇所の動作確認
- プリセット設定の更新機能をテスト
- フォーム設定の保存が正常に動作するか確認

## 🚨 注意事項

### 1. データ整合性の確保
- `preset_id`は常にメソッドパラメータの値を使用
- 更新データ内の`preset_id`は無視する

### 2. 型安全性の維持
- 分割代入時の型推論を正しく処理
- `_`変数は使用しないことを明示

### 3. エラーハンドリング
- upsert処理のエラーを適切にキャッチ
- データベースエラーの詳細をログ出力

## 📊 期待される効果

### 1. 即座の効果
- ビルドエラーの完全解消
- デプロイの正常化
- 型チェックの通過

### 2. 長期的効果
- データ整合性の向上
- 保守性の改善
- 同様のエラーの予防

## 🔄 根本的解決策

この問題は、先ほど作成した「仕様設計問題分析_改善指示書.md」で指摘した**型定義とデータベーススキーマの不整合**の典型例です。

### 推奨される改善
1. **型定義の見直し**: 更新用の型と表示用の型を分離
2. **データ変換層の導入**: DTO（Data Transfer Object）パターンの採用
3. **バリデーション強化**: 実行時型チェックの導入

```typescript
// 推奨される型分離
export interface FormSettingsDisplay {
  id: number;
  preset_id: number;
  show_price: boolean;
  // ... 他のフィールド
}

export interface FormSettingsUpdate {
  show_price?: boolean;
  require_phone?: boolean;
  // preset_idは含まない
}
```

---

**作成日**: 2025年8月5日  
**緊急度**: 最高  
**推定修正時間**: 5分  
**作成者**: Kiro AI Assistant
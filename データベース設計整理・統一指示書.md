# データベース設計整理・統一指示書

## 現状の問題分析

### 🚨 **根本的な設計問題**

#### **1. テーブル関係の不整合**
```
現在の問題のある関係:
pickup_windows ← product_id → products
pickup_windows ← preset_id → product_presets
preset_products ← product_id → products
preset_products ← preset_id → product_presets

問題: pickup_windowsが商品とプリセットの両方を参照している
```

#### **2. データ取得ロジックの複雑化**
- 商品データを取得するのに3つのテーブル（products, preset_products, pickup_windows）を結合
- どのテーブルを基準にするかが不明確
- 同じ商品が複数の経路で取得される可能性

#### **3. 型定義とDB定義の不整合**
- TypeScript型定義が複数ファイルに分散
- DB定義と型定義でフィールド名が異なる箇所がある
- オプショナルフィールドの扱いが不統一

## 🎯 **統一されたデータベース設計**

### **基本設計原則**

#### **1. 単一責任の原則**
- 各テーブルは明確な責任を持つ
- 関連付けは中間テーブルで管理
- 時間情報は専用テーブルで管理

#### **2. 正規化の徹底**
- 重複データの排除
- 参照整合性の確保
- 明確な主キー・外部キー関係

### **統一DB設計**

#### **コアテーブル設計**

```sql
-- 1. 商品マスタテーブル（簡素化）
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    price INTEGER NOT NULL DEFAULT 0,
    
    -- 基本情報
    category_id INTEGER DEFAULT 1,
    product_code TEXT UNIQUE,
    
    -- バリエーション管理（簡素化）
    base_product_name TEXT,
    variation_name TEXT,
    variation_type VARCHAR(20) DEFAULT 'price',
    
    -- システム設定（必要最小限）
    visible BOOLEAN NOT NULL DEFAULT true,
    display_order INTEGER DEFAULT 0,
    
    -- メタデータ
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    -- インデックス用制約
    CONSTRAINT products_name_check CHECK (length(name) > 0),
    CONSTRAINT products_price_check CHECK (price >= 0)
);

-- 2. プリセットマスタテーブル
CREATE TABLE product_presets (
    id SERIAL PRIMARY KEY,
    preset_name TEXT NOT NULL,
    description TEXT,
    is_active BOOLEAN NOT NULL DEFAULT true,
    
    -- メタデータ
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    -- 制約
    CONSTRAINT presets_name_check CHECK (length(preset_name) > 0)
);

-- 3. プリセット商品関連テーブル（中間テーブル）
CREATE TABLE preset_products (
    id SERIAL PRIMARY KEY,
    preset_id INTEGER NOT NULL REFERENCES product_presets(id) ON DELETE CASCADE,
    product_id INTEGER NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    display_order INTEGER NOT NULL DEFAULT 0,
    is_active BOOLEAN NOT NULL DEFAULT true,
    
    -- メタデータ
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    -- 一意制約（同じプリセットに同じ商品は1つまで）
    UNIQUE(preset_id, product_id),
    
    -- 制約
    CONSTRAINT preset_products_display_order_check CHECK (display_order >= 0)
);

-- 4. フォーム設定テーブル（1プリセット1設定）
CREATE TABLE form_settings (
    id SERIAL PRIMARY KEY,
    preset_id INTEGER NOT NULL REFERENCES product_presets(id) ON DELETE CASCADE,
    
    -- フォーム表示設定
    show_price BOOLEAN NOT NULL DEFAULT true,
    require_phone BOOLEAN NOT NULL DEFAULT true,
    require_furigana BOOLEAN NOT NULL DEFAULT false,
    allow_note BOOLEAN NOT NULL DEFAULT true,
    
    -- システム設定
    is_enabled BOOLEAN NOT NULL DEFAULT true,
    custom_message TEXT,
    
    -- メタデータ
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    -- 一意制約（1プリセット1設定）
    UNIQUE(preset_id)
);

-- 5. 引き取り期間テーブル（プリセット単位で管理）
CREATE TABLE pickup_schedules (
    id SERIAL PRIMARY KEY,
    preset_id INTEGER NOT NULL REFERENCES product_presets(id) ON DELETE CASCADE,
    
    -- 期間設定
    pickup_start TIMESTAMP WITH TIME ZONE NOT NULL,
    pickup_end TIMESTAMP WITH TIME ZONE NOT NULL,
    available_dates TEXT[] DEFAULT '{}',
    
    -- 表示設定
    title TEXT NOT NULL DEFAULT '引き取り期間',
    description TEXT,
    is_active BOOLEAN NOT NULL DEFAULT true,
    
    -- メタデータ
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    -- 制約
    CONSTRAINT pickup_schedules_dates_check CHECK (pickup_start < pickup_end)
);

-- 6. 予約テーブル（簡素化）
CREATE TABLE reservations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    preset_id INTEGER NOT NULL REFERENCES product_presets(id) ON DELETE RESTRICT,
    
    -- 顧客情報
    user_id TEXT NOT NULL,
    user_name TEXT NOT NULL,
    phone_number TEXT NOT NULL,
    furigana TEXT,
    note TEXT,
    
    -- 予約情報
    selected_products JSONB NOT NULL, -- 選択された商品情報
    pickup_date TIMESTAMP WITH TIME ZONE,
    total_amount INTEGER NOT NULL DEFAULT 0,
    
    -- システム情報
    status VARCHAR(20) NOT NULL DEFAULT 'confirmed',
    line_user_id TEXT,
    
    -- メタデータ
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    
    -- 制約
    CONSTRAINT reservations_user_name_check CHECK (length(user_name) > 0),
    CONSTRAINT reservations_phone_check CHECK (length(phone_number) > 0),
    CONSTRAINT reservations_total_check CHECK (total_amount >= 0)
);
```

#### **インデックス設計**

```sql
-- パフォーマンス最適化用インデックス
CREATE INDEX idx_products_visible_order ON products(visible, display_order) WHERE visible = true;
CREATE INDEX idx_products_category ON products(category_id) WHERE visible = true;
CREATE INDEX idx_products_base_name ON products(base_product_name) WHERE base_product_name IS NOT NULL;

CREATE INDEX idx_preset_products_preset ON preset_products(preset_id, display_order) WHERE is_active = true;
CREATE INDEX idx_preset_products_product ON preset_products(product_id) WHERE is_active = true;

CREATE INDEX idx_form_settings_enabled ON form_settings(preset_id) WHERE is_enabled = true;

CREATE INDEX idx_pickup_schedules_preset ON pickup_schedules(preset_id) WHERE is_active = true;
CREATE INDEX idx_pickup_schedules_dates ON pickup_schedules(pickup_start, pickup_end) WHERE is_active = true;

CREATE INDEX idx_reservations_preset ON reservations(preset_id, created_at);
CREATE INDEX idx_reservations_user ON reservations(user_id, created_at);
CREATE INDEX idx_reservations_status ON reservations(status, created_at);
```

## 🔧 **統一型定義**

### **TypeScript型定義の統一**

```typescript
// src/types/database.ts - 新しい統一型定義ファイル

// ===== コアエンティティ =====

export interface Product {
  readonly id: number;
  readonly name: string;
  readonly price: number;
  readonly category_id: number;
  readonly product_code?: string;
  
  // バリエーション管理
  readonly base_product_name?: string;
  readonly variation_name?: string;
  readonly variation_type?: 'price' | 'size' | 'weight' | 'other';
  
  // システム設定
  readonly visible: boolean;
  readonly display_order: number;
  
  // メタデータ
  readonly created_at: string;
  readonly updated_at: string;
}

export interface ProductPreset {
  readonly id: number;
  readonly preset_name: string;
  readonly description?: string;
  readonly is_active: boolean;
  readonly created_at: string;
  readonly updated_at: string;
}

export interface PresetProduct {
  readonly id: number;
  readonly preset_id: number;
  readonly product_id: number;
  readonly display_order: number;
  readonly is_active: boolean;
  readonly created_at: string;
  readonly updated_at: string;
  
  // JOIN時の関連データ
  readonly product?: Product;
}

export interface FormSettings {
  readonly id: number;
  readonly preset_id: number;
  
  // フォーム表示設定
  readonly show_price: boolean;
  readonly require_phone: boolean;
  readonly require_furigana: boolean;
  readonly allow_note: boolean;
  
  // システム設定
  readonly is_enabled: boolean;
  readonly custom_message?: string;
  
  // メタデータ
  readonly created_at: string;
  readonly updated_at: string;
}

export interface PickupSchedule {
  readonly id: number;
  readonly preset_id: number;
  
  // 期間設定
  readonly pickup_start: string;
  readonly pickup_end: string;
  readonly available_dates: string[];
  
  // 表示設定
  readonly title: string;
  readonly description?: string;
  readonly is_active: boolean;
  
  // メタデータ
  readonly created_at: string;
  readonly updated_at: string;
}

export interface Reservation {
  readonly id: string;
  readonly preset_id: number;
  
  // 顧客情報
  readonly user_id: string;
  readonly user_name: string;
  readonly phone_number: string;
  readonly furigana?: string;
  readonly note?: string;
  
  // 予約情報
  readonly selected_products: SelectedProduct[];
  readonly pickup_date?: string;
  readonly total_amount: number;
  
  // システム情報
  readonly status: ReservationStatus;
  readonly line_user_id?: string;
  
  // メタデータ
  readonly created_at: string;
  readonly updated_at: string;
}

// ===== 補助型 =====

export interface SelectedProduct {
  readonly product_id: number;
  readonly product_name: string;
  readonly quantity: number;
  readonly unit_price: number;
  readonly total_price: number;
}

export type ReservationStatus = 'confirmed' | 'cancelled' | 'completed';

// ===== API レスポンス型 =====

export interface PresetConfigResponse {
  readonly preset: ProductPreset;
  readonly form_settings: FormSettings;
  readonly products: Product[];
  readonly pickup_schedules: PickupSchedule[];
}

// ===== 型ガード関数 =====

export const isProduct = (value: unknown): value is Product => {
  return (
    typeof value === 'object' &&
    value !== null &&
    typeof (value as Product).id === 'number' &&
    typeof (value as Product).name === 'string' &&
    typeof (value as Product).price === 'number' &&
    typeof (value as Product).visible === 'boolean'
  );
};

export const isPresetProduct = (value: unknown): value is PresetProduct => {
  return (
    typeof value === 'object' &&
    value !== null &&
    typeof (value as PresetProduct).id === 'number' &&
    typeof (value as PresetProduct).preset_id === 'number' &&
    typeof (value as PresetProduct).product_id === 'number' &&
    typeof (value as PresetProduct).is_active === 'boolean'
  );
};
```

## 📊 **データ取得の統一パターン**

### **標準的なデータ取得クエリ**

```sql
-- プリセット設定の取得（統一パターン）
WITH preset_data AS (
  SELECT 
    pp.id,
    pp.preset_name,
    pp.description,
    pp.is_active,
    pp.created_at,
    pp.updated_at
  FROM product_presets pp
  WHERE pp.id = $1 AND pp.is_active = true
),
form_data AS (
  SELECT 
    fs.*
  FROM form_settings fs
  WHERE fs.preset_id = $1 AND fs.is_enabled = true
),
product_data AS (
  SELECT 
    p.*,
    ppr.display_order,
    ppr.is_active as preset_product_active
  FROM products p
  INNER JOIN preset_products ppr ON p.id = ppr.product_id
  WHERE ppr.preset_id = $1 
    AND ppr.is_active = true 
    AND p.visible = true
  ORDER BY ppr.display_order, p.name
),
schedule_data AS (
  SELECT 
    ps.*
  FROM pickup_schedules ps
  WHERE ps.preset_id = $1 AND ps.is_active = true
  ORDER BY ps.pickup_start
)
SELECT 
  (SELECT row_to_json(preset_data) FROM preset_data) as preset,
  (SELECT row_to_json(form_data) FROM form_data) as form_settings,
  (SELECT json_agg(product_data ORDER BY display_order) FROM product_data) as products,
  (SELECT json_agg(schedule_data ORDER BY pickup_start) FROM schedule_data) as pickup_schedules;
```

## 🚀 **移行計画**

### **Phase 1: 新テーブル構造の作成**
1. 新しいテーブル構造をテスト環境で作成
2. 既存データの移行スクリプト作成
3. 新旧両方のテーブルでの並行運用開始

### **Phase 2: API・型定義の更新**
1. 新しい型定義ファイルの作成
2. API エンドポイントの段階的更新
3. フロントエンドコンポーネントの更新

### **Phase 3: 旧構造の削除**
1. 新構造での動作確認
2. 旧テーブル・型定義の削除
3. 不要なコードの清理

## ✅ **期待される効果**

### **開発効率の向上**
- データ取得ロジックの統一
- 型安全性の向上
- デバッグの容易化

### **保守性の向上**
- 明確なテーブル関係
- 一貫性のある命名規則
- 簡潔なクエリ構造

### **パフォーマンスの向上**
- 最適化されたインデックス
- 効率的なJOIN構造
- 不要なデータ取得の削減

## 📝 **実装優先度**

### **即座に実行（緊急）**
1. 新しい型定義ファイルの作成
2. 統一されたデータ取得パターンの実装

### **1週間以内（高優先度）**
3. 新テーブル構造の作成・テスト
4. 既存データの移行スクリプト作成

### **1ヶ月以内（中優先度）**
5. 段階的な移行実行
6. 旧構造の削除・清理

この統一設計により、現在の「商品を追加したのにフォームで表示されない」問題の根本原因が解決され、今後の開発・保守が大幅に改善されます。
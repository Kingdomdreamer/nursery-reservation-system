# å•†å“äºˆç´„ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨ä»•æ§˜æ›¸ ç¬¬3éƒ¨ - APIè¨­è¨ˆ

## ğŸŒ **APIè¨­è¨ˆä»•æ§˜**

### **1. RESTful APIè¨­è¨ˆåŸå‰‡**

#### **çµ±ä¸€ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼**
```typescript
// æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
interface ApiSuccessResponse<T> {
  success: true;
  data: T;
  timestamp: string;
  meta?: {
    [key: string]: unknown;
    timestamp: string;
  };
}

// ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
interface ApiErrorResponse {
  success: false;
  error: string;
  code: string;
  message: string;
  details?: string;
  timestamp: string;
  field?: string; // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼æ™‚
}

// ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ä»˜ããƒ¬ã‚¹ãƒãƒ³ã‚¹
interface PaginatedApiResponse<T> {
  success: true;
  data: T[];
  pagination: {
    page: number;
    per_page: number;
    total_items: number;
    total_pages: number;
    has_next_page: boolean;
    has_previous_page: boolean;
  };
  timestamp: string;
  meta?: Record<string, unknown>;
}
```

#### **HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰è¦å‰‡**
```typescript
const HTTP_STATUS = {
  // æˆåŠŸ
  OK: 200,                    // GETæˆåŠŸ
  CREATED: 201,               // POSTæˆåŠŸï¼ˆä½œæˆï¼‰
  NO_CONTENT: 204,            // DELETEæˆåŠŸ
  
  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼
  BAD_REQUEST: 400,           // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
  UNAUTHORIZED: 401,          // èªè¨¼ã‚¨ãƒ©ãƒ¼
  FORBIDDEN: 403,             // èªå¯ã‚¨ãƒ©ãƒ¼
  NOT_FOUND: 404,             // ãƒªã‚½ãƒ¼ã‚¹æœªç™ºè¦‹
  CONFLICT: 409,              // é‡è¤‡ã‚¨ãƒ©ãƒ¼
  UNPROCESSABLE_ENTITY: 422,  // ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼
  TOO_MANY_REQUESTS: 429,     // ãƒ¬ãƒ¼ãƒˆåˆ¶é™
  
  // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼
  INTERNAL_SERVER_ERROR: 500, // ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼
  BAD_GATEWAY: 502,           // å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ©ãƒ¼
  SERVICE_UNAVAILABLE: 503    // ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
} as const;
```

### **2. API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè©³ç´°ä»•æ§˜**

#### **ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†API**

##### **GET /api/presets/[presetId]/config**
```typescript
// ç”¨é€”: ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã¨ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ‹¬å–å¾—
// èªè¨¼: ä¸è¦ï¼ˆå…¬é–‹APIï¼‰
// ãƒ¬ãƒ¼ãƒˆåˆ¶é™: 100req/min

interface GetPresetConfigRequest {
  params: {
    presetId: string; // æ•°å€¤æ–‡å­—åˆ—
  };
}

interface GetPresetConfigResponse {
  success: true;
  data: {
    preset: {
      id: number;
      preset_name: string;
      description?: string;
      form_expiry_date?: string;
      is_active: boolean;
      created_at: string;
      updated_at: string;
    };
    form_settings: {
      id: number;
      preset_id: number;
      show_name: boolean;
      show_furigana: boolean;
      show_gender: boolean;
      show_birthday: boolean;
      show_phone: boolean;
      show_zip: boolean;
      show_address1: boolean;
      show_address2: boolean;
      show_comment: boolean;
      show_price: boolean;
      show_total: boolean;
      // äº’æ›æ€§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      require_phone: boolean;
      require_furigana: boolean;
      allow_note: boolean;
      enable_birthday: boolean;
      enable_gender: boolean;
      require_address: boolean;
      enable_furigana: boolean;
      is_enabled: boolean;
      custom_message?: string;
      created_at: string;
      updated_at: string;
    };
    products: Array<{
      id: number;
      product_code?: string;
      name: string;
      variation_id: number;
      variation_name: string;
      tax_type: 'å†…ç¨' | 'å¤–ç¨';
      price: number;
      barcode?: string;
      visible: boolean;
      display_order: number;
      created_at: string;
      updated_at: string;
    }>;
    pickup_windows: Array<{
      id: number;
      preset_id: number;
      start_date: string;
      end_date: string;
      start_time?: string;
      end_time?: string;
      available_slots?: number;
      is_available: boolean;
      created_at: string;
      updated_at: string;
    }>;
    preset_products: Array<{
      id: number;
      preset_id: number;
      product_id: number;
      start_date: string;
      end_date: string;
      display_order: number;
      is_active: boolean;
      created_at: string;
      updated_at: string;
      product?: Product;
    }>;
  };
  timestamp: string;
  meta: {
    presetId: number;
    totalProducts: number;
    totalPickupWindows: number;
    hasFormSettings: boolean;
  };
}

// ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹
interface GetPresetConfigErrorResponse {
  success: false;
  error: string;
  code: 'PRESET_NOT_FOUND' | 'PRESET_INACTIVE' | 'PRESET_EXPIRED';
  message: string;
  available_presets?: Array<{
    id: number;
    preset_name: string;
  }>;
  suggestion?: string;
}
```

##### **PUT /api/presets/[presetId]/config**
```typescript
// ç”¨é€”: ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã®æ›´æ–°
// èªè¨¼: ç®¡ç†è€…èªè¨¼å¿…é ˆ
// ãƒ¬ãƒ¼ãƒˆåˆ¶é™: 10req/min

interface UpdatePresetConfigRequest {
  params: {
    presetId: string;
  };
  body: {
    form_settings?: Partial<FormSettingsUpdateInput>;
    preset_products?: Array<{
      id?: number;
      product_id: number;
      start_date: string;
      end_date: string;
      display_order?: number;
      is_active?: boolean;
    }>;
    pickup_windows?: Array<{
      id?: number;
      start_date: string;
      end_date: string;
      start_time?: string;
      end_time?: string;
      available_slots?: number;
      is_available?: boolean;
    }>;
  };
}

interface UpdatePresetConfigResponse {
  success: true;
  data: {
    message: string;
  };
  timestamp: string;
  meta: {
    presetId: number;
    updatedFields: string[];
  };
}
```

#### **äºˆç´„ç®¡ç†API**

##### **POST /api/reservations**
```typescript
// ç”¨é€”: æ–°è¦äºˆç´„ä½œæˆ
// èªè¨¼: ä¸è¦ï¼ˆLIFFçµŒç”±ï¼‰
// ãƒ¬ãƒ¼ãƒˆåˆ¶é™: 5req/min

interface CreateReservationRequest {
  body: {
    preset_id: number;
    user_name: string;
    furigana?: string;
    gender?: 'ç”·æ€§' | 'å¥³æ€§' | 'ãã®ä»–';
    birthday?: string; // YYYY-MM-DD
    phone_number: string;
    zip_code?: string;
    address1?: string;
    address2?: string;
    comment?: string;
    selected_products: Array<{
      product_id: number;
      product_name: string;
      variation_name: string;
      quantity: number;
      unit_price: number;
      total_price: number;
      tax_type: 'å†…ç¨' | 'å¤–ç¨';
    }>;
    pickup_date?: string; // ISO 8601
    total_amount: number;
    line_user_id?: string;
  };
}

interface CreateReservationResponse {
  success: true;
  data: {
    reservation: {
      id: string; // UUID
      preset_id: number;
      reservation_number: string; // R20250829-0001
      user_name: string;
      phone_number: string;
      total_amount: number;
      status: 'confirmed';
      created_at: string;
      cancel_url: string; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”¨URL
    };
    preset_name: string;
  };
  timestamp: string;
  meta: {
    line_notification_sent: boolean;
    estimated_pickup_time?: string;
  };
}

// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ä¾‹
interface CreateReservationValidationError {
  success: false;
  error: 'ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼';
  code: 'VALIDATION_ERROR';
  message: 'Validation failed.';
  details: string[];
  timestamp: string;
}
```

##### **GET /api/reservations/[reservationId]**
```typescript
// ç”¨é€”: äºˆç´„è©³ç´°å–å¾—ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å¤‰æ›´ç”¨ï¼‰
// èªè¨¼: é›»è©±ç•ªå·èªè¨¼ or ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³
// ãƒ¬ãƒ¼ãƒˆåˆ¶é™: 20req/min

interface GetReservationRequest {
  params: {
    reservationId: string; // UUID
  };
  query: {
    phone?: string;     // é›»è©±ç•ªå·èªè¨¼
    token?: string;     // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼
  };
}

interface GetReservationResponse {
  success: true;
  data: {
    id: string;
    preset_id: number;
    reservation_number: string;
    user_name: string;
    furigana?: string;
    gender?: string;
    birthday?: string;
    phone_number: string;
    zip_code?: string;
    address1?: string;
    address2?: string;
    comment?: string;
    selected_products: SelectedProduct[];
    pickup_date?: string;
    total_amount: number;
    status: 'confirmed' | 'cancelled' | 'completed';
    line_user_id?: string;
    created_at: string;
    updated_at: string;
  };
  timestamp: string;
  meta: {
    editable_fields: string[];
    can_cancel: boolean;
    cancel_deadline?: string;
  };
}
```

##### **PUT /api/reservations/[reservationId]**
```typescript
// ç”¨é€”: äºˆç´„å†…å®¹å¤‰æ›´
// èªè¨¼: é›»è©±ç•ªå·èªè¨¼ or ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³
// ãƒ¬ãƒ¼ãƒˆåˆ¶é™: 5req/min

interface UpdateReservationRequest {
  params: {
    reservationId: string;
  };
  query: {
    phone?: string;
    token?: string;
  };
  body: {
    user_name?: string;
    furigana?: string;
    gender?: 'ç”·æ€§' | 'å¥³æ€§' | 'ãã®ä»–';
    birthday?: string;
    phone_number?: string;
    zip_code?: string;
    address1?: string;
    address2?: string;
    comment?: string;
    selected_products?: SelectedProduct[];
    pickup_date?: string;
    total_amount?: number;
  };
}

interface UpdateReservationResponse {
  success: true;
  data: {
    message: string;
    updated_fields: string[];
  };
  timestamp: string;
  meta: {
    line_notification_sent: boolean;
    price_difference?: number;
  };
}
```

##### **DELETE /api/reservations/[reservationId]**
```typescript
// ç”¨é€”: äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«
// èªè¨¼: é›»è©±ç•ªå·èªè¨¼ or ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³
// ãƒ¬ãƒ¼ãƒˆåˆ¶é™: 3req/min

interface CancelReservationRequest {
  params: {
    reservationId: string;
  };
  query: {
    phone?: string;
    token?: string;
  };
  body?: {
    cancellation_reason?: string;
  };
}

interface CancelReservationResponse {
  success: true;
  data: {
    message: string;
    cancelled_at: string;
    refund_info?: {
      amount: number;
      method: string;
      estimated_date: string;
    };
  };
  timestamp: string;
  meta: {
    line_notification_sent: boolean;
    original_amount: number;
  };
}
```

#### **ç®¡ç†ç”»é¢API**

##### **GET /api/admin/dashboard**
```typescript
// ç”¨é€”: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—
// èªè¨¼: ç®¡ç†è€…èªè¨¼å¿…é ˆ
// ãƒ¬ãƒ¼ãƒˆåˆ¶é™: 30req/min

interface GetDashboardResponse {
  success: true;
  data: {
    stats: {
      today_reservations: number;
      week_reservations: number;
      month_reservations: number;
      total_revenue: number;
      active_presets: number;
      total_products: number;
    };
    recent_reservations: Array<{
      id: string;
      user_name: string;
      phone_number: string;
      product: string[];
      total_amount: number;
      status: string;
      created_at: string;
    }>;
    system_health: {
      database: 'healthy' | 'warning' | 'error';
      line_api: 'healthy' | 'warning' | 'error';
      storage: 'healthy' | 'warning' | 'error';
    };
  };
  timestamp: string;
}
```

##### **GET /api/admin/products**
```typescript
// ç”¨é€”: å•†å“ä¸€è¦§å–å¾—ï¼ˆç®¡ç†ç”¨ï¼‰
// èªè¨¼: ç®¡ç†è€…èªè¨¼å¿…é ˆ
// ãƒ¬ãƒ¼ãƒˆåˆ¶é™: 60req/min

interface GetAdminProductsRequest {
  query: {
    page?: string;           // ãƒšãƒ¼ã‚¸ç•ªå·ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1ï¼‰
    limit?: string;          // 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®ä»¶æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 20ã€æœ€å¤§: 100ï¼‰
    name?: string;           // å•†å“åæ¤œç´¢
    min_price?: string;      // æœ€å°ä¾¡æ ¼
    max_price?: string;      // æœ€å¤§ä¾¡æ ¼
    variation_name?: string; // ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³åæ¤œç´¢
    tax_type?: 'å†…ç¨' | 'å¤–ç¨'; // ç¨åŒºåˆ†
    visible?: 'true' | 'false'; // è¡¨ç¤ºãƒ•ãƒ©ã‚°
    sort_by?: 'name' | 'price' | 'created_at' | 'display_order'; // ã‚½ãƒ¼ãƒˆé …ç›®
    sort_order?: 'asc' | 'desc'; // ã‚½ãƒ¼ãƒˆé †
  };
}

interface GetAdminProductsResponse {
  success: true;
  data: Product[];
  pagination: {
    page: number;
    per_page: number;
    total_items: number;
    total_pages: number;
    has_next_page: boolean;
    has_previous_page: boolean;
  };
  timestamp: string;
  meta: {
    filters_applied: Record<string, string>;
    total_visible_products: number;
    total_hidden_products: number;
  };
}
```

##### **POST /api/admin/products**
```typescript
// ç”¨é€”: å•†å“ä½œæˆ
// èªè¨¼: ç®¡ç†è€…èªè¨¼å¿…é ˆ
// ãƒ¬ãƒ¼ãƒˆåˆ¶é™: 10req/min

interface CreateProductRequest {
  body: {
    name: string;
    variation_id?: number;
    variation_name?: string;
    tax_type?: 'å†…ç¨' | 'å¤–ç¨';
    price: number;
    product_code?: string;
    barcode?: string;
    visible?: boolean;
    display_order?: number;
  };
}

interface CreateProductResponse {
  success: true;
  data: Product;
  timestamp: string;
  meta: {
    auto_generated_fields: string[];
  };
}
```

##### **POST /api/admin/products/import**
```typescript
// ç”¨é€”: CSVä¸€æ‹¬ç™»éŒ²
// èªè¨¼: ç®¡ç†è€…èªè¨¼å¿…é ˆ
// ãƒ¬ãƒ¼ãƒˆåˆ¶é™: 2req/min

interface ImportProductsRequest {
  body: FormData; // CSV file
  query: {
    preset_id?: string; // ãƒ—ãƒªã‚»ãƒƒãƒˆã«è‡ªå‹•è¿½åŠ 
  };
}

interface ImportProductsResponse {
  success: true;
  data: {
    imported: number;
    skipped: number;
    errors: Array<{
      row: number;
      field?: string;
      message: string;
      data?: Record<string, unknown>;
    }>;
    warnings: Array<{
      row: number;
      field?: string;
      message: string;
      data?: Record<string, unknown>;
    }>;
  };
  timestamp: string;
  meta: {
    total_rows_processed: number;
    processing_time_ms: number;
    preset_auto_added?: boolean;
  };
}
```

### **3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»•æ§˜**

#### **ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹**
```typescript
// åŸºåº•ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹
abstract class AppError extends Error {
  abstract readonly statusCode: number;
  abstract readonly code: string;
  readonly timestamp: string;
  readonly isOperational: boolean = true;

  constructor(message: string, public readonly cause?: Error) {
    super(message);
    this.name = this.constructor.name;
    this.timestamp = new Date().toISOString();
    Error.captureStackTrace(this, this.constructor);
  }
}

// å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹
class ValidationError extends AppError {
  readonly statusCode = 400;
  readonly code = 'VALIDATION_ERROR';
  
  constructor(message: string, public readonly field?: string) {
    super(message);
  }
}

class AuthenticationError extends AppError {
  readonly statusCode = 401;
  readonly code = 'AUTHENTICATION_REQUIRED';
}

class AuthorizationError extends AppError {
  readonly statusCode = 403;
  readonly code = 'AUTHORIZATION_FAILED';
}

class NotFoundError extends AppError {
  readonly statusCode = 404;
  readonly code = 'RESOURCE_NOT_FOUND';
  
  constructor(resource: string, id: string | number) {
    super(`${resource} not found: ${id}`);
  }
}

class ConflictError extends AppError {
  readonly statusCode = 409;
  readonly code = 'RESOURCE_CONFLICT';
}

class RateLimitError extends AppError {
  readonly statusCode = 429;
  readonly code = 'RATE_LIMIT_EXCEEDED';
  
  constructor(message: string, public readonly retryAfter?: number) {
    super(message);
  }
}

class DatabaseError extends AppError {
  readonly statusCode = 500;
  readonly code = 'DATABASE_ERROR';
}

class ExternalServiceError extends AppError {
  readonly statusCode = 502;
  readonly code = 'EXTERNAL_SERVICE_ERROR';
  
  constructor(message: string, public readonly service: string) {
    super(message);
  }
}
```

#### **çµ±ä¸€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼**
```typescript
export const handleApiError = (error: unknown, context?: string): NextResponse => {
  // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¨˜éŒ²
  logError(error, context);

  // AppErrorã®å‡¦ç†
  if (error instanceof AppError) {
    return createErrorResponse(error);
  }

  // Supabaseã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
  if (isSupabaseError(error)) {
    const dbError = new DatabaseError('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', error as Error);
    return createErrorResponse(dbError);
  }

  // äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼
  const unexpectedError = new DatabaseError('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', error as Error);
  return createErrorResponse(unexpectedError);
};

const createErrorResponse = (error: AppError): NextResponse => {
  const response: ApiErrorResponse = {
    success: false,
    error: error.message,
    code: error.code,
    message: getEnglishMessage(error.code),
    timestamp: error.timestamp
  };

  // é–‹ç™ºç’°å¢ƒã§ã¯ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å«ã‚ã‚‹
  if (process.env.NODE_ENV === 'development' && error.stack) {
    response.details = error.stack;
  }

  return NextResponse.json(response, { status: error.statusCode });
};
```
# 商品予約システム完全仕様書 第3部 - API設計

## 🌐 **API設計仕様**

### **1. RESTful API設計原則**

#### **統一レスポンス形式**
```typescript
// 成功レスポンス
interface ApiSuccessResponse<T> {
  success: true;
  data: T;
  timestamp: string;
  meta?: {
    [key: string]: unknown;
    timestamp: string;
  };
}

// エラーレスポンス
interface ApiErrorResponse {
  success: false;
  error: string;
  code: string;
  message: string;
  details?: string;
  timestamp: string;
  field?: string; // バリデーションエラー時
}

// ページネーション付きレスポンス
interface PaginatedApiResponse<T> {
  success: true;
  data: T[];
  pagination: {
    page: number;
    per_page: number;
    total_items: number;
    total_pages: number;
    has_next_page: boolean;
    has_previous_page: boolean;
  };
  timestamp: string;
  meta?: Record<string, unknown>;
}
```

#### **HTTPステータスコード規則**
```typescript
const HTTP_STATUS = {
  // 成功
  OK: 200,                    // GET成功
  CREATED: 201,               // POST成功（作成）
  NO_CONTENT: 204,            // DELETE成功
  
  // クライアントエラー
  BAD_REQUEST: 400,           // バリデーションエラー
  UNAUTHORIZED: 401,          // 認証エラー
  FORBIDDEN: 403,             // 認可エラー
  NOT_FOUND: 404,             // リソース未発見
  CONFLICT: 409,              // 重複エラー
  UNPROCESSABLE_ENTITY: 422,  // ビジネスロジックエラー
  TOO_MANY_REQUESTS: 429,     // レート制限
  
  // サーバーエラー
  INTERNAL_SERVER_ERROR: 500, // システムエラー
  BAD_GATEWAY: 502,           // 外部サービスエラー
  SERVICE_UNAVAILABLE: 503    // サービス停止
} as const;
```

### **2. API エンドポイント詳細仕様**

#### **フォーム・プリセット管理API**

##### **GET /api/presets/[presetId]/config**
```typescript
// 用途: フォーム設定とデータの一括取得
// 認証: 不要（公開API）
// レート制限: 100req/min

interface GetPresetConfigRequest {
  params: {
    presetId: string; // 数値文字列
  };
}

interface GetPresetConfigResponse {
  success: true;
  data: {
    preset: {
      id: number;
      preset_name: string;
      description?: string;
      form_expiry_date?: string;
      is_active: boolean;
      created_at: string;
      updated_at: string;
    };
    form_settings: {
      id: number;
      preset_id: number;
      show_name: boolean;
      show_furigana: boolean;
      show_gender: boolean;
      show_birthday: boolean;
      show_phone: boolean;
      show_zip: boolean;
      show_address1: boolean;
      show_address2: boolean;
      show_comment: boolean;
      show_price: boolean;
      show_total: boolean;
      // 互換性フィールド
      require_phone: boolean;
      require_furigana: boolean;
      allow_note: boolean;
      enable_birthday: boolean;
      enable_gender: boolean;
      require_address: boolean;
      enable_furigana: boolean;
      is_enabled: boolean;
      custom_message?: string;
      created_at: string;
      updated_at: string;
    };
    products: Array<{
      id: number;
      product_code?: string;
      name: string;
      variation_id: number;
      variation_name: string;
      tax_type: '内税' | '外税';
      price: number;
      barcode?: string;
      visible: boolean;
      display_order: number;
      created_at: string;
      updated_at: string;
    }>;
    pickup_windows: Array<{
      id: number;
      preset_id: number;
      start_date: string;
      end_date: string;
      start_time?: string;
      end_time?: string;
      available_slots?: number;
      is_available: boolean;
      created_at: string;
      updated_at: string;
    }>;
    preset_products: Array<{
      id: number;
      preset_id: number;
      product_id: number;
      start_date: string;
      end_date: string;
      display_order: number;
      is_active: boolean;
      created_at: string;
      updated_at: string;
      product?: Product;
    }>;
  };
  timestamp: string;
  meta: {
    presetId: number;
    totalProducts: number;
    totalPickupWindows: number;
    hasFormSettings: boolean;
  };
}

// エラーレスポンス例
interface GetPresetConfigErrorResponse {
  success: false;
  error: string;
  code: 'PRESET_NOT_FOUND' | 'PRESET_INACTIVE' | 'PRESET_EXPIRED';
  message: string;
  available_presets?: Array<{
    id: number;
    preset_name: string;
  }>;
  suggestion?: string;
}
```

##### **PUT /api/presets/[presetId]/config**
```typescript
// 用途: フォーム設定の更新
// 認証: 管理者認証必須
// レート制限: 10req/min

interface UpdatePresetConfigRequest {
  params: {
    presetId: string;
  };
  body: {
    form_settings?: Partial<FormSettingsUpdateInput>;
    preset_products?: Array<{
      id?: number;
      product_id: number;
      start_date: string;
      end_date: string;
      display_order?: number;
      is_active?: boolean;
    }>;
    pickup_windows?: Array<{
      id?: number;
      start_date: string;
      end_date: string;
      start_time?: string;
      end_time?: string;
      available_slots?: number;
      is_available?: boolean;
    }>;
  };
}

interface UpdatePresetConfigResponse {
  success: true;
  data: {
    message: string;
  };
  timestamp: string;
  meta: {
    presetId: number;
    updatedFields: string[];
  };
}
```

#### **予約管理API**

##### **POST /api/reservations**
```typescript
// 用途: 新規予約作成
// 認証: 不要（LIFF経由）
// レート制限: 5req/min

interface CreateReservationRequest {
  body: {
    preset_id: number;
    user_name: string;
    furigana?: string;
    gender?: '男性' | '女性' | 'その他';
    birthday?: string; // YYYY-MM-DD
    phone_number: string;
    zip_code?: string;
    address1?: string;
    address2?: string;
    comment?: string;
    selected_products: Array<{
      product_id: number;
      product_name: string;
      variation_name: string;
      quantity: number;
      unit_price: number;
      total_price: number;
      tax_type: '内税' | '外税';
    }>;
    pickup_date?: string; // ISO 8601
    total_amount: number;
    line_user_id?: string;
  };
}

interface CreateReservationResponse {
  success: true;
  data: {
    reservation: {
      id: string; // UUID
      preset_id: number;
      reservation_number: string; // R20250829-0001
      user_name: string;
      phone_number: string;
      total_amount: number;
      status: 'confirmed';
      created_at: string;
      cancel_url: string; // キャンセル用URL
    };
    preset_name: string;
  };
  timestamp: string;
  meta: {
    line_notification_sent: boolean;
    estimated_pickup_time?: string;
  };
}

// バリデーションエラー例
interface CreateReservationValidationError {
  success: false;
  error: 'バリデーションエラー';
  code: 'VALIDATION_ERROR';
  message: 'Validation failed.';
  details: string[];
  timestamp: string;
}
```

##### **GET /api/reservations/[reservationId]**
```typescript
// 用途: 予約詳細取得（キャンセル・変更用）
// 認証: 電話番号認証 or キャンセルトークン
// レート制限: 20req/min

interface GetReservationRequest {
  params: {
    reservationId: string; // UUID
  };
  query: {
    phone?: string;     // 電話番号認証
    token?: string;     // キャンセルトークン認証
  };
}

interface GetReservationResponse {
  success: true;
  data: {
    id: string;
    preset_id: number;
    reservation_number: string;
    user_name: string;
    furigana?: string;
    gender?: string;
    birthday?: string;
    phone_number: string;
    zip_code?: string;
    address1?: string;
    address2?: string;
    comment?: string;
    selected_products: SelectedProduct[];
    pickup_date?: string;
    total_amount: number;
    status: 'confirmed' | 'cancelled' | 'completed';
    line_user_id?: string;
    created_at: string;
    updated_at: string;
  };
  timestamp: string;
  meta: {
    editable_fields: string[];
    can_cancel: boolean;
    cancel_deadline?: string;
  };
}
```

##### **PUT /api/reservations/[reservationId]**
```typescript
// 用途: 予約内容変更
// 認証: 電話番号認証 or キャンセルトークン
// レート制限: 5req/min

interface UpdateReservationRequest {
  params: {
    reservationId: string;
  };
  query: {
    phone?: string;
    token?: string;
  };
  body: {
    user_name?: string;
    furigana?: string;
    gender?: '男性' | '女性' | 'その他';
    birthday?: string;
    phone_number?: string;
    zip_code?: string;
    address1?: string;
    address2?: string;
    comment?: string;
    selected_products?: SelectedProduct[];
    pickup_date?: string;
    total_amount?: number;
  };
}

interface UpdateReservationResponse {
  success: true;
  data: {
    message: string;
    updated_fields: string[];
  };
  timestamp: string;
  meta: {
    line_notification_sent: boolean;
    price_difference?: number;
  };
}
```

##### **DELETE /api/reservations/[reservationId]**
```typescript
// 用途: 予約キャンセル
// 認証: 電話番号認証 or キャンセルトークン
// レート制限: 3req/min

interface CancelReservationRequest {
  params: {
    reservationId: string;
  };
  query: {
    phone?: string;
    token?: string;
  };
  body?: {
    cancellation_reason?: string;
  };
}

interface CancelReservationResponse {
  success: true;
  data: {
    message: string;
    cancelled_at: string;
    refund_info?: {
      amount: number;
      method: string;
      estimated_date: string;
    };
  };
  timestamp: string;
  meta: {
    line_notification_sent: boolean;
    original_amount: number;
  };
}
```

#### **管理画面API**

##### **GET /api/admin/dashboard**
```typescript
// 用途: ダッシュボードデータ取得
// 認証: 管理者認証必須
// レート制限: 30req/min

interface GetDashboardResponse {
  success: true;
  data: {
    stats: {
      today_reservations: number;
      week_reservations: number;
      month_reservations: number;
      total_revenue: number;
      active_presets: number;
      total_products: number;
    };
    recent_reservations: Array<{
      id: string;
      user_name: string;
      phone_number: string;
      product: string[];
      total_amount: number;
      status: string;
      created_at: string;
    }>;
    system_health: {
      database: 'healthy' | 'warning' | 'error';
      line_api: 'healthy' | 'warning' | 'error';
      storage: 'healthy' | 'warning' | 'error';
    };
  };
  timestamp: string;
}
```

##### **GET /api/admin/products**
```typescript
// 用途: 商品一覧取得（管理用）
// 認証: 管理者認証必須
// レート制限: 60req/min

interface GetAdminProductsRequest {
  query: {
    page?: string;           // ページ番号（デフォルト: 1）
    limit?: string;          // 1ページあたりの件数（デフォルト: 20、最大: 100）
    name?: string;           // 商品名検索
    min_price?: string;      // 最小価格
    max_price?: string;      // 最大価格
    variation_name?: string; // バリエーション名検索
    tax_type?: '内税' | '外税'; // 税区分
    visible?: 'true' | 'false'; // 表示フラグ
    sort_by?: 'name' | 'price' | 'created_at' | 'display_order'; // ソート項目
    sort_order?: 'asc' | 'desc'; // ソート順
  };
}

interface GetAdminProductsResponse {
  success: true;
  data: Product[];
  pagination: {
    page: number;
    per_page: number;
    total_items: number;
    total_pages: number;
    has_next_page: boolean;
    has_previous_page: boolean;
  };
  timestamp: string;
  meta: {
    filters_applied: Record<string, string>;
    total_visible_products: number;
    total_hidden_products: number;
  };
}
```

##### **POST /api/admin/products**
```typescript
// 用途: 商品作成
// 認証: 管理者認証必須
// レート制限: 10req/min

interface CreateProductRequest {
  body: {
    name: string;
    variation_id?: number;
    variation_name?: string;
    tax_type?: '内税' | '外税';
    price: number;
    product_code?: string;
    barcode?: string;
    visible?: boolean;
    display_order?: number;
  };
}

interface CreateProductResponse {
  success: true;
  data: Product;
  timestamp: string;
  meta: {
    auto_generated_fields: string[];
  };
}
```

##### **POST /api/admin/products/import**
```typescript
// 用途: CSV一括登録
// 認証: 管理者認証必須
// レート制限: 2req/min

interface ImportProductsRequest {
  body: FormData; // CSV file
  query: {
    preset_id?: string; // プリセットに自動追加
  };
}

interface ImportProductsResponse {
  success: true;
  data: {
    imported: number;
    skipped: number;
    errors: Array<{
      row: number;
      field?: string;
      message: string;
      data?: Record<string, unknown>;
    }>;
    warnings: Array<{
      row: number;
      field?: string;
      message: string;
      data?: Record<string, unknown>;
    }>;
  };
  timestamp: string;
  meta: {
    total_rows_processed: number;
    processing_time_ms: number;
    preset_auto_added?: boolean;
  };
}
```

### **3. エラーハンドリング仕様**

#### **カスタムエラークラス**
```typescript
// 基底エラークラス
abstract class AppError extends Error {
  abstract readonly statusCode: number;
  abstract readonly code: string;
  readonly timestamp: string;
  readonly isOperational: boolean = true;

  constructor(message: string, public readonly cause?: Error) {
    super(message);
    this.name = this.constructor.name;
    this.timestamp = new Date().toISOString();
    Error.captureStackTrace(this, this.constructor);
  }
}

// 具体的なエラークラス
class ValidationError extends AppError {
  readonly statusCode = 400;
  readonly code = 'VALIDATION_ERROR';
  
  constructor(message: string, public readonly field?: string) {
    super(message);
  }
}

class AuthenticationError extends AppError {
  readonly statusCode = 401;
  readonly code = 'AUTHENTICATION_REQUIRED';
}

class AuthorizationError extends AppError {
  readonly statusCode = 403;
  readonly code = 'AUTHORIZATION_FAILED';
}

class NotFoundError extends AppError {
  readonly statusCode = 404;
  readonly code = 'RESOURCE_NOT_FOUND';
  
  constructor(resource: string, id: string | number) {
    super(`${resource} not found: ${id}`);
  }
}

class ConflictError extends AppError {
  readonly statusCode = 409;
  readonly code = 'RESOURCE_CONFLICT';
}

class RateLimitError extends AppError {
  readonly statusCode = 429;
  readonly code = 'RATE_LIMIT_EXCEEDED';
  
  constructor(message: string, public readonly retryAfter?: number) {
    super(message);
  }
}

class DatabaseError extends AppError {
  readonly statusCode = 500;
  readonly code = 'DATABASE_ERROR';
}

class ExternalServiceError extends AppError {
  readonly statusCode = 502;
  readonly code = 'EXTERNAL_SERVICE_ERROR';
  
  constructor(message: string, public readonly service: string) {
    super(message);
  }
}
```

#### **統一エラーハンドラー**
```typescript
export const handleApiError = (error: unknown, context?: string): NextResponse => {
  // エラーログ記録
  logError(error, context);

  // AppErrorの処理
  if (error instanceof AppError) {
    return createErrorResponse(error);
  }

  // Supabaseエラーの処理
  if (isSupabaseError(error)) {
    const dbError = new DatabaseError('データベースエラーが発生しました', error as Error);
    return createErrorResponse(dbError);
  }

  // 予期しないエラー
  const unexpectedError = new DatabaseError('予期しないエラーが発生しました', error as Error);
  return createErrorResponse(unexpectedError);
};

const createErrorResponse = (error: AppError): NextResponse => {
  const response: ApiErrorResponse = {
    success: false,
    error: error.message,
    code: error.code,
    message: getEnglishMessage(error.code),
    timestamp: error.timestamp
  };

  // 開発環境ではスタックトレースを含める
  if (process.env.NODE_ENV === 'development' && error.stack) {
    response.details = error.stack;
  }

  return NextResponse.json(response, { status: error.statusCode });
};
```
"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[976],{9976:function(e,t,r){r.d(t,{M:function(){return a}});var i=r(2141);class a{static async checkDatabaseConstraints(){try{let{data:e,error:t}=await i.O.from("products").select("id, name, barcode").limit(5);if(t)return;null==e||e.map(e=>e.name),null==e||e.filter(e=>e.barcode).map(e=>e.barcode)}catch(e){}}static async getAllProducts(){let{data:e,error:t}=await i.O.from("products").select("*").order("created_at",{ascending:!1});if(t)throw t;return e||[]}static async getActiveProducts(){let{data:e,error:t}=await i.O.from("products").select("*").eq("is_available",!0).order("created_at",{ascending:!1});if(t)throw t;return e||[]}static async getProductsByCategory(e){let{data:t,error:r}=await i.O.from("products").select("*").eq("category_id",e).eq("is_available",!0).order("created_at",{ascending:!1});if(r)throw r;return t||[]}static async createProduct(e){try{var t,r,a,o,c,n,l,d;let s=(null===(t=e.barcode)||void 0===t?void 0:t.trim())||null;if(s){let{data:e,error:t}=await i.O.from("products").select("id, name, barcode").eq("barcode",s).single();if(e)throw Error("このバーコード「".concat(s,"」は既に商品「").concat(e.name,"」で使用されています。別のバーコードを使用してください。"))}let{data:u,error:m}=await i.O.from("products").select("id, name").eq("name",e.name).single();if(u)throw Error("商品名「".concat(e.name,"」は既に登録されています。別の商品名を使用してください。"));let p={name:null===(r=e.name)||void 0===r?void 0:r.trim(),description:(null===(a=e.description)||void 0===a?void 0:a.trim())||null,price:Number(e.price)||0,category_id:(null===(o=e.category_id)||void 0===o?void 0:o.trim())||null,unit:(null===(c=e.unit)||void 0===c?void 0:c.trim())||null,min_order_quantity:Number(e.min_order_quantity)||1,max_order_quantity:e.max_order_quantity?Number(e.max_order_quantity):null,variation_name:(null===(n=e.variation_name)||void 0===n?void 0:n.trim())||null,image_url:(null===(l=e.image_url)||void 0===l?void 0:l.trim())||null,barcode:s,tax_type:e.tax_type||"inclusive",is_available:!1!==e.is_available,display_order:e.display_order||0},{data:v,error:_}=await i.O.from("products").insert(p).select("*").single();if(_){if("23505"===_.code){let e=_.details||_.message||"";if(e.includes("barcode"))throw Error("このバーコードは既に登録されています。別のバーコードを使用してください。");if(e.includes("name"))throw Error("この商品名は既に登録されています。別の商品名を使用してください。");if(e.includes("pkey")||e.includes("Primary key"))throw Error("内部エラー: 商品IDの重複が発生しました。再度お試しください。");throw Error("重複エラー: ".concat(e))}if(null===(d=_.code)||void 0===d?void 0:d.startsWith("23")){let e={23502:"必須フィールドが入力されていません",23503:"関連データが存在しません（カテゴリIDなど）",23514:"入力値が制約に違反しています"}[_.code]||"制約違反エラーが発生しました";throw Error("".concat(e,": ").concat(_.message))}throw _}return v}catch(e){throw e}}static async updateProduct(e,t){let{data:r,error:a}=await i.O.from("products").update({...t,category_id:t.category_id||null,updated_at:new Date().toISOString()}).eq("id",e).select("*").single();if(a)throw a;return r}static async deleteProduct(e){let{error:t}=await i.O.from("products").delete().eq("id",e);if(t)throw t;return!0}static async getAllCategories(){let{data:e,error:t}=await i.O.from("product_categories").select("*").eq("is_active",!0).order("display_order",{ascending:!0});if(t)throw t;return e||[]}static async bulkImportProducts(e){let t={success:0,failed:0,errors:[],warnings:[]},r=[];for(let i=0;i<e.length;i++){let a=e[i],o=i+2;if(!a.name||""===a.name.trim()){t.failed++,t.errors.push("行".concat(o,": 商品名が入力されていません"));continue}void 0!==a.price&&(isNaN(Number(a.price))||0>Number(a.price))&&(t.warnings.push("行".concat(o,": 価格が無効です。0に設定されます")),a.price=0),!a.id&&await this.getProductByName(a.name.trim())&&t.warnings.push("行".concat(o,": 商品「").concat(a.name,"」は既に存在します")),r.push({...a,lineNumber:o})}for(let e of r)try{var i,a,o,c,n,l;if(e.id){if(!await this.getProductById(e.id)){t.failed++,t.errors.push("行".concat(e.lineNumber,": ID「").concat(e.id,"」の商品が見つかりません"));continue}await this.updateProduct(e.id,{name:e.name.trim(),barcode:(null===(i=e.barcode)||void 0===i?void 0:i.trim())||void 0,price:e.price||0,variation_name:(null===(a=e.variation_name)||void 0===a?void 0:a.trim())||void 0,tax_type:e.tax_type||"inclusive",category_id:e.category_id||void 0,description:(null===(o=e.description)||void 0===o?void 0:o.trim())||void 0})}else await this.createProduct({name:e.name.trim(),barcode:(null===(c=e.barcode)||void 0===c?void 0:c.trim())||void 0,price:e.price||0,variation_name:(null===(n=e.variation_name)||void 0===n?void 0:n.trim())||void 0,tax_type:e.tax_type||"inclusive",category_id:e.category_id||void 0,description:(null===(l=e.description)||void 0===l?void 0:l.trim())||void 0,is_available:!0,display_order:0});t.success++}catch(i){t.failed++;let r=(null==i?void 0:i.message)||(null==i?void 0:i.toString())||"不明なエラー";t.errors.push("行".concat(e.lineNumber,": 商品「").concat(e.name,"」: ").concat(r))}return t}static async getProductByName(e){let{data:t,error:r}=await i.O.from("products").select("id, name").eq("name",e).limit(1);if(r)throw r;return(null==t?void 0:t[0])||null}static async getProductById(e){let{data:t,error:r}=await i.O.from("products").select("*").eq("id",e).limit(1);if(r)throw r;return(null==t?void 0:t[0])||null}static parseCSV(e){try{let t=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").trim().split("\n").filter(e=>e.trim());if(t.length<2)throw Error("CSVファイルが空か、ヘッダー行しかありません。最低でもヘッダー行とデータ行が必要です。");let r=t[0].trim();if(!r)throw Error("ヘッダー行が空です");let i=this.parseCSVLine(r).map(e=>e.trim().replace(/^["']|["']$/g,""));if(0===i.length)throw Error("ヘッダー行を解析できませんでした");let a=[],o=[],c=i.map(e=>e.toLowerCase()),n=["name"].filter(e=>!c.includes(e.toLowerCase()));if(n.length>0)throw Error("必須の列が見つかりません: ".concat(n.join(", "),"\n\n検出された列: ").concat(i.join(", "),"\n\n列名は大文字小文字を区別しません。"));for(let e=1;e<t.length;e++){let r=t[e].trim();if(r)try{let t=this.parseCSVLine(r);t.length,i.length;let c={},n=!1;i.forEach((r,i)=>{var a;let l=(null===(a=t[i])||void 0===a?void 0:a.trim().replace(/^["']|["']$/g,""))||"";switch(r.toLowerCase()){case"id":l&&(c.id=l);break;case"name":l?c.name=l:(o.push("行".concat(e+1,": 商品名が入力されていません")),n=!0);break;case"barcode":l&&(c.barcode=l);break;case"price":if(l){let t=parseFloat(l.replace(/[￥,]/g,""));isNaN(t)||t<0?o.push("行".concat(e+1,": 価格「").concat(l,"」が無効です（数値または0以上の値を入力してください）")):c.price=t}break;case"variation_name":l&&(c.variation_name=l);break;case"tax_type":if(l){let t=l.toLowerCase().trim();"内税"===t||"inclusive"===t?c.tax_type="inclusive":"外税"===t||"exclusive"===t?c.tax_type="exclusive":["inclusive","exclusive"].includes(t)?c.tax_type=t:o.push("行".concat(e+1,": 税区分「").concat(l,"」が無効です（内税/外税 または inclusive/exclusiveのみ）"))}break;case"category_id":l&&(c.category_id=l);break;case"description":l&&(c.description=l)}}),!n&&c.name&&a.push(c)}catch(t){o.push("行".concat(e+1,": 行の解析に失敗しました - ").concat(t.message))}}if(o.length>0){let e="CSVファイルに".concat(o.length,"個のエラーがあります:\n\n").concat(o.join("\n"));throw Error(e)}if(0===a.length)throw Error("有効な商品データが見つかりませんでした。\n\n以下を確認してください:\n• name列に値が入力されているか\n• データ行が存在するか\n• ファイル形式が正しいか");return a}catch(t){let e=t.message||"不明なエラーが発生しました";throw Error("CSV解析エラー: ".concat(e))}}static parseCSVLine(e){let t=[],r="",i=!1;for(let a=0;a<e.length;a++){let o=e[a];'"'===o||"'"===o?i&&e[a+1]===o?(r+=o,a++):i=!i:","!==o||i?r+=o:(t.push(r),r="")}return t.push(r),t}static generateCSVTemplate(e){var t;return"id,name,barcode,price,variation_name,tax_type,category_id,description\n"+["","トマト苗","4901234567890","300","通常価格","inclusive",(null===(t=e[0])||void 0===t?void 0:t.id)||"","中玉トマトの苗"].join(",")}static async exportToCSV(){return["id,name,barcode,price,variation_name,tax_type,category_id,description",...(await this.getAllProducts()).map(e=>[e.id,'"'.concat(e.name,'"'),e.barcode||"",e.price,e.variation_name||"",e.tax_type||"",e.category_id||"",'"'.concat(e.description||"",'"')].join(","))].join("\n")}}}}]);
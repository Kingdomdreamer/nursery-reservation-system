(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[11],{5461:function(e,s,t){Promise.resolve().then(t.bind(t,8068))},8068:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return r}});var a=t(7437),i=t(2265),c=t(2141),l=t(9703),n=t(1254);function r(){let{showSuccess:e,showError:s}=(0,l.p)(),[t,r]=(0,i.useState)(!1),[d,o]=(0,i.useState)([]),[m,u]=(0,i.useState)([]),[h,x]=(0,i.useState)([]),[b,j]=(0,i.useState)(null),[p,N]=(0,i.useState)(!1),[_,v]=(0,i.useState)({customer_id:"",customer_name:"",customer_phone:"",customer_email:"",reservation_date:"",pickup_time_start:"",pickup_time_end:"",notes:"",admin_notes:"",items:[]});(0,i.useEffect)(()=>{f(),g(),y()},[]);let f=async()=>{try{let{data:e,error:s}=await c.O.from("customers").select("*").order("full_name",{ascending:!0});if(s)throw s;o(e||[])}catch(e){}},g=async()=>{try{let{data:e,error:s}=await c.O.from("products").select("\n          *,\n          category:product_categories(*)\n        ").eq("is_available",!0).order("name",{ascending:!0});if(s)throw s;u(e||[])}catch(e){}},y=async()=>{try{let{data:e,error:s}=await c.O.from("product_categories").select("*").eq("is_active",!0).order("name",{ascending:!0});if(s)throw s;x(e||[])}catch(e){}},w=e=>{let s=d.find(s=>s.id===e);s&&(j(s),v(e=>({...e,customer_id:s.id,customer_name:s.full_name,customer_phone:s.phone,customer_email:s.email||""})),N(!1))},k=e=>{_.items.find(s=>s.product_id===e.id)?v(s=>({...s,items:s.items.map(s=>s.product_id===e.id?{...s,quantity:s.quantity+1,subtotal:(s.quantity+1)*s.unit_price}:s)})):v(s=>({...s,items:[...s.items,{product_id:e.id,product_name:e.name,quantity:1,unit_price:e.price,subtotal:e.price}]}))},S=(e,s)=>{s<=0?v(s=>({...s,items:s.items.filter(s=>s.product_id!==e)})):v(t=>({...t,items:t.items.map(t=>t.product_id===e?{...t,quantity:s,subtotal:s*t.unit_price}:t)}))},C=e=>{v(s=>({...s,items:s.items.filter(s=>s.product_id!==e)}))},I=()=>_.items.reduce((e,s)=>e+s.subtotal,0),q=async t=>{t.preventDefault(),r(!0);try{let s=_.customer_id;if(p){let{data:e,error:t}=await c.O.from("customers").insert([{full_name:_.customer_name,phone:_.customer_phone,email:_.customer_email||null}]).select().single();if(t)throw t;s=e.id}let t="R".concat(Date.now().toString().slice(-8)),{data:a,error:i}=await c.O.from("reservations").insert([{reservation_number:t,customer_id:s,reservation_date:_.reservation_date,pickup_time_start:_.pickup_time_start||null,pickup_time_end:_.pickup_time_end||null,total_amount:I(),final_amount:I(),discount_amount:0,status:"pending",notes:_.notes||null,admin_notes:_.admin_notes||null}]).select().single();if(i)throw i;let l=_.items.map(e=>({reservation_id:a.id,product_id:e.product_id,quantity:e.quantity,unit_price:e.unit_price,subtotal:e.subtotal})),{error:n}=await c.O.from("reservation_items").insert(l);if(n)throw n;e("予約が作成されました","予約番号: ".concat(t)),window.location.href="/admin/reservations"}catch(e){s("予約の作成に失敗しました","予約の作成中にエラーが発生しました。")}finally{r(!1)}},O=[];for(let e=9;e<=17;e++)for(let s=0;s<60;s+=30){let t="".concat(e.toString().padStart(2,"0"),":").concat(s.toString().padStart(2,"0")),a=30===s?e+1:e,i=30===s?0:s+30,c="".concat(a.toString().padStart(2,"0"),":").concat(i.toString().padStart(2,"0"));a<=18&&O.push({start:t,end:c,label:"".concat(t," - ").concat(c)})}return(0,a.jsx)(n.Z,{children:(0,a.jsxs)("div",{className:"container-fluid",children:[(0,a.jsx)("div",{className:"row mb-4",children:(0,a.jsx)("div",{className:"col-12",children:(0,a.jsxs)("div",{className:"d-flex justify-content-between align-items-center",children:[(0,a.jsx)("h1",{className:"h2 fw-bold text-dark",children:"新規予約追加"}),(0,a.jsxs)("button",{onClick:()=>window.location.href="/admin/reservations",className:"btn btn-outline-secondary",children:[(0,a.jsx)("i",{className:"bi bi-arrow-left me-2"}),"戻る"]})]})})}),(0,a.jsx)("form",{onSubmit:q,children:(0,a.jsxs)("div",{className:"row",children:[(0,a.jsx)("div",{className:"col-lg-6 mb-4",children:(0,a.jsxs)("div",{className:"card",children:[(0,a.jsx)("div",{className:"card-header",children:(0,a.jsx)("h5",{className:"card-title mb-0",children:"顧客情報"})}),(0,a.jsxs)("div",{className:"card-body",children:[(0,a.jsxs)("div",{className:"form-check mb-3",children:[(0,a.jsx)("input",{className:"form-check-input",type:"checkbox",id:"newCustomer",checked:p,onChange:()=>{N(!p),p||(j(null),v(e=>({...e,customer_id:"",customer_name:"",customer_phone:"",customer_email:""})))}}),(0,a.jsx)("label",{className:"form-check-label",htmlFor:"newCustomer",children:"新規顧客"})]}),p?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"mb-3",children:[(0,a.jsx)("label",{className:"form-label",children:"顧客名 *"}),(0,a.jsx)("input",{type:"text",className:"form-control",value:_.customer_name,onChange:e=>v(s=>({...s,customer_name:e.target.value})),required:!0})]}),(0,a.jsxs)("div",{className:"mb-3",children:[(0,a.jsx)("label",{className:"form-label",children:"電話番号 *"}),(0,a.jsx)("input",{type:"tel",className:"form-control",value:_.customer_phone,onChange:e=>v(s=>({...s,customer_phone:e.target.value})),required:!0})]}),(0,a.jsxs)("div",{className:"mb-3",children:[(0,a.jsx)("label",{className:"form-label",children:"メールアドレス"}),(0,a.jsx)("input",{type:"email",className:"form-control",value:_.customer_email,onChange:e=>v(s=>({...s,customer_email:e.target.value}))})]})]}):(0,a.jsxs)("div",{className:"mb-3",children:[(0,a.jsx)("label",{className:"form-label",children:"既存顧客を選択"}),(0,a.jsxs)("select",{className:"form-select",value:(null==b?void 0:b.id)||"",onChange:e=>w(e.target.value),required:!0,children:[(0,a.jsx)("option",{value:"",children:"顧客を選択してください"}),d.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.full_name," (",e.phone,")"]},e.id))]})]})]})]})}),(0,a.jsx)("div",{className:"col-lg-6 mb-4",children:(0,a.jsxs)("div",{className:"card",children:[(0,a.jsx)("div",{className:"card-header",children:(0,a.jsx)("h5",{className:"card-title mb-0",children:"予約日時"})}),(0,a.jsxs)("div",{className:"card-body",children:[(0,a.jsxs)("div",{className:"mb-3",children:[(0,a.jsx)("label",{className:"form-label",children:"受取日 *"}),(0,a.jsx)("input",{type:"date",className:"form-control",value:_.reservation_date,onChange:e=>v(s=>({...s,reservation_date:e.target.value})),min:new Date().toISOString().split("T")[0],required:!0})]}),(0,a.jsxs)("div",{className:"mb-3",children:[(0,a.jsx)("label",{className:"form-label",children:"受取時間"}),(0,a.jsxs)("select",{className:"form-select",value:_.pickup_time_start,onChange:e=>{let s=O.find(s=>s.start===e.target.value);s&&v(e=>({...e,pickup_time_start:s.start,pickup_time_end:s.end}))},children:[(0,a.jsx)("option",{value:"",children:"時間を選択してください"}),O.map(e=>(0,a.jsx)("option",{value:e.start,children:e.label},e.start))]})]})]})]})}),(0,a.jsx)("div",{className:"col-12 mb-4",children:(0,a.jsxs)("div",{className:"card",children:[(0,a.jsx)("div",{className:"card-header",children:(0,a.jsx)("h5",{className:"card-title mb-0",children:"商品選択"})}),(0,a.jsx)("div",{className:"card-body",children:(0,a.jsx)("div",{className:"row",children:m.map(e=>{var s;return(0,a.jsx)("div",{className:"col-md-4 mb-3",children:(0,a.jsx)("div",{className:"card",children:(0,a.jsxs)("div",{className:"card-body",children:[(0,a.jsx)("h6",{className:"card-title",children:e.name}),(0,a.jsx)("p",{className:"card-text small text-muted",children:null===(s=e.category)||void 0===s?void 0:s.name}),(0,a.jsx)("p",{className:"card-text",children:(0,a.jsxs)("strong",{children:["\xa5",e.price.toLocaleString()]})}),(0,a.jsxs)("button",{type:"button",className:"btn btn-sm text-white",style:{background:"linear-gradient(135deg, #8bc34a 0%, #7cb342 100%)",border:"none"},onClick:()=>k(e),children:[(0,a.jsx)("i",{className:"bi bi-plus"})," 追加"]})]})})},e.id)})})})]})}),_.items.length>0&&(0,a.jsx)("div",{className:"col-12 mb-4",children:(0,a.jsxs)("div",{className:"card",children:[(0,a.jsx)("div",{className:"card-header",children:(0,a.jsx)("h5",{className:"card-title mb-0",children:"選択した商品"})}),(0,a.jsx)("div",{className:"card-body",children:(0,a.jsx)("div",{className:"table-responsive",children:(0,a.jsxs)("table",{className:"table",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{children:"商品名"}),(0,a.jsx)("th",{children:"単価"}),(0,a.jsx)("th",{children:"数量"}),(0,a.jsx)("th",{children:"小計"}),(0,a.jsx)("th",{children:"操作"})]})}),(0,a.jsx)("tbody",{children:_.items.map(e=>(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{children:e.product_name}),(0,a.jsxs)("td",{children:["\xa5",e.unit_price.toLocaleString()]}),(0,a.jsx)("td",{children:(0,a.jsxs)("div",{className:"d-flex align-items-center",children:[(0,a.jsx)("button",{type:"button",className:"btn btn-outline-secondary btn-sm me-2",onClick:()=>S(e.product_id,e.quantity-1),children:"-"}),(0,a.jsx)("span",{className:"mx-2",children:e.quantity}),(0,a.jsx)("button",{type:"button",className:"btn btn-outline-secondary btn-sm ms-2",onClick:()=>S(e.product_id,e.quantity+1),children:"+"})]})}),(0,a.jsxs)("td",{children:["\xa5",e.subtotal.toLocaleString()]}),(0,a.jsx)("td",{children:(0,a.jsx)("button",{type:"button",className:"btn btn-outline-danger btn-sm",onClick:()=>C(e.product_id),children:(0,a.jsx)("i",{className:"bi bi-trash"})})})]},e.product_id))}),(0,a.jsx)("tfoot",{children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{colSpan:3,children:"合計"}),(0,a.jsxs)("th",{children:["\xa5",I().toLocaleString()]}),(0,a.jsx)("th",{})]})})]})})})]})}),(0,a.jsx)("div",{className:"col-12 mb-4",children:(0,a.jsxs)("div",{className:"card",children:[(0,a.jsx)("div",{className:"card-header",children:(0,a.jsx)("h5",{className:"card-title mb-0",children:"備考"})}),(0,a.jsxs)("div",{className:"card-body",children:[(0,a.jsxs)("div",{className:"mb-3",children:[(0,a.jsx)("label",{className:"form-label",children:"顧客備考"}),(0,a.jsx)("textarea",{className:"form-control",rows:3,value:_.notes,onChange:e=>v(s=>({...s,notes:e.target.value})),placeholder:"顧客からの特別な要望など"})]}),(0,a.jsxs)("div",{className:"mb-3",children:[(0,a.jsx)("label",{className:"form-label",children:"管理メモ"}),(0,a.jsx)("textarea",{className:"form-control",rows:3,value:_.admin_notes,onChange:e=>v(s=>({...s,admin_notes:e.target.value})),placeholder:"管理者向けメモ"})]})]})]})}),(0,a.jsx)("div",{className:"col-12",children:(0,a.jsxs)("div",{className:"d-flex justify-content-end gap-3",children:[(0,a.jsx)("button",{type:"button",className:"btn btn-secondary",onClick:()=>window.location.href="/admin/reservations",children:"キャンセル"}),(0,a.jsx)("button",{type:"submit",disabled:t||0===_.items.length,className:"btn text-white",style:{background:"linear-gradient(135deg, #8bc34a 0%, #7cb342 100%)",border:"none"},children:t?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{className:"spinner-border spinner-border-sm me-2"}),"作成中..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("i",{className:"bi bi-check-circle me-2"}),"予約を作成"]})})]})})]})})]})})}},2141:function(e,s,t){"use strict";t.d(s,{O:function(){return a}});let a=(0,t(6580).eI)("https://uscvsipskkbegcfktjyt.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzY3ZzaXBza2tiZWdjZmt0anl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0MDI4MzUsImV4cCI6MjA2Nzk3ODgzNX0.VhcGWXb-PpHTfqPApSIG4C6xXLik8JClsNhOdJIgdzw")}},function(e){e.O(0,[454,580,448,254,362,744],function(){return e(e.s=5461)}),_N_E=e.O()}]);
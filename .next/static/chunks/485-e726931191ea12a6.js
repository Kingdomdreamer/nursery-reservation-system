"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[485],{3485:function(e,a,s){s.d(a,{Z:function(){return n}});var i=s(7437),l=s(2265),r=s(9976),t=s(9703);function n(){let{showSuccess:e,showError:a,showWarning:s}=(0,t.p)(),[n,c]=(0,l.useState)([]),[d,o]=(0,l.useState)(!1),[m,x]=(0,l.useState)("single"),[h,u]=(0,l.useState)(null),[b,v]=(0,l.useState)(""),[p,j]=(0,l.useState)([]),[g,N]=(0,l.useState)(!1),[y,f]=(0,l.useState)({name:"",category_id:"",description:"",price:0,barcode:"",variation_name:"",tax_type:"inclusive",image_url:"",is_available:!0,display_order:0,unit:"",min_order_quantity:1,max_order_quantity:0}),[_,w]=(0,l.useState)(null),[C,k]=(0,l.useState)(!1),S=(0,l.useCallback)(async()=>{try{let e=await r.M.getAllCategories();c(e)}catch(e){a("カテゴリの取得に失敗しました","カテゴリ情報を読み込めませんでした。ページを再読み込みしてください。"),c([])}},[]);(0,l.useEffect)(()=>{S()},[S]);let E=async e=>new Promise((a,s)=>{let i=new FileReader;i.onload=e=>{var s;a(null===(s=e.target)||void 0===s?void 0:s.result)},i.onerror=()=>s(Error("ファイルの読み込みに失敗しました")),i.readAsDataURL(e)}),V=async()=>{if(!_)return"";k(!0);try{return await E(_)}catch(e){return a("画像のアップロードに失敗しました","画像の処理中にエラーが発生しました。"),""}finally{k(!1)}},F=async s=>{s.preventDefault(),o(!0);try{var i,l,t,n,c;let a=y.image_url;if(_&&!(a=await V())){o(!1);return}let s={name:y.name.trim(),description:(null===(i=y.description)||void 0===i?void 0:i.trim())||void 0,price:Number(y.price)||0,category_id:(null===(l=y.category_id)||void 0===l?void 0:l.trim())||void 0,unit:(null===(t=y.unit)||void 0===t?void 0:t.trim())||void 0,min_order_quantity:Number(y.min_order_quantity)||1,max_order_quantity:y.max_order_quantity&&y.max_order_quantity>0?Number(y.max_order_quantity):void 0,variation_name:(null===(n=y.variation_name)||void 0===n?void 0:n.trim())||void 0,image_url:(null==a?void 0:a.trim())||void 0,barcode:(null===(c=y.barcode)||void 0===c?void 0:c.trim())||void 0,tax_type:y.tax_type,is_available:y.is_available,display_order:y.display_order};await r.M.createProduct(s),e("商品を追加しました","商品が正常に登録されました。"),f({name:"",category_id:"",description:"",price:0,barcode:"",variation_name:"",tax_type:"inclusive",image_url:"",is_available:!0,display_order:0,unit:"",min_order_quantity:1,max_order_quantity:0}),w(null)}catch(e){a("商品の追加に失敗しました",(null==e?void 0:e.message)||"商品の登録中にエラーが発生しました。")}finally{o(!1)}},q=async()=>{if(!h){a("ファイル未選択","CSVファイルを選択してください");return}try{if(h.size>1048576)throw Error("ファイルサイズが大きすぎます（".concat(Math.round(1),"MB以下のファイルをアップロードしてください）\n現在のサイズ: ").concat(Math.round(h.size/1024*100)/100,"KB\n\n大きなファイルの場合は、行数を減らしてから再度お試しください。"));if(0===h.size)throw Error("ファイルが空です");if(!h.name.toLowerCase().endsWith(".csv")&&!h.name.toLowerCase().endsWith(".txt"))throw Error("CSVファイル（.csv または .txt）をアップロードしてください");let a=(await new Promise((e,a)=>{let s=new FileReader,i=setTimeout(()=>{s.abort(),a(Error("ファイル読み込みがタイムアウトしました（30秒）\n\nファイルサイズが大きすぎるか、システムリソースが不足している可能性があります。"))},3e4);s.onloadstart=()=>{},s.onprogress=e=>{e.lengthComputable&&(e.loaded,e.total)},s.onload=s=>{var l;if(clearTimeout(i),null===(l=s.target)||void 0===l?void 0:l.result){let a=s.target.result;e(a)}else a(Error("ファイルの読み込み結果が空です"))},s.onerror=e=>{clearTimeout(i);let l="ファイル読み込みエラー";if(s.error)switch(s.error.name){case"NotReadableError":l="ファイルが読み取れません（ファイルが破損しているか、使用中の可能性があります）";break;case"SecurityError":l="セキュリティエラー（ファイルへのアクセス権限がありません）";break;case"NotFoundError":l="ファイルが見つかりません";break;case"EncodingError":l="ファイルエンコーディングエラー（UTF-8以外の文字コードの可能性があります）";break;default:l="ファイル読み込みエラー: ".concat(s.error.message)}a(Error("".concat(l,"\n\n対処方法:\n• ファイルを一度保存し直す\n• 文字エンコーディングをUTF-8にする\n• ファイルサイズを小さくする\n• 別のCSVファイルで試す")))},s.onabort=()=>{clearTimeout(i),a(Error("ファイルの読み込みが中断されました"))};try{s.readAsText(h,"UTF-8")}catch(e){clearTimeout(i),a(Error("FileReader 起動エラー: ".concat(e instanceof Error?e.message:"不明なエラー")))}})).replace(/^\uFEFF/,"");if(!a.trim())throw Error("ファイルが空または読み取れませんでした");if(a.split(/\r?\n/).filter(e=>e.trim()).length<2)throw Error("CSVファイルにはヘッダー行とデータ行が必要です（最低2行）");v(a);let i=r.M.parseCSV(a);j(i),N(!0),i.length>0?e("CSVプレビュー成功","".concat(i.length,"件の商品データを読み込みました")):s("データなし","有効な商品データが見つかりませんでした")}catch(s){let e=(null==s?void 0:s.message)||"ファイルの読み込みに失敗しました";e.includes("Permission")?e="ファイルへのアクセス権限がありません。ファイルを再選択してください。":e.includes("encoding")?e="ファイルの文字エンコーディングが正しくありません。UTF-8形式で保存し直してください。":e.includes("required")&&(e="CSVファイルに必須列（name）が含まれていません。"),a("CSVファイルの解析に失敗しました","".concat(e,"\n\n以下を確認してください:\n• ファイル形式：CSV形式（.csv または .txt）\n• 文字エンコーディング：UTF-8推奨\n• 必須列：name列の存在\n• ファイルサイズ：10MB以下\n• 権限：ファイルにアクセス可能")),j([]),N(!1)}},T=async()=>{if(0!==p.length){o(!0);try{let e=await r.M.bulkImportProducts(p),a="処理結果:\n成功: ".concat(e.success,"件\n失敗: ").concat(e.failed,"件");e.warnings&&e.warnings.length>0&&(a+="\n\n⚠️ 警告:\n".concat(e.warnings.join("\n"))),e.errors.length>0&&(a+="\n\n❌ エラー:\n".concat(e.errors.join("\n"))),0===e.failed&&0===e.errors.length&&(a+="\n\n✅ すべての商品が正常に処理されました！"),confirm(a+"\n\n処理を完了しますか？")&&(u(null),v(""),j([]),N(!1))}catch(s){let e=(null==s?void 0:s.message)||(null==s?void 0:s.toString())||"不明なエラーが発生しました";a("CSV インポートに失敗しました","".concat(e,"\n\nCSVファイルの形式を確認してください。"))}finally{o(!1)}}},M=()=>r.M.generateCSVTemplate(n),U=async()=>{try{let e=await r.M.exportToCSV(),a=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(a),s.download="products_export_".concat(new Date().toISOString().split("T")[0],".csv"),s.click()}catch(e){a("CSV エクスポートに失敗しました",(null==e?void 0:e.message)||"エクスポート処理中にエラーが発生しました。")}};return(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"row mb-4",children:(0,i.jsx)("div",{className:"col-12",children:(0,i.jsxs)("div",{className:"d-flex justify-content-between align-items-center",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{className:"h3 fw-bold text-dark",children:"商品追加"}),(0,i.jsx)("p",{className:"text-muted",children:"新しい商品を登録または一括アップロードします"})]}),(0,i.jsxs)("div",{className:"d-flex gap-3",children:[(0,i.jsxs)("button",{onClick:()=>{let e=new Blob([M()],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");a.href=URL.createObjectURL(e),a.download="product_template.csv",a.click()},className:"btn btn-outline-secondary d-flex align-items-center gap-2",title:"CSV形式のテンプレートファイルをダウンロード",children:[(0,i.jsx)("i",{className:"bi bi-file-earmark-spreadsheet"}),"CSVテンプレート"]}),(0,i.jsxs)("button",{onClick:U,className:"btn btn-outline-primary d-flex align-items-center gap-2",title:"現在の商品データをCSV形式でエクスポート",children:[(0,i.jsx)("i",{className:"bi bi-download"}),"商品エクスポート"]})]})]})})}),(0,i.jsxs)("div",{className:"card",children:[(0,i.jsx)("div",{className:"card-header bg-light",children:(0,i.jsxs)("nav",{className:"nav nav-tabs card-header-tabs",children:[(0,i.jsxs)("button",{onClick:()=>x("single"),className:"nav-link ".concat("single"===m?"active":""),style:"single"===m?{background:"linear-gradient(135deg, #8bc34a 0%, #7cb342 100%)",color:"white",border:"none"}:{},children:[(0,i.jsx)("i",{className:"bi bi-plus-circle me-2"}),"単一商品追加",(0,i.jsx)("span",{className:"badge bg-light text-dark ms-2",children:"推奨"})]}),(0,i.jsxs)("button",{onClick:()=>x("csv"),className:"nav-link ".concat("csv"===m?"active":""),style:"csv"===m?{background:"linear-gradient(135deg, #8bc34a 0%, #7cb342 100%)",color:"white",border:"none"}:{},children:[(0,i.jsx)("i",{className:"bi bi-file-earmark-spreadsheet me-2"}),"CSV一括追加",(0,i.jsx)("span",{className:"badge bg-warning text-dark ms-2",children:"上級者向け"})]})]})}),(0,i.jsx)("div",{className:"card-body",children:"single"===m?(0,i.jsxs)("form",{onSubmit:F,children:[(0,i.jsxs)("div",{className:"row g-3",children:[(0,i.jsxs)("div",{className:"col-md-6",children:[(0,i.jsx)("label",{className:"form-label fw-medium",children:"商品名 *"}),(0,i.jsx)("input",{type:"text",value:y.name,onChange:e=>f({...y,name:e.target.value}),required:!0,className:"form-control"})]}),(0,i.jsxs)("div",{className:"col-md-6",children:[(0,i.jsx)("label",{className:"form-label fw-medium",children:"カテゴリ"}),(0,i.jsxs)("select",{value:y.category_id,onChange:e=>f({...y,category_id:e.target.value}),className:"form-select",children:[(0,i.jsx)("option",{value:"",children:"カテゴリを選択"}),n.map(e=>(0,i.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,i.jsxs)("div",{className:"col-md-6",children:[(0,i.jsx)("label",{className:"form-label fw-medium",children:"価格 *"}),(0,i.jsx)("input",{type:"number",value:y.price,onChange:e=>f({...y,price:Number(e.target.value)}),required:!0,min:"0",step:"0.01",className:"form-control"})]}),(0,i.jsxs)("div",{className:"col-md-6",children:[(0,i.jsx)("label",{className:"form-label fw-medium",children:"JANコード"}),(0,i.jsx)("input",{type:"text",value:y.barcode,onChange:e=>f({...y,barcode:e.target.value}),className:"form-control"})]}),(0,i.jsxs)("div",{className:"col-md-6",children:[(0,i.jsx)("label",{className:"form-label fw-medium",children:"価格バリエーション名"}),(0,i.jsx)("input",{type:"text",value:y.variation_name,onChange:e=>f({...y,variation_name:e.target.value}),placeholder:"例: 通常価格、予約価格",className:"form-control"})]}),(0,i.jsxs)("div",{className:"col-md-6",children:[(0,i.jsx)("label",{className:"form-label fw-medium",children:"税区分"}),(0,i.jsxs)("select",{value:y.tax_type,onChange:e=>f({...y,tax_type:e.target.value}),className:"form-select",children:[(0,i.jsx)("option",{value:"inclusive",children:"税込"}),(0,i.jsx)("option",{value:"exclusive",children:"税抜"})]})]})]}),(0,i.jsx)("div",{className:"row g-3 mt-3",children:(0,i.jsxs)("div",{className:"col-12",children:[(0,i.jsx)("label",{className:"form-label fw-medium",children:"商品説明"}),(0,i.jsx)("textarea",{value:y.description,onChange:e=>f({...y,description:e.target.value}),rows:3,className:"form-control"})]})}),(0,i.jsx)("div",{className:"row g-3 mt-3",children:(0,i.jsxs)("div",{className:"col-12",children:[(0,i.jsx)("label",{className:"form-label fw-medium",children:"商品画像"}),(0,i.jsxs)("div",{className:"d-flex flex-column gap-3",children:[(0,i.jsx)("input",{type:"file",accept:"image/*",onChange:e=>{var s;let i=null===(s=e.target.files)||void 0===s?void 0:s[0];if(i){if(i.size>5242880){a("ファイルサイズが大きすぎます","5MB以下のファイルを選択してください。");return}if(!i.type.startsWith("image/")){a("不正なファイル形式です","画像ファイルを選択してください。");return}w(i)}},className:"d-none",id:"image-upload"}),(0,i.jsxs)("label",{htmlFor:"image-upload",className:"btn btn-outline-secondary d-inline-flex align-items-center gap-2 w-fit",children:[(0,i.jsx)("i",{className:"bi bi-cloud-upload"}),"画像を選択"]}),_&&(0,i.jsxs)("div",{className:"d-flex align-items-center gap-3",children:[(0,i.jsxs)("div",{className:"text-muted small",children:["選択されたファイル: ",_.name]}),(0,i.jsx)("button",{type:"button",onClick:()=>w(null),className:"btn btn-outline-danger btn-sm",children:(0,i.jsx)("i",{className:"bi bi-x-circle"})})]}),_&&(0,i.jsx)("div",{className:"mt-2",children:(0,i.jsx)("img",{src:URL.createObjectURL(_),alt:"商品画像プレビュー",className:"rounded border",style:{width:"128px",height:"128px",objectFit:"cover"}})}),(0,i.jsx)("div",{className:"text-muted small",children:"推奨サイズ: 400x400px以上、最大5MB"})]})]})}),(0,i.jsx)("div",{className:"row g-3 mt-3",children:(0,i.jsx)("div",{className:"col-12",children:(0,i.jsxs)("div",{className:"form-check",children:[(0,i.jsx)("input",{type:"checkbox",id:"is_available",checked:y.is_available,onChange:e=>f({...y,is_available:e.target.checked}),className:"form-check-input"}),(0,i.jsx)("label",{htmlFor:"is_available",className:"form-check-label fw-medium",children:"販売中として追加"})]})})}),(0,i.jsx)("div",{className:"row g-3 mt-4",children:(0,i.jsx)("div",{className:"col-12",children:(0,i.jsxs)("div",{className:"d-flex justify-content-end gap-3",children:[(0,i.jsx)("button",{type:"button",onClick:()=>{f({name:"",category_id:"",description:"",price:0,barcode:"",variation_name:"",tax_type:"inclusive",image_url:"",is_available:!0,display_order:0,unit:"",min_order_quantity:1,max_order_quantity:0}),w(null)},className:"btn btn-outline-secondary",children:"リセット"}),(0,i.jsx)("button",{type:"submit",disabled:d||C,className:"btn text-white",style:{background:"linear-gradient(135deg, #8bc34a 0%, #7cb342 100%)",border:"none"},children:d||C?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("span",{className:"spinner-border spinner-border-sm me-2"}),C?"画像処理中...":"追加中..."]}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("i",{className:"bi bi-check-circle me-2"}),"商品を追加する"]})})]})})})]}):(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{className:"alert alert-info",children:[(0,i.jsx)("h5",{className:"alert-heading",children:"CSV形式について"}),(0,i.jsx)("p",{className:"mb-3",children:"以下の列を含むCSVファイルをアップロードしてください："}),(0,i.jsxs)("div",{className:"small",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"id:"})," 既存商品ID（更新時のみ）"]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"name:"})," 商品名（必須）"]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"barcode:"})," JANコード（任意）"]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"price:"})," 価格（任意、デフォルト0）"]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"variation_name:"})," 価格バリエーション名（任意）"]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"tax_type:"})," 税区分（任意、inclusive/exclusive）"]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"category_id:"})," カテゴリID（任意）"]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"description:"})," 商品説明（任意）"]})]})]}),(0,i.jsxs)("div",{className:"mb-4",children:[(0,i.jsx)("label",{className:"form-label fw-medium",children:"CSVファイルをアップロード"}),(0,i.jsxs)("div",{className:"d-flex flex-column gap-3",children:[(0,i.jsx)("input",{type:"file",accept:".csv,.txt",onChange:e=>{var a;let s=null===(a=e.target.files)||void 0===a?void 0:a[0];s&&(u(s),N(!1),j([]))},className:"d-none",id:"csv-upload"}),(0,i.jsxs)("label",{htmlFor:"csv-upload",className:"btn btn-outline-secondary d-inline-flex align-items-center gap-2 w-fit",style:{cursor:"pointer"},children:[(0,i.jsx)("i",{className:"bi bi-file-earmark-spreadsheet fs-5"}),h?"ファイルを変更":"CSVファイルを選択"]}),h&&(0,i.jsx)("div",{className:"p-3 bg-primary bg-opacity-10 border border-primary border-opacity-25 rounded",children:(0,i.jsxs)("div",{className:"d-flex align-items-center gap-2",children:[(0,i.jsx)("i",{className:"bi bi-file-earmark-spreadsheet text-primary fs-5"}),(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"fw-medium text-primary",children:h.name}),(0,i.jsxs)("div",{className:"small text-primary text-opacity-75",children:["ファイルサイズ: ",(h.size/1024).toFixed(1)," KB"]})]})]})})]})]}),(0,i.jsxs)("div",{className:"d-flex gap-3 mb-4",children:[(0,i.jsxs)("button",{onClick:q,disabled:!h,className:"btn btn-outline-primary d-flex align-items-center gap-2",children:[(0,i.jsx)("i",{className:"bi bi-eye"}),"プレビュー"]}),g&&(0,i.jsx)("button",{onClick:T,disabled:d||0===p.length,className:"btn text-white",style:{background:"linear-gradient(135deg, #8bc34a 0%, #7cb342 100%)",border:"none"},children:d?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("span",{className:"spinner-border spinner-border-sm me-2"}),"インポート中..."]}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("i",{className:"bi bi-upload me-2"}),p.length,"件をインポート"]})})]}),g&&p.length>0&&(0,i.jsxs)("div",{className:"card",children:[(0,i.jsx)("div",{className:"card-header bg-light",children:(0,i.jsxs)("h5",{className:"card-title mb-0",children:["プレビュー (",p.length,"件)"]})}),(0,i.jsx)("div",{className:"card-body p-0",children:(0,i.jsx)("div",{className:"table-responsive",children:(0,i.jsxs)("table",{className:"table table-striped table-hover mb-0",children:[(0,i.jsx)("thead",{className:"table-light",children:(0,i.jsxs)("tr",{children:[(0,i.jsx)("th",{className:"px-3 py-2 fw-medium text-secondary",children:"商品名"}),(0,i.jsx)("th",{className:"px-3 py-2 fw-medium text-secondary",children:"価格"}),(0,i.jsx)("th",{className:"px-3 py-2 fw-medium text-secondary",children:"バリエーション"}),(0,i.jsx)("th",{className:"px-3 py-2 fw-medium text-secondary",children:"JANコード"}),(0,i.jsx)("th",{className:"px-3 py-2 fw-medium text-secondary",children:"操作"})]})}),(0,i.jsx)("tbody",{children:p.map((e,a)=>(0,i.jsxs)("tr",{children:[(0,i.jsx)("td",{className:"px-3 py-2",children:e.name}),(0,i.jsxs)("td",{className:"px-3 py-2",children:["\xa5",(e.price||0).toLocaleString()]}),(0,i.jsx)("td",{className:"px-3 py-2 text-muted",children:e.variation_name||"-"}),(0,i.jsx)("td",{className:"px-3 py-2 text-muted",children:e.barcode||"-"}),(0,i.jsx)("td",{className:"px-3 py-2",children:(0,i.jsx)("span",{className:"badge ".concat(e.id?"bg-warning text-dark":"bg-success"),children:e.id?"更新":"新規"})})]},a))})]})})})]})]})})]})]})}}}]);
"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[155],{1155:function(e,s,a){a.d(s,{Z:function(){return d}});var l=a(7437),t=a(2265),i=a(2141),n=a(1463),c=a(3123);let r=e=>{let{customers:s,onRefresh:a}=e,[i,n]=(0,t.useState)({total:0,linked:0,unlinked:0,percentage:0});(0,t.useEffect)(()=>{c()},[s]);let c=()=>{let e=s.length,a=s.filter(e=>e.line_user_id).length;n({total:e,linked:a,unlinked:e-a,percentage:e>0?Math.round(a/e*100):0})};return(0,l.jsx)("div",{className:"row mb-4",children:(0,l.jsx)("div",{className:"col-12",children:(0,l.jsx)("div",{className:"card",children:(0,l.jsxs)("div",{className:"card-body",children:[(0,l.jsxs)("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[(0,l.jsxs)("h6",{className:"mb-0",children:[(0,l.jsx)("i",{className:"bi bi-line me-2"}),"LINE認証統計"]}),a&&(0,l.jsxs)("button",{onClick:a,className:"btn btn-outline-secondary btn-sm",children:[(0,l.jsx)("i",{className:"bi bi-arrow-clockwise me-1"}),"更新"]})]}),(0,l.jsxs)("div",{className:"row g-3",children:[(0,l.jsx)("div",{className:"col-md-3",children:(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsx)("div",{className:"h4 mb-0 text-primary",children:i.total}),(0,l.jsx)("small",{className:"text-muted",children:"総顧客数"})]})}),(0,l.jsx)("div",{className:"col-md-3",children:(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsx)("div",{className:"h4 mb-0 text-success",children:i.linked}),(0,l.jsx)("small",{className:"text-muted",children:"LINE連携済み"})]})}),(0,l.jsx)("div",{className:"col-md-3",children:(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsx)("div",{className:"h4 mb-0 text-secondary",children:i.unlinked}),(0,l.jsx)("small",{className:"text-muted",children:"LINE未連携"})]})}),(0,l.jsx)("div",{className:"col-md-3",children:(0,l.jsxs)("div",{className:"text-center",children:[(0,l.jsxs)("div",{className:"h4 mb-0 text-info",children:[i.percentage,"%"]}),(0,l.jsx)("small",{className:"text-muted",children:"連携率"})]})})]}),(0,l.jsxs)("div",{className:"mt-3",children:[(0,l.jsx)("div",{className:"progress",style:{height:"8px"},children:(0,l.jsx)("div",{className:"progress-bar bg-success",role:"progressbar",style:{width:"".concat(i.percentage,"%")},"aria-valuenow":i.percentage,"aria-valuemin":0,"aria-valuemax":100})}),(0,l.jsxs)("div",{className:"d-flex justify-content-between small text-muted mt-1",children:[(0,l.jsx)("span",{children:"LINE連携率"}),(0,l.jsxs)("span",{children:[i.percentage,"%"]})]})]})]})})})})};var d=()=>{let[e,s]=(0,t.useState)([]),[a,d]=(0,t.useState)(!0),[m,o]=(0,t.useState)(""),[h,u]=(0,t.useState)("all"),[x,j]=(0,t.useState)(!1),[p,N]=(0,t.useState)(null),[b,f]=(0,t.useState)(null),[g,v]=(0,t.useState)({name:"",furigana:"",email:"",phone:"",postal_code:"",prefecture:"",city:"",address:"",birth_date:"",gender:""}),[y,w]=(0,t.useState)({}),[_,C]=(0,t.useState)(!1);(0,t.useEffect)(()=>{k()},[]);let k=async()=>{d(!0);try{let{data:e,error:a}=await i.O.from("customers").select("*").order("created_at",{ascending:!1});if(a)throw a;s(e||[])}catch(e){}finally{d(!1)}},L=e.filter(e=>{var s,a;let l=e.name.toLowerCase().includes(m.toLowerCase())||(null===(s=e.phone)||void 0===s?void 0:s.includes(m))||(null===(a=e.email)||void 0===a?void 0:a.toLowerCase().includes(m.toLowerCase())),t="all"===h||"linked"===h&&e.line_user_id||"unlinked"===h&&!e.line_user_id;return l&&t}),S=()=>{let e={};return g.name.trim()||(e.name="氏名は必須です"),g.phone.trim()?/^[\d\-\+\(\)\s]+$/.test(g.phone)||(e.phone="有効な電話番号を入力してください"):e.phone="電話番号は必須です",g.email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(g.email)&&(e.email="有効なメールアドレスを入力してください"),g.postal_code&&!/^\d{3}-?\d{4}$/.test(g.postal_code)&&(e.postal_code="有効な郵便番号を入力してください（例: 123-4567）"),w(e),0===Object.keys(e).length},I=async e=>{if(e.preventDefault(),S()){C(!0);try{let e={name:g.name.trim(),furigana:g.furigana.trim()||null,email:g.email.trim()||null,phone:g.phone.trim(),postal_code:g.postal_code.trim()||null,prefecture:g.prefecture.trim()||null,city:g.city.trim()||null,address:g.address.trim()||null,birth_date:g.birth_date||null,gender:g.gender||null,updated_at:new Date().toISOString()};if(p){let{error:s}=await i.O.from("customers").update(e).eq("id",p.id);if(s)throw s}else{let{error:s}=await i.O.from("customers").insert([e]);if(s)throw s}J(),k()}catch(e){alert("保存に失敗しました。もう一度お試しください。")}finally{C(!1)}}},O=e=>{N(e),v({name:e.name,furigana:e.furigana||"",email:e.email||"",phone:e.phone||"",postal_code:e.postal_code||"",prefecture:e.prefecture||"",city:e.city||"",address:e.address||"",birth_date:e.birth_date||"",gender:e.gender||""}),j(!0)},E=async()=>{if(b)try{let{error:e}=await i.O.from("customers").delete().eq("id",b.id);if(e)throw e;f(null),k()}catch(e){alert("削除に失敗しました。もう一度お試しください。")}},J=()=>{v({name:"",furigana:"",email:"",phone:"",postal_code:"",prefecture:"",city:"",address:"",birth_date:"",gender:""}),w({}),N(null),j(!1)},P=e=>s=>{v({...g,[e]:s.target.value}),y[e]&&w({...y,[e]:""})},A=async e=>{if(confirm("LINE連携を解除しますか？"))try{await c.r.unlinkLineAuth(e),p&&N({...p,line_user_id:void 0}),k(),alert("LINE連携を解除しました")}catch(e){alert("LINE連携解除に失敗しました。もう一度お試しください。")}};return(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"row mb-4",children:(0,l.jsx)("div",{className:"col-12",children:(0,l.jsxs)("div",{className:"d-flex justify-content-between align-items-center",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("h2",{className:"h2 fw-bold text-dark",children:"顧客管理"}),(0,l.jsx)("p",{className:"text-muted",children:"顧客情報の一覧・追加・編集・削除"})]}),(0,l.jsxs)("button",{onClick:()=>j(!0),className:"btn btn-primary",children:[(0,l.jsx)("i",{className:"bi bi-person-plus me-2"}),"新規顧客追加"]})]})})}),(0,l.jsx)(r,{customers:e,onRefresh:k}),(0,l.jsx)("div",{className:"row mb-4",children:(0,l.jsx)("div",{className:"col-12",children:(0,l.jsx)("div",{className:"card",children:(0,l.jsx)("div",{className:"card-body",children:(0,l.jsxs)("div",{className:"row g-3",children:[(0,l.jsx)("div",{className:"col-md-8",children:(0,l.jsxs)("div",{className:"input-group",children:[(0,l.jsx)("span",{className:"input-group-text",children:(0,l.jsx)("i",{className:"bi bi-search"})}),(0,l.jsx)("input",{type:"text",placeholder:"名前、電話番号、メールアドレスで検索...",value:m,onChange:e=>o(e.target.value),className:"form-control"})]})}),(0,l.jsx)("div",{className:"col-md-4",children:(0,l.jsxs)("select",{value:h,onChange:e=>u(e.target.value),className:"form-select",children:[(0,l.jsx)("option",{value:"all",children:"全ての顧客"}),(0,l.jsx)("option",{value:"linked",children:"LINE連携済み"}),(0,l.jsx)("option",{value:"unlinked",children:"LINE未連携"})]})})]})})})})}),(0,l.jsx)("div",{className:"row",children:(0,l.jsxs)("div",{className:"col-12",children:[(0,l.jsxs)("div",{className:"card",children:[(0,l.jsx)("div",{className:"card-header",children:(0,l.jsxs)("h5",{className:"mb-0",children:["顧客一覧 (",L.length,"件)"]})}),(0,l.jsx)("div",{className:"card-body",children:a?(0,l.jsxs)("div",{className:"d-flex justify-content-center align-items-center py-5",children:[(0,l.jsx)("div",{className:"loading-spinner me-2"}),(0,l.jsx)("span",{className:"text-muted",children:"読み込み中..."})]}):L.length>0?(0,l.jsx)("div",{className:"table-responsive",children:(0,l.jsxs)("table",{className:"table table-hover",children:[(0,l.jsx)("thead",{className:"table-light",children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{className:"fw-medium text-muted text-uppercase small",children:"顧客情報"}),(0,l.jsx)("th",{className:"fw-medium text-muted text-uppercase small",children:"連絡先"}),(0,l.jsx)("th",{className:"fw-medium text-muted text-uppercase small",children:"住所"}),(0,l.jsx)("th",{className:"fw-medium text-muted text-uppercase small",children:"LINE認証"}),(0,l.jsx)("th",{className:"fw-medium text-muted text-uppercase small",children:"登録日"}),(0,l.jsx)("th",{className:"fw-medium text-muted text-uppercase small text-end",children:"操作"})]})}),(0,l.jsx)("tbody",{children:L.map(e=>(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{className:"px-3 py-3",children:(0,l.jsxs)("div",{className:"d-flex align-items-center",children:[(0,l.jsx)("div",{className:"flex-shrink-0 me-3",children:(0,l.jsx)("div",{className:"rounded-circle bg-light d-flex align-items-center justify-content-center",style:{width:"40px",height:"40px"},children:(0,l.jsx)("i",{className:"bi bi-person text-muted"})})}),(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"fw-medium text-dark",children:e.name}),e.furigana&&(0,l.jsx)("div",{className:"small text-muted",children:e.furigana})]})]})}),(0,l.jsx)("td",{className:"px-3 py-3",children:(0,l.jsxs)("div",{children:[e.phone&&(0,l.jsxs)("div",{className:"d-flex align-items-center small",children:[(0,l.jsx)("i",{className:"bi bi-telephone me-1 text-muted"}),e.phone]}),e.email&&(0,l.jsxs)("div",{className:"d-flex align-items-center small mt-1",children:[(0,l.jsx)("i",{className:"bi bi-envelope me-1 text-muted"}),e.email]})]})}),(0,l.jsx)("td",{className:"px-3 py-3",children:(0,l.jsxs)("div",{className:"small",children:[e.postal_code&&(0,l.jsxs)("div",{children:["〒",e.postal_code]}),(e.prefecture||e.city||e.address)&&(0,l.jsxs)("div",{className:"text-muted",children:[e.prefecture,e.city,e.address]})]})}),(0,l.jsx)("td",{className:"px-3 py-3",children:(0,l.jsx)("div",{className:"d-flex align-items-center",children:e.line_user_id?(0,l.jsxs)("span",{className:"badge bg-success",children:[(0,l.jsx)("i",{className:"bi bi-check-circle me-1"}),"LINE連携済み"]}):(0,l.jsxs)("span",{className:"badge bg-secondary",children:[(0,l.jsx)("i",{className:"bi bi-dash-circle me-1"}),"未連携"]})})}),(0,l.jsx)("td",{className:"px-3 py-3 small text-muted",children:new Date(e.created_at).toLocaleDateString("ja-JP")}),(0,l.jsx)("td",{className:"px-3 py-3",children:(0,l.jsxs)("div",{className:"d-flex justify-content-end gap-1",children:[(0,l.jsx)("button",{onClick:()=>O(e),className:"btn btn-outline-primary btn-sm",title:"編集",children:(0,l.jsx)("i",{className:"bi bi-pencil"})}),(0,l.jsx)("button",{onClick:()=>f(e),className:"btn btn-outline-danger btn-sm",title:"削除",children:(0,l.jsx)("i",{className:"bi bi-trash"})})]})})]},e.id))})]})}):(0,l.jsxs)("div",{className:"text-center py-5",children:[(0,l.jsx)("i",{className:"bi bi-people text-muted",style:{fontSize:"4rem"}}),(0,l.jsx)("p",{className:"text-muted mt-3",children:m?"検索条件に合う顧客が見つかりません":"登録されている顧客がいません"}),m&&(0,l.jsx)("p",{className:"text-muted small",children:"検索条件を変更してもう一度お試しください。"})]})})]}),x&&(0,l.jsx)("div",{className:"modal fade show d-block",tabIndex:-1,style:{backgroundColor:"rgba(0,0,0,0.5)"},children:(0,l.jsx)("div",{className:"modal-dialog modal-lg modal-dialog-scrollable",children:(0,l.jsxs)("div",{className:"modal-content",children:[(0,l.jsxs)("div",{className:"modal-header",children:[(0,l.jsx)("h5",{className:"modal-title",children:p?"顧客情報編集":"新規顧客追加"}),(0,l.jsx)("button",{type:"button",className:"btn-close",onClick:J})]}),(0,l.jsxs)("form",{onSubmit:I,children:[(0,l.jsx)("div",{className:"modal-body",children:(0,l.jsxs)("div",{className:"row g-3",children:[(0,l.jsxs)("div",{className:"col-md-6",children:[(0,l.jsxs)("label",{className:"form-label",children:["氏名 ",(0,l.jsx)("span",{className:"text-danger",children:"*"})]}),(0,l.jsx)("input",{type:"text",value:g.name,onChange:P("name"),className:"form-control ".concat(y.name?"is-invalid":""),placeholder:"山田 太郎"}),y.name&&(0,l.jsx)("div",{className:"invalid-feedback",children:y.name})]}),(0,l.jsxs)("div",{className:"col-md-6",children:[(0,l.jsx)("label",{className:"form-label",children:"フリガナ"}),(0,l.jsx)("input",{type:"text",value:g.furigana,onChange:P("furigana"),className:"form-control",placeholder:"ヤマダ タロウ"})]}),(0,l.jsxs)("div",{className:"col-md-6",children:[(0,l.jsxs)("label",{className:"form-label",children:["電話番号 ",(0,l.jsx)("span",{className:"text-danger",children:"*"})]}),(0,l.jsx)("input",{type:"tel",value:g.phone,onChange:P("phone"),className:"form-control ".concat(y.phone?"is-invalid":""),placeholder:"090-1234-5678"}),y.phone&&(0,l.jsx)("div",{className:"invalid-feedback",children:y.phone})]}),(0,l.jsxs)("div",{className:"col-md-6",children:[(0,l.jsx)("label",{className:"form-label",children:"メールアドレス"}),(0,l.jsx)("input",{type:"email",value:g.email,onChange:P("email"),className:"form-control ".concat(y.email?"is-invalid":""),placeholder:"example@email.com"}),y.email&&(0,l.jsx)("div",{className:"invalid-feedback",children:y.email})]}),(0,l.jsxs)("div",{className:"col-md-6",children:[(0,l.jsx)("label",{className:"form-label",children:"郵便番号"}),(0,l.jsx)("input",{type:"text",value:g.postal_code,onChange:P("postal_code"),className:"form-control ".concat(y.postal_code?"is-invalid":""),placeholder:"123-4567"}),y.postal_code&&(0,l.jsx)("div",{className:"invalid-feedback",children:y.postal_code})]}),(0,l.jsxs)("div",{className:"col-md-6",children:[(0,l.jsx)("label",{className:"form-label",children:"都道府県"}),(0,l.jsx)("input",{type:"text",value:g.prefecture,onChange:P("prefecture"),className:"form-control",placeholder:"東京都"})]}),(0,l.jsxs)("div",{className:"col-md-6",children:[(0,l.jsx)("label",{className:"form-label",children:"市区町村"}),(0,l.jsx)("input",{type:"text",value:g.city,onChange:P("city"),className:"form-control",placeholder:"新宿区"})]}),(0,l.jsxs)("div",{className:"col-12",children:[(0,l.jsx)("label",{className:"form-label",children:"住所"}),(0,l.jsx)("input",{type:"text",value:g.address,onChange:P("address"),className:"form-control",placeholder:"西新宿1-1-1"})]}),(0,l.jsxs)("div",{className:"col-md-6",children:[(0,l.jsx)("label",{className:"form-label",children:"生年月日"}),(0,l.jsx)("input",{type:"date",value:g.birth_date,onChange:P("birth_date"),className:"form-control"})]}),(0,l.jsxs)("div",{className:"col-md-6",children:[(0,l.jsx)("label",{className:"form-label",children:"性別"}),(0,l.jsxs)("select",{value:g.gender,onChange:P("gender"),className:"form-select",children:[(0,l.jsx)("option",{value:"",children:"選択してください"}),(0,l.jsx)("option",{value:"男性",children:"男性"}),(0,l.jsx)("option",{value:"女性",children:"女性"}),(0,l.jsx)("option",{value:"その他",children:"その他"}),(0,l.jsx)("option",{value:"回答しない",children:"回答しない"})]})]}),p&&(0,l.jsx)("div",{className:"col-12",children:(0,l.jsx)("div",{className:"card bg-light",children:(0,l.jsxs)("div",{className:"card-body",children:[(0,l.jsxs)("h6",{className:"card-title mb-3",children:[(0,l.jsx)("i",{className:"bi bi-line me-2"}),"LINE認証情報"]}),p.line_user_id?(0,l.jsxs)("div",{className:"d-flex align-items-center justify-content-between",children:[(0,l.jsxs)("div",{children:[(0,l.jsxs)("span",{className:"badge bg-success me-2",children:[(0,l.jsx)("i",{className:"bi bi-check-circle me-1"}),"LINE連携済み"]}),(0,l.jsxs)("div",{className:"small text-muted mt-1",children:["LINE User ID: ",p.line_user_id]})]}),(0,l.jsxs)("button",{type:"button",onClick:()=>A(p.id),className:"btn btn-outline-danger btn-sm",children:[(0,l.jsx)("i",{className:"bi bi-unlink me-1"}),"連携解除"]})]}):(0,l.jsxs)("div",{className:"d-flex align-items-center",children:[(0,l.jsxs)("span",{className:"badge bg-secondary me-2",children:[(0,l.jsx)("i",{className:"bi bi-dash-circle me-1"}),"LINE未連携"]}),(0,l.jsx)("div",{className:"small text-muted",children:"この顧客はLINE認証を行っていません"})]})]})})})]})}),(0,l.jsxs)("div",{className:"modal-footer",children:[(0,l.jsx)("button",{type:"button",onClick:J,className:"btn btn-secondary",children:"キャンセル"}),(0,l.jsx)("button",{type:"submit",disabled:_,className:"btn btn-primary",children:_?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("span",{className:"loading-spinner me-2"}),"保存中..."]}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("i",{className:"bi bi-check-lg me-2"}),p?"更新":"追加"]})})]})]})]})})}),(0,l.jsx)(n.$,{isOpen:!!b,title:"顧客情報の削除",itemName:(null==b?void 0:b.name)||"",onConfirm:E,onCancel:()=>f(null)})]})})]})}},1463:function(e,s,a){a.d(s,{$:function(){return n}});var l=a(7437);a(2265);var t=a(6882);let i=e=>{let{isOpen:s,title:a,message:i,confirmText:n="実行",cancelText:c="キャンセル",confirmButtonVariant:r="danger",onConfirm:d,onCancel:m,isLoading:o=!1,icon:h="warning"}=e;return s?(0,l.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onKeyDown:e=>{"Escape"===e.key?m():"Enter"!==e.key||o||d()},onClick:e=>{e.target===e.currentTarget&&m()},children:(0,l.jsxs)("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all",role:"dialog","aria-modal":"true","aria-labelledby":"dialog-title","aria-describedby":"dialog-message",children:[(0,l.jsx)("div",{className:"p-6 pb-0",children:(0,l.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,l.jsxs)("div",{className:"flex-shrink-0 ".concat((()=>{switch(r){case"danger":default:return"text-red-500";case"warning":return"text-yellow-500";case"primary":return"text-blue-500";case"success":return"text-green-500"}})()),children:["delete"===h&&(0,l.jsx)(t.JO,{icon:t.PJ.delete,size:"lg"}),"warning"===h&&(0,l.jsx)(t.JO,{icon:t.PJ.warning,size:"lg"}),"success"===h&&(0,l.jsx)(t.JO,{icon:t.PJ.success,size:"lg"}),"error"===h&&(0,l.jsx)(t.JO,{icon:t.PJ.error,size:"lg"}),"info"===h&&(0,l.jsx)(t.JO,{icon:t.PJ.info,size:"lg"}),!["delete","warning","success","error","info"].includes(h)&&(0,l.jsx)(t.JO,{icon:t.PJ.alert,size:"lg"})]}),(0,l.jsx)("div",{children:(0,l.jsx)("h3",{id:"dialog-title",className:"text-lg font-semibold text-gray-900",children:a})})]})}),(0,l.jsx)("div",{className:"p-6 pt-4",children:(0,l.jsx)("p",{id:"dialog-message",className:"text-gray-600 leading-relaxed",children:i})}),(0,l.jsxs)("div",{className:"p-6 pt-0 flex justify-end space-x-3",children:[(0,l.jsx)("button",{type:"button",onClick:m,disabled:o,className:"px-4 py-2 text-gray-700 bg-gray-200 rounded-md font-medium hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:c}),(0,l.jsx)("button",{type:"button",onClick:d,disabled:o,className:(()=>{let e="px-4 py-2 rounded-md font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed";switch(r){case"danger":default:return"".concat(e," bg-red-600 text-white hover:bg-red-700 focus:ring-red-500");case"warning":return"".concat(e," bg-yellow-600 text-white hover:bg-yellow-700 focus:ring-yellow-500");case"primary":return"".concat(e," bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500");case"success":return"".concat(e," bg-green-600 text-white hover:bg-green-700 focus:ring-green-500")}})(),children:o?(0,l.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,l.jsx)(t.JO,{icon:t.PJ.loading,size:"sm",className:"animate-spin"}),(0,l.jsx)("span",{children:"処理中..."})]}):n})]})]})}):null},n=e=>{let{isOpen:s,title:a="削除の確認",itemName:t="この項目",onConfirm:n,onCancel:c,isLoading:r=!1}=e;return(0,l.jsx)(i,{isOpen:s,title:a,message:"".concat(t,"を削除しますか？この操作は取り消すことができません。"),confirmText:"削除",cancelText:"キャンセル",confirmButtonVariant:"danger",onConfirm:n,onCancel:c,isLoading:r,icon:"delete"})}},3123:function(e,s,a){a.d(s,{r:function(){return t}});var l=a(2141);class t{static async linkLineAuthToCustomer(e,s,a){try{let l=await this.findCustomerByLineId(e);if(l)return await this.updateCustomerWithLineAuth(l,s,a);return await this.createCustomerWithLineAuth(e,s,a)}catch(e){throw e}}static async findCustomerByLineId(e){try{let{data:s,error:a}=await l.O.from("customers").select("*").eq("line_user_id",e).single();if(a&&"PGRST116"!==a.code)throw a;return s||null}catch(e){return null}}static async findCustomerByEmail(e){try{let{data:s,error:a}=await l.O.from("customers").select("*").eq("email",e).single();if(a&&"PGRST116"!==a.code)throw a;return s||null}catch(e){return null}}static async findCustomerByPhone(e){try{let{data:s,error:a}=await l.O.from("customers").select("*").eq("phone",e).single();if(a&&"PGRST116"!==a.code)throw a;return s||null}catch(e){return null}}static async updateCustomerWithLineAuth(e,s,a){try{let t={...e,...a,line_user_id:s.userId,updated_at:new Date().toISOString()},{data:i,error:n}=await l.O.from("customers").update(t).eq("id",e.id).select().single();if(n)throw n;return i}catch(e){throw e}}static async createCustomerWithLineAuth(e,s,a){try{let t={...a,line_user_id:e,name:a.name||s.displayName,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:i,error:n}=await l.O.from("customers").insert([t]).select().single();if(n)throw n;return i}catch(e){throw e}}static async autoLinkExistingCustomer(e,s,a){try{if(a.email){let e=await this.findCustomerByEmail(a.email);if(e)return await this.updateCustomerWithLineAuth(e,s,a)}if(a.phone){let e=await this.findCustomerByPhone(a.phone);if(e)return await this.updateCustomerWithLineAuth(e,s,a)}return await this.createCustomerWithLineAuth(e,s,a)}catch(e){throw e}}static async unlinkLineAuth(e){try{let{error:s}=await l.O.from("customers").update({line_user_id:null,updated_at:new Date().toISOString()}).eq("id",e);if(s)throw s}catch(e){throw e}}static async getCustomerLineAuthStatus(e){try{let{data:s,error:a}=await l.O.from("customers").select("line_user_id").eq("id",e).single();if(a)throw a;return{isLinked:!!s.line_user_id,lineUserId:s.line_user_id}}catch(e){return{isLinked:!1}}}static async getLineAuthenticatedCustomers(){try{let{data:e,error:s}=await l.O.from("customers").select("*").not("line_user_id","is",null).order("created_at",{ascending:!1});if(s)throw s;return e||[]}catch(e){return[]}}}}}]);
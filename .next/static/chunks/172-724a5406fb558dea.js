"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[172],{2172:function(e,t,a){a.d(t,{Z:function(){return r}});var s=a(7437),i=a(2265),l=a(2141);class c{static getStatusBadgeClasses(e){let t={active:{bg:"bg-green-100",text:"text-green-800",label:"アクティブ"},inactive:{bg:"bg-gray-100",text:"text-gray-800",label:"無効"},pending:{bg:"bg-blue-100",text:"text-blue-800",label:"保留中"},confirmed:{bg:"bg-green-100",text:"text-green-800",label:"確定"},cancelled:{bg:"bg-red-100",text:"text-red-800",label:"キャンセル"},completed:{bg:"bg-purple-100",text:"text-purple-800",label:"完了"},expired:{bg:"bg-red-100",text:"text-red-800",label:"期限切れ"},preparing:{bg:"bg-yellow-100",text:"text-yellow-800",label:"準備中"}};return t[e]||t.inactive}static formatDate(e,t){if(!e)return"";let a={year:"numeric",month:"2-digit",day:"2-digit",...t};return new Date(e).toLocaleDateString("ja-JP",a)}static formatDateTime(e){return e?new Date(e).toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):""}static formatPrice(e){return"\xa5".concat(e.toLocaleString())}static isDateInRange(e,t,a){return(!t||!(e<t))&&(!a||!(e>a))}static calculateDaysUntil(e){let t=new Date;return Math.ceil((new Date(e).getTime()-t.getTime())/864e5)}static getValidityPeriodText(e,t){return e||t?e&&t?"".concat(this.formatDate(e)," - ").concat(this.formatDate(t)):e?"".concat(this.formatDate(e),"から"):t?"".concat(this.formatDate(t),"まで"):"期限なし":"期限なし"}}class n{static async getAllForms(){let{data:e,error:t}=await l.OQ.from("form_configurations").select("\n        id,\n        name,\n        description,\n        form_fields,\n        settings,\n        is_active,\n        valid_from,\n        valid_to,\n        version,\n        created_at,\n        updated_at\n      ").order("updated_at",{ascending:!1});if(t)throw t;let{data:a,error:s}=await l.OQ.from("reservations").select("form_id").not("form_id","is",null);s&&console.warn("Failed to fetch response counts:",s);let i=new Map;return null==a||a.forEach(e=>{let t=i.get(e.form_id)||0;i.set(e.form_id,t+1)}),(null==e?void 0:e.map(e=>{var t,a;return{...e,settings:e.settings||{},version:e.version||1,field_count:(null===(a=e.form_fields)||void 0===a?void 0:null===(t=a.fields)||void 0===t?void 0:t.length)||0,response_count:i.get(e.id)||0}}))||[]}static async createForm(e){let{data:t,error:a}=await l.OQ.from("form_configurations").insert([{name:e.name,description:e.description,form_fields:{fields:e.fields},is_active:e.isActive,valid_from:e.validFrom||null,valid_to:e.validTo||null,selected_products:e.selectedProducts||[]}]).select();if(a)throw a;return t[0]}static async updateForm(e,t){let a={};t.name&&(a.name=t.name),t.description&&(a.description=t.description),t.fields&&(a.form_fields={fields:t.fields}),void 0!==t.isActive&&(a.is_active=t.isActive),void 0!==t.validFrom&&(a.valid_from=t.validFrom||null),void 0!==t.validTo&&(a.valid_to=t.validTo||null),t.selectedProducts&&(a.selected_products=t.selectedProducts);let{data:s,error:i}=await l.OQ.from("form_configurations").update(a).eq("id",e).select();if(i)throw i;return s[0]}static async deleteForm(e){let{error:t}=await l.OQ.from("form_configurations").delete().eq("id",e);if(t)throw t;return!0}static async getFormById(e){let{data:t,error:a}=await l.OQ.from("form_configurations").select("*").eq("id",e).single();if(a)throw a;return t}static async toggleFormStatus(e,t){let{error:a}=await l.OQ.from("form_configurations").update({is_active:t}).eq("id",e);if(a)throw a;return!0}static isFormAccessible(e){if(!e.is_active)return!1;let t=new Date,a=e.valid_from?new Date(e.valid_from):null,s=e.valid_to?new Date(e.valid_to):null;return(!a||!(t<a))&&(!s||!(t>s))}static getFormStatus(e){if(!e.is_active)return"inactive";let t=new Date,a=e.valid_from?new Date(e.valid_from):null,s=e.valid_to?new Date(e.valid_to):null;return a&&t<a?"pending":s&&t>s?"expired":"active"}static getValidityPeriodText(e,t){return c.getValidityPeriodText(e,t)}static async checkFormConfiguration(){try{let e=await this.getAllForms(),t=0,a=0,s=0,i=[],l=[],c=new Date;return e.forEach(e=>{let n=this.getFormStatus(e);switch(n){case"active":t++;break;case"inactive":a++;break;case"expired":s++,i.push("フォーム「".concat(e.name,"」が有効期限切れです"));break;case"pending":i.push("フォーム「".concat(e.name,"」がまだ開始されていません"))}if(0===e.field_count&&i.push("フォーム「".concat(e.name,"」にフィールドが設定されていません")),0===e.response_count&&"active"===n&&l.push("フォーム「".concat(e.name,"」はアクティブですが回答がありません")),e.valid_to){let t=new Date(e.valid_to),a=Math.ceil((t.getTime()-c.getTime())/864e5);a<=7&&a>0&&"active"===n&&l.push("フォーム「".concat(e.name,"」が").concat(a,"日後に有効期限切れになります"))}}),0===t&&i.push("アクティブなフォームがありません"),0===e.length&&(i.push("フォームが作成されていません"),l.push("最初のフォームを作成することをお勧めします")),{totalForms:e.length,activeForms:t,inactiveForms:a,expiredForms:s,issuesFound:i,recommendations:l}}catch(e){return console.error("フォーム設定チェック中にエラーが発生:",e),{totalForms:0,activeForms:0,inactiveForms:0,expiredForms:0,issuesFound:["フォーム設定の確認中にエラーが発生しました"],recommendations:[]}}}}function r(){let[e,t]=(0,i.useState)([]),[a,l]=(0,i.useState)(!0),[c,r]=(0,i.useState)("all");(0,i.useEffect)(()=>{d()},[]);let d=async()=>{try{let e=await n.getAllForms();t(e)}catch(e){console.error("フォーム一覧の取得に失敗しました:",e),t([])}finally{l(!1)}},o=async(a,s)=>{try{await n.toggleFormStatus(a,!s),t(e.map(e=>e.id===a?{...e,is_active:!s}:e))}catch(e){console.error("フォームステータスの更新に失敗しました:",e),alert("フォームステータスの更新に失敗しました。")}},m=async a=>{if(confirm("このフォームを削除しますか？この操作は元に戻せません。"))try{await n.deleteForm(a),t(e.filter(e=>e.id!==a)),alert("フォームが削除されました。")}catch(e){console.error("フォームの削除に失敗しました:",e),alert("フォームの削除に失敗しました。")}},u=e.filter(e=>"all"===c||("active"===c?e.is_active:"inactive"!==c||!e.is_active)),h=e=>{let t={inactive:{bg:"bg-secondary-subtle",text:"text-secondary",label:"無効"},pending:{bg:"bg-info-subtle",text:"text-info",label:"開始前"},expired:{bg:"bg-danger-subtle",text:"text-danger",label:"期限切れ"},active:{bg:"bg-success-subtle",text:"text-success",label:"公開中"}}[n.getFormStatus(e)];return(0,s.jsx)("span",{className:"badge ".concat(t.bg," ").concat(t.text),children:t.label})},x=e=>n.getValidityPeriodText(e.valid_from,e.valid_to);return a?(0,s.jsx)("div",{className:"d-flex justify-content-center align-items-center",style:{height:"256px"},children:(0,s.jsx)("div",{className:"loading-spinner"})}):(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"row mb-4",children:(0,s.jsx)("div",{className:"col-12",children:(0,s.jsxs)("div",{className:"d-flex justify-content-between align-items-center",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"h2 fw-bold text-dark",children:"フォーム一覧"}),(0,s.jsx)("p",{className:"text-muted",children:"作成済みのフォームを管理できます"})]}),(0,s.jsxs)("div",{className:"d-flex gap-3",children:[(0,s.jsxs)("select",{value:c,onChange:e=>r(e.target.value),className:"form-select",children:[(0,s.jsx)("option",{value:"all",children:"すべて"}),(0,s.jsx)("option",{value:"active",children:"有効"}),(0,s.jsx)("option",{value:"inactive",children:"無効"})]}),(0,s.jsxs)("button",{onClick:()=>window.location.href="/admin?page=form-builder",className:"btn btn-primary",children:[(0,s.jsx)("i",{className:"bi bi-plus-lg me-2"}),"新しいフォーム"]})]})]})})}),(0,s.jsxs)("div",{className:"row g-4 mb-4",children:[(0,s.jsx)("div",{className:"col-lg-3 col-md-6",children:(0,s.jsx)("div",{className:"dashboard-widget",children:(0,s.jsx)("div",{className:"d-flex align-items-center justify-content-between",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"dashboard-widget-icon bg-success-subtle text-success",children:(0,s.jsx)("i",{className:"bi bi-check-circle"})}),(0,s.jsx)("div",{className:"dashboard-widget-value",children:e.filter(e=>e.is_active).length}),(0,s.jsx)("div",{className:"dashboard-widget-label",children:"有効なフォーム"})]})})})}),(0,s.jsx)("div",{className:"col-lg-3 col-md-6",children:(0,s.jsx)("div",{className:"dashboard-widget",children:(0,s.jsx)("div",{className:"d-flex align-items-center justify-content-between",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"dashboard-widget-icon bg-primary-subtle text-primary",children:(0,s.jsx)("i",{className:"bi bi-file-earmark-text"})}),(0,s.jsx)("div",{className:"dashboard-widget-value",children:e.length}),(0,s.jsx)("div",{className:"dashboard-widget-label",children:"総フォーム数"})]})})})}),(0,s.jsx)("div",{className:"col-lg-3 col-md-6",children:(0,s.jsx)("div",{className:"dashboard-widget",children:(0,s.jsx)("div",{className:"d-flex align-items-center justify-content-between",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"dashboard-widget-icon bg-info-subtle text-info",children:(0,s.jsx)("i",{className:"bi bi-bar-chart"})}),(0,s.jsx)("div",{className:"dashboard-widget-value",children:e.reduce((e,t)=>e+t.response_count,0)}),(0,s.jsx)("div",{className:"dashboard-widget-label",children:"総回答数"})]})})})}),(0,s.jsx)("div",{className:"col-lg-3 col-md-6",children:(0,s.jsx)("div",{className:"dashboard-widget",children:(0,s.jsx)("div",{className:"d-flex align-items-center justify-content-between",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"dashboard-widget-icon bg-warning-subtle text-warning",children:(0,s.jsx)("i",{className:"bi bi-list-ol"})}),(0,s.jsx)("div",{className:"dashboard-widget-value",children:e.length>0?Math.round(e.reduce((e,t)=>e+t.field_count,0)/e.length):0}),(0,s.jsx)("div",{className:"dashboard-widget-label",children:"平均フィールド数"})]})})})})]}),(0,s.jsx)("div",{className:"row",children:(0,s.jsx)("div",{className:"col-12",children:(0,s.jsxs)("div",{className:"card",children:[(0,s.jsx)("div",{className:"card-header",children:(0,s.jsxs)("h5",{className:"mb-0",children:["フォーム一覧 (",u.length,"件)"]})}),(0,s.jsx)("div",{className:"card-body p-0",children:u.map(e=>(0,s.jsx)("div",{className:"border-bottom p-4",children:(0,s.jsxs)("div",{className:"d-flex justify-content-between align-items-start",children:[(0,s.jsxs)("div",{className:"flex-grow-1",children:[(0,s.jsxs)("div",{className:"d-flex align-items-center gap-3 mb-2",children:[(0,s.jsx)("h5",{className:"mb-0 fw-medium",children:e.name}),h(e)]}),(0,s.jsx)("p",{className:"text-muted mb-3",children:e.description}),(0,s.jsxs)("div",{className:"row g-3 small",children:[(0,s.jsxs)("div",{className:"col-lg-3 col-md-6",children:[(0,s.jsx)("span",{className:"text-muted",children:"フィールド数:"}),(0,s.jsxs)("span",{className:"fw-medium ms-1",children:[e.field_count,"個"]})]}),(0,s.jsxs)("div",{className:"col-lg-3 col-md-6",children:[(0,s.jsx)("span",{className:"text-muted",children:"回答数:"}),(0,s.jsxs)("span",{className:"fw-medium ms-1 text-primary",children:[e.response_count,"件"]})]}),(0,s.jsxs)("div",{className:"col-lg-3 col-md-6",children:[(0,s.jsx)("span",{className:"text-muted",children:"有効期間:"}),(0,s.jsx)("span",{className:"fw-medium ms-1",children:x(e)})]}),(0,s.jsxs)("div",{className:"col-lg-3 col-md-6",children:[(0,s.jsx)("span",{className:"text-muted",children:"更新日:"}),(0,s.jsx)("span",{className:"fw-medium ms-1",children:new Date(e.updated_at).toLocaleDateString("ja-JP")})]})]})]}),(0,s.jsxs)("div",{className:"d-flex gap-1 ms-3",children:[(0,s.jsxs)("button",{onClick:()=>window.location.href="/admin?page=form-builder&id=".concat(e.id),className:"btn btn-outline-primary btn-sm",title:"フォームを編集",children:[(0,s.jsx)("i",{className:"bi bi-pencil me-1"}),"編集"]}),(0,s.jsxs)("button",{onClick:()=>window.open("/form/".concat(e.id),"_blank"),className:"btn btn-outline-secondary btn-sm",title:"フォームをプレビュー",children:[(0,s.jsx)("i",{className:"bi bi-eye me-1"}),"プレビュー"]}),(0,s.jsx)("button",{onClick:()=>o(e.id,e.is_active),className:"btn btn-sm ".concat(e.is_active?"btn-outline-warning":"btn-outline-success"),title:e.is_active?"フォームを無効にする":"フォームを有効にする",children:(0,s.jsx)("i",{className:"bi ".concat(e.is_active?"bi-pause":"bi-play")})}),(0,s.jsx)("button",{onClick:()=>m(e.id),className:"btn btn-outline-danger btn-sm",title:"フォームを削除",children:(0,s.jsx)("i",{className:"bi bi-trash"})})]})]})},e.id))})]})})}),0===u.length&&(0,s.jsx)("div",{className:"row",children:(0,s.jsx)("div",{className:"col-12",children:(0,s.jsx)("div",{className:"card",children:(0,s.jsxs)("div",{className:"card-body text-center py-5",children:[(0,s.jsx)("i",{className:"bi bi-file-earmark-text text-muted",style:{fontSize:"4rem"}}),(0,s.jsx)("h5",{className:"fw-medium text-dark mt-3 mb-2",children:"フォームが見つかりません"}),(0,s.jsxs)("p",{className:"text-muted mb-4",children:["all"!==c?"".concat("active"===c?"有効な":"無効な","フォームはありません。"):"まだフォームが作成されていません。",(0,s.jsx)("br",{}),"新しいフォームを作成してください。"]})]})})})})]})}}}]);
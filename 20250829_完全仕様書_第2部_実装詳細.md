# å•†å“äºˆç´„ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨ä»•æ§˜æ›¸ ç¬¬2éƒ¨ - å®Ÿè£…è©³ç´°

## ğŸ”§ **æŠ€è¡“å®Ÿè£…ä»•æ§˜**

### **1. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯è©³ç´°**

#### **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æŠ€è¡“**
```json
{
  "framework": "Next.js 15.4.3",
  "router": "App Router",
  "react": "19.1.0",
  "typescript": "5.x",
  "styling": "Tailwind CSS 4.0",
  "ui_components": "Radix UI + Custom Components",
  "forms": "React Hook Form 7.61.0",
  "validation": "Zod 4.0.8",
  "state_management": "Zustand 5.0.6",
  "date_handling": "date-fns 4.1.0",
  "animations": "Framer Motion 12.23.7",
  "line_integration": "@line/liff 2.27.1"
}
```

#### **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æŠ€è¡“**
```json
{
  "runtime": "Node.js (Next.js API Routes)",
  "database": "Supabase PostgreSQL",
  "orm": "Supabase Client",
  "authentication": "Custom Password Auth",
  "file_processing": "PapaParse 5.5.3",
  "csv_handling": "Built-in CSV Parser",
  "validation": "Zod Server-side",
  "error_handling": "Custom Error Classes",
  "logging": "Structured JSON Logging"
}
```

#### **å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹**
```json
{
  "database": "Supabase (PostgreSQL + Auth + Storage)",
  "line_platform": "LINE Messaging API + LIFF",
  "deployment": "Vercel (æ¨å¥¨)",
  "monitoring": "Built-in + External (Sentryæ¨å¥¨)",
  "cdn": "Vercel Edge Network"
}
```

### **2. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ**

#### **ã‚¢ãƒˆãƒŸãƒƒã‚¯ãƒ‡ã‚¶ã‚¤ãƒ³æ§‹é€ **
```
src/components/
â”œâ”€â”€ ui/                     # Atomsï¼ˆæœ€å°å˜ä½ï¼‰
â”‚   â”œâ”€â”€ Button/
â”‚   â”‚   â”œâ”€â”€ Button.tsx
â”‚   â”‚   â”œâ”€â”€ Button.test.tsx
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ Input/
â”‚   â”œâ”€â”€ LoadingSpinner/
â”‚   â”œâ”€â”€ ErrorMessage/
â”‚   â””â”€â”€ FormField/
â”œâ”€â”€ common/                 # Moleculesï¼ˆçµ„ã¿åˆã‚ã›ï¼‰
â”‚   â”œâ”€â”€ Pagination.tsx
â”‚   â”œâ”€â”€ ErrorBoundary.tsx
â”‚   â”œâ”€â”€ LazyLoadComponent.tsx
â”‚   â””â”€â”€ ProductErrorBoundary.tsx
â”œâ”€â”€ features/               # Organismsï¼ˆæ©Ÿèƒ½å˜ä½ï¼‰
â”‚   â”œâ”€â”€ reservation/
â”‚   â”‚   â”œâ”€â”€ UserInfoSection.tsx
â”‚   â”‚   â”œâ”€â”€ ProductSelectionSection.tsx
â”‚   â”‚   â””â”€â”€ PickupDateSection.tsx
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ forms/                  # Templatesï¼ˆç”»é¢ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
â”‚   â”œâ”€â”€ ReservationForm.tsx
â”‚   â”œâ”€â”€ ProductSelection.tsx
â”‚   â””â”€â”€ PickupDateCalendar.tsx
â”œâ”€â”€ admin/                  # Admin Pagesï¼ˆç®¡ç†ç”»é¢ï¼‰
â”‚   â”œâ”€â”€ AdminLayout.tsx
â”‚   â”œâ”€â”€ AdminAuthWrapper.tsx
â”‚   â”œâ”€â”€ AdminSidebar.tsx
â”‚   â””â”€â”€ products/
â”‚       â”œâ”€â”€ ProductsContainer.tsx
â”‚       â”œâ”€â”€ ProductTable.tsx
â”‚       â”œâ”€â”€ ProductFilters.tsx
â”‚       â”œâ”€â”€ ProductEditModal.tsx
â”‚       â”œâ”€â”€ ProductDeleteModal.tsx
â”‚       â””â”€â”€ ProductImportModal.tsx
â””â”€â”€ line/                   # LINE Integration
    â””â”€â”€ LiffProvider.tsx
```

#### **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…ä¾‹**
```typescript
// src/components/ui/Button/Button.tsx
interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'danger' | 'ghost';
  size?: 'sm' | 'md' | 'lg';
  loading?: boolean;
  icon?: React.ReactNode;
}

export const Button: React.FC<ButtonProps> = ({
  variant = 'primary',
  size = 'md',
  loading = false,
  icon,
  children,
  className,
  disabled,
  ...props
}) => {
  const baseClasses = 'inline-flex items-center justify-center font-medium rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2';
  
  const variantClasses = {
    primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500',
    secondary: 'bg-gray-200 text-gray-900 hover:bg-gray-300 focus:ring-gray-500',
    danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',
    ghost: 'text-gray-700 hover:bg-gray-100 focus:ring-gray-500'
  };
  
  const sizeClasses = {
    sm: 'px-3 py-2 text-sm',
    md: 'px-4 py-2 text-base',
    lg: 'px-6 py-3 text-lg'
  };
  
  return (
    <button
      className={cn(
        baseClasses,
        variantClasses[variant],
        sizeClasses[size],
        (disabled || loading) && 'opacity-50 cursor-not-allowed',
        className
      )}
      disabled={disabled || loading}
      {...props}
    >
      {loading && <LoadingSpinner size="sm" className="mr-2" />}
      {icon && !loading && <span className="mr-2">{icon}</span>}
      {children}
    </button>
  );
};
```

### **3. çŠ¶æ…‹ç®¡ç†è¨­è¨ˆ**

#### **Zustand Storeæ§‹é€ **
```typescript
// src/stores/reservationStore.ts
interface ReservationStore {
  // çŠ¶æ…‹
  formData: ReservationFormData | null;
  selectedProducts: SelectedProduct[];
  currentStep: 'input' | 'confirm' | 'complete';
  isSubmitting: boolean;
  error: string | null;
  
  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  setFormData: (data: ReservationFormData) => void;
  addProduct: (product: SelectedProduct) => void;
  removeProduct: (productId: number) => void;
  updateProductQuantity: (productId: number, quantity: number) => void;
  setCurrentStep: (step: 'input' | 'confirm' | 'complete') => void;
  setSubmitting: (isSubmitting: boolean) => void;
  setError: (error: string | null) => void;
  resetForm: () => void;
  
  // è¨ˆç®—ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
  getTotalAmount: () => number;
  getProductCount: () => number;
  isFormValid: () => boolean;
}

export const useReservationStore = create<ReservationStore>((set, get) => ({
  // åˆæœŸçŠ¶æ…‹
  formData: null,
  selectedProducts: [],
  currentStep: 'input',
  isSubmitting: false,
  error: null,
  
  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…
  setFormData: (data) => set({ formData: data }),
  
  addProduct: (product) => set((state) => ({
    selectedProducts: [...state.selectedProducts, product]
  })),
  
  removeProduct: (productId) => set((state) => ({
    selectedProducts: state.selectedProducts.filter(p => p.product_id !== productId)
  })),
  
  updateProductQuantity: (productId, quantity) => set((state) => ({
    selectedProducts: state.selectedProducts.map(p =>
      p.product_id === productId
        ? { ...p, quantity, total_price: p.unit_price * quantity }
        : p
    )
  })),
  
  setCurrentStep: (step) => set({ currentStep: step }),
  setSubmitting: (isSubmitting) => set({ isSubmitting }),
  setError: (error) => set({ error }),
  
  resetForm: () => set({
    formData: null,
    selectedProducts: [],
    currentStep: 'input',
    isSubmitting: false,
    error: null
  }),
  
  // è¨ˆç®—ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
  getTotalAmount: () => {
    const { selectedProducts } = get();
    return selectedProducts.reduce((sum, product) => sum + product.total_price, 0);
  },
  
  getProductCount: () => {
    const { selectedProducts } = get();
    return selectedProducts.reduce((sum, product) => sum + product.quantity, 0);
  },
  
  isFormValid: () => {
    const { formData, selectedProducts } = get();
    return !!(formData && selectedProducts.length > 0);
  }
}));
```

### **4. ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯è¨­è¨ˆ**

#### **useFormConfig Hook**
```typescript
// src/hooks/useFormConfig.ts
interface UseFormConfigReturn {
  config: FormConfigResponse | null;
  loading: boolean;
  error: string | null;
  refetch: () => Promise<void>;
}

export const useFormConfig = (presetId: number): UseFormConfigReturn => {
  const [config, setConfig] = useState<FormConfigResponse | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  const fetchConfig = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      
      const response = await fetch(`/api/presets/${presetId}/config`);
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
      const result = await response.json();
      
      if (!result.success || !result.data) {
        throw new Error('ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
      setConfig(result.data);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setLoading(false);
    }
  }, [presetId]);
  
  useEffect(() => {
    if (presetId > 0) {
      fetchConfig();
    }
  }, [presetId, fetchConfig]);
  
  return {
    config,
    loading,
    error,
    refetch: fetchConfig
  };
};
```

#### **useReservationForm Hook**
```typescript
// src/hooks/useReservationForm.ts
interface UseReservationFormProps {
  formSettings?: FormSettings;
  defaultValues?: Partial<ReservationFormData>;
}

interface UseReservationFormReturn {
  methods: UseFormReturn<ReservationFormData>;
  selectedProducts: SelectedProduct[];
  addProduct: (product: SelectedProduct) => void;
  removeProduct: (productId: number) => void;
  updateQuantity: (productId: number, quantity: number) => void;
  getTotalAmount: () => number;
}

export const useReservationForm = ({
  formSettings,
  defaultValues = {}
}: UseReservationFormProps): UseReservationFormReturn => {
  
  // å‹•çš„ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ¼ãƒç”Ÿæˆ
  const validationSchema = useMemo(() => {
    if (!formSettings) return reservationFormSchema;
    return createConditionalSchema(formSettings);
  }, [formSettings]);
  
  // React Hook FormåˆæœŸåŒ–
  const methods = useForm<ReservationFormData>({
    resolver: zodResolver(validationSchema),
    defaultValues: {
      user_name: '',
      furigana: '',
      phone_number: '',
      products: [],
      pickup_dates: {},
      note: '',
      ...defaultValues
    },
    mode: 'onChange'
  });
  
  // å•†å“é¸æŠçŠ¶æ…‹ç®¡ç†
  const [selectedProducts, setSelectedProducts] = useState<SelectedProduct[]>([]);
  
  // å•†å“è¿½åŠ 
  const addProduct = useCallback((product: SelectedProduct) => {
    setSelectedProducts(prev => {
      const existing = prev.find(p => p.product_id === product.product_id);
      if (existing) {
        return prev.map(p =>
          p.product_id === product.product_id
            ? { ...p, quantity: p.quantity + product.quantity }
            : p
        );
      }
      return [...prev, product];
    });
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã® products ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚æ›´æ–°
    const currentProducts = methods.getValues('products');
    methods.setValue('products', [...currentProducts, product]);
  }, [methods]);
  
  // å•†å“å‰Šé™¤
  const removeProduct = useCallback((productId: number) => {
    setSelectedProducts(prev => prev.filter(p => p.product_id !== productId));
    
    const currentProducts = methods.getValues('products');
    methods.setValue('products', currentProducts.filter(p => p.product_id !== productId));
  }, [methods]);
  
  // æ•°é‡æ›´æ–°
  const updateQuantity = useCallback((productId: number, quantity: number) => {
    setSelectedProducts(prev => prev.map(p =>
      p.product_id === productId
        ? { ...p, quantity, total_price: p.unit_price * quantity }
        : p
    ));
    
    const currentProducts = methods.getValues('products');
    methods.setValue('products', currentProducts.map(p =>
      p.product_id === productId
        ? { ...p, quantity, total_price: p.unit_price * quantity }
        : p
    ));
  }, [methods]);
  
  // åˆè¨ˆé‡‘é¡è¨ˆç®—
  const getTotalAmount = useCallback(() => {
    return selectedProducts.reduce((sum, product) => sum + product.total_price, 0);
  }, [selectedProducts]);
  
  return {
    methods,
    selectedProducts,
    addProduct,
    removeProduct,
    updateQuantity,
    getTotalAmount
  };
};
```
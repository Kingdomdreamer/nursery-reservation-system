# 要件定義書

## 概要

この文書は、顧客がLINE連携フォームを通じて商品予約を行い、管理者が予約を確認できる簡素化された予約システムの実装要件を定義します。システムは1週間での迅速なリリースを目指し、必要最小限の機能を維持しながら複雑さを最小化することを優先します。

## 要件

### 要件1

**ユーザーストーリー:** 顧客として、事前定義された商品リストから商品を選択して予約したい。必要な商品を確保するため。

#### 受入基準

1. 顧客が予約フォームにアクセスした時、システムは利用可能なハードコーディングされた商品リストを表示する
2. 顧客が商品を選択した時、システムは1-10個の数量指定を許可する
3. 顧客が商品を選択に追加した時、システムは合計金額を自動計算する
4. 顧客が商品を選択せずに送信しようとした場合、システムはエラーメッセージを表示する
5. 顧客が商品選択を完了した時、システムは顧客情報フォームに進む

### 要件2

**ユーザーストーリー:** 顧客として、予約のために連絡先情報を提供したい。事業者が注文について連絡できるように。

#### 受入基準

1. 顧客が情報フォームに到達した時、システムは1-50文字のバリデーション付きで氏名入力を必須とする
2. 顧客が電話番号を入力した時、システムは10-15桁の数字とハイフンのみを含むことを検証する
3. 顧客情報が無効な場合、システムは各フィールドに対して具体的なエラーメッセージを表示する
4. 顧客情報が有効な時、システムは確認画面への進行を許可する
5. 顧客がフォームを送信した時、システムは予約をデータベースに保存する

### 要件3

**ユーザーストーリー:** 顧客として、確定前に予約詳細を確認したい。正確性を確保するため。

#### 受入基準

1. 顧客が確認画面に到達した時、システムは選択した全商品を数量と価格と共に表示する
2. 顧客が確認画面を見る時、システムは検証のために連絡先情報を表示する
3. 顧客が確認画面を見る時、システムは計算された合計金額を表示する
4. 顧客が予約を確定した時、システムは一意の予約番号を作成する
5. 予約が確定された時、システムは管理者にLINE通知を送信する

### 要件4

**ユーザーストーリー:** 管理者として、シンプルなダッシュボードで全ての顧客予約を確認したい。注文を効率的に管理するため。

#### 受入基準

1. 管理者が管理ダッシュボードにアクセスした時、システムはパスワード認証（admin123）を要求する
2. 管理者が認証された時、システムは最新50件の予約をテーブル形式で表示する
3. 予約を表示する時、システムは予約ID、顧客名、電話番号、合計金額、ステータス、作成日時を表示する
4. 予約がない場合、システムは「予約がありません」メッセージを表示する
5. 管理者がダッシュボードを見る時、システムはLIFF機能を初期化しない

### 要件5

**ユーザーストーリー:** 管理者として、ブラウザ上で商品を手動入力・管理したい。データベース連携なしでシンプルに商品を管理するため。

#### 受入基準

1. 管理者が商品管理画面にアクセスした時、システムはローカルストレージから商品データを読み込む
2. 初回アクセス時、システムはデフォルト商品（りんご100円、みかん120円、バナナ80円）を表示する
3. 管理者が新商品を追加する時、システムは商品名と価格の入力を必須とする
4. 管理者が商品を編集する時、システムはインライン編集機能を提供する
5. 管理者が商品の表示/非表示を切り替えた時、システムは予約フォームでの表示状態を変更する
6. 商品データが変更された時、システムはローカルストレージに自動保存する
7. 予約フォームが商品を取得する時、システムは表示可能な商品のみを返す

### 要件6

**ユーザーストーリー:** 開発者として、既存の複雑な機能を削除ではなく無効化したい。将来のリリースで簡単に復元できるように。

#### 受入基準

1. ProductsContainer.tsxの複雑な商品管理機能を使用する時、システムはコメントアウトで無効化する
2. CSV インポート機能が呼び出された時、システムは404またはNot Implementedレスポンスを返す
3. 複雑なバリデーションスキーマを使用する箇所で、システムは簡素化されたスキーマに置き換える
4. 機能を無効化する時、システムは元のコードを/* */コメントで保持する
5. 無効化されたAPIエンドポイントがアクセスされた時、システムは「将来のバージョンで提供予定」メッセージを返す
6. totalItemsエラーを修正する時、システムは安全なpaginationアクセスパターンを使用する

### 要件7

**ユーザーストーリー:** システムとして、異なるコンテキストでLINE統合を適切に処理したい。管理ページがLIFFの干渉なしに動作するように。

#### 受入基準

1. LiffProvider.tsxのuseEffect内で、システムは`window.location.pathname.startsWith('/admin')`で管理ページを検出する
2. 管理ページが検出された時、システムはLIFF初期化をスキップしsetIsReady(true)を実行する
3. 非管理ページ（予約フォーム）では、システムは既存のLIFF初期化ロジックを実行する
4. LIFF初期化が失敗した場合、システムはconsole.errorでログ出力しつつsetIsReady(true)でページ表示を継続する
5. LINE通知送信時、システムは既存のline-messaging.ts設定とテスト用トークンを使用する
6. 管理画面でのLIFFエラーが解消された時、システムは正常に管理機能を表示する

### 要件8

**ユーザーストーリー:** システムとして、適切なエラーハンドリングで信頼性の高いAPIレスポンスを提供したい。ユーザーエクスペリエンスをスムーズに保つため。

#### 受入基準

1. 任意のAPIが呼び出された時、システムは成功ステータス、データ/エラー、タイムスタンプを含むレスポンスを返す
2. データベース操作が失敗した時、システムは適切なHTTPステータスコードとエラーメッセージを返す
3. バリデーションが失敗した時、システムは具体的なフィールドレベルのエラーメッセージを返す
4. APIレスポンスが成功した時、システムは一貫した形式で関連データを含める
5. エラーが発生した時、システムはユーザーフレンドリーなメッセージを表示しながらデバッグ用の詳細情報をログに記録する

### 要件9

**ユーザーストーリー:** 開発者として、緊急修正項目を最優先で対応したい。システムの基本動作を確保するため。

#### 受入基準

1. ProductsContainer.tsxのtotalItemsエラーを修正する時、システムは安全なpagination.totalItemsアクセスを実装する
2. data.paginationが存在しない場合、システムはフォールバック値でpaginationオブジェクトを作成する
3. LiffProvider.tsxでisAdminPageチェックを追加する時、システムは管理画面でのLIFF初期化を完全にスキップする
4. 緊急修正が完了した時、システムは管理画面と予約フォームの両方で正常動作する
5. エラーログが出力されなくなった時、システムは安定した状態で動作する

### 要件10

**ユーザーストーリー:** 管理者として、SimpleProductManagerで商品を直感的に管理したい。技術知識なしで商品データを操作するため。

#### 受入基準

1. SimpleProductManager画面で、管理者は商品名と価格を入力して「追加」ボタンで新商品を作成できる
2. 商品一覧で「編集」ボタンをクリックした時、システムはインライン編集モードに切り替える
3. 商品の「表示/非表示」ボタンをクリックした時、システムは即座に状態を切り替えて保存する
4. 商品を削除する時、システムは確認ダイアログを表示してから削除を実行する
5. 全ての変更が即座にローカルストレージに保存され、ページリロード後も保持される
6. 使用方法の説明が画面下部に表示され、管理者が操作方法を理解できる

### 要件11

**ユーザーストーリー:** システムとして、予約フォームで管理者が設定した商品を表示したい。ローカルストレージとAPIの連携を実現するため。

#### 受入基準

1. `/api/simple-products`エンドポイントが作成され、デフォルト商品データを返す
2. 予約フォームが商品データを取得する時、システムは簡易商品APIを使用する
3. useFormConfig.tsで既存の複雑なAPI呼び出しをコメントアウトし、固定設定を使用する
4. 商品データとフォーム設定が正常に統合され、予約フォームで商品選択が可能になる
5. 管理画面で設定した商品が予約フォームに反映される（将来の拡張ポイント）